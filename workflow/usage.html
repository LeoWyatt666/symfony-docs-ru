<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Как использовать рабочий поток &mdash; Symfony Framework Documentation  documentation</title>
    
    <link rel="stylesheet" href="../_static/" type="text/css">
    <link rel="stylesheet" href="..\_static\pygments.css" type="text/css">
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <link rel="top" title="Symfony Framework Documentation  documentation" href="..\index.html">
    <link rel="up" title="The Workflow Component" href="..\components\workflow.html">
    <link rel="next" title="The Yaml Component" href="..\components\yaml.html">
    <link rel="prev" title="Рабочие потоки как конечные автоматы" href="state-machines-ru.html">

<link rel="stylesheet" href="..\_assets\app.css?v=8d6d457a0820d7c245bddae16bfd4c75">
<script src="..\_assets\manifest.js?v=d41d8cd98f00b204e980"></script>
<script src="..\_assets\app.js?v=900984040c7cb4dca514"></script>
<style>
    .header__top .container {
        overflow: hidden;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .header__top .header__logo {
        float: left;
    }
    .header__top .header__support {
        float: right;
    }

    .highlight .k, .highlight .gh, .highlight .gp,
    .highlight .gu, .highlight .kc, .highlight .kd,
    .highlight .kn, .highlight .kr, .highlight .nc,
    .highlight .nd, .highlight .ni, .highlight .nl,
    .highlight .nn, .highlight .nt, .highlight .ow,
    .highlight .se { font-weight: normal; }

    .highlight .c, .highlight .cm, .highlight .c1,
    .highlight .sd, .highlight .si { font-style: normal; }

    .doc { background: none; }
    #demo-warning {
        border: 3px dashed #c00;
        padding: 10px;
        margin-bottom: 30px;
    }
    #demo-warning h4 { font-size: 1.7em;font-weight: bold; }
    #demo-warning p { margin-bottom: 0; }
</style>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-107764519-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-107764519-1');
</script>

<!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '250281335689441');
    fbq('track', 'PageView');
</script>
<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=250281335689441&ev=PageView&noscript=1">
<!-- End Facebook Pixel Code -->

<script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://vk.com/js/api/openapi.js?159",t.onload=function(){VK.Retargeting.Init("VK-RTRG-279161-8p6Jv"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><img src="https://vk.com/rtrg?p=VK-RTRG-279161-8p6Jv" style="position:fixed; left:-999px;" alt="">


  </head>
  <body role="document">

<body class="workflow doc_article doc">

<header>
    <section class="header__top">
        <div class="container">
            <div class="header__logo">
                <a href="..\..\..\index.html">
                    <img src="..\..\..\_images\header-logo.svg" alt="Symfony.com.ua logo">
                </a>
            </div>
            <div class="header__support hidden-xs">
                <a href="http://playtini.ua/" title="Компания Playtini">
                    <img height="69" src="..\..\..\_images\support.png" alt="Symfony is a SensioLabs product">
                </a>
            </div>
        </div>
    </section>
</header>

<div class="container"><div id="page-content">
    <div class="row">
        <div id="sidebar" class="col-sm-3">
            <div id="sidebar-content"><div class="submenu">
    
    
    <ul class="list_submenu list-unstyled">
    
        <li class="first">
            <a href="..\index.html">Главная</a>
        </li>
    
        <li>
            <a href="..\components\index.html">Компоненты</a>
        </li>
    
        <li>
            <a href="..\best_practices\index.html">Лучшие практики</a>
        </li>
    
        <li>
            <a href="..\quick_tour\index.html">Быстрый старт</a>
        </li>
    
        <li>
            <a href="..\reference\index.html">Справочник</a>
        </li>
    
        <li>
            <a href="..\genindex.html">Индекс</a>
        </li>
    
        <li>
            <a href="..\contributing\index.html">Участие</a>
        </li>
    
    </ul>
</div>

                <div class="toc"> 
    <h4>Содержание</h4>
    <div class="toc-content">
        <ul>
<li><a class="reference internal" href="#">Как использовать рабочий поток</a><ul>
<li><a class="reference internal" href="#id2">Использование событий</a><ul>
<li><a class="reference internal" href="#id3">Защитные события</a></li>
<li><a class="reference internal" href="#id4">Методы событий</a></li>
</ul>
</li>
<li><a class="reference internal" href="#twig">Использование в Twig</a></li>
</ul>
</li>
</ul>

    </div>
</div>
                
            </div>

            <div class="ads m-b-30">
                <h2>Вакансии Playtini</h2>
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/php-dev">
                            Middle+ PHP Developer/Symfony
                        </a>
                    </h3>
                    <div><b>Playtini</b> активно поддерживает и развивает свои продукты, и профессионализм команды. И на данный момент в поиске специалиста на позицию <b>«Middle+ PHP Developer/Symfony»,</b> который улучшит качество внутренних сервисов компании и увеличит их количество.</div>
                </div>
                <!--
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/symfony-senior">
                            Senior PHP Developer/Symfony
                        </a>
                    </h3>
                    <div>We are looking for strong, experienced <b>Senior PHP Developer/Symfony.</b> We expect him/her to participate in improving and extending a system built using microservice architecture by means of modern technologies.</div>
                </div>
                -->
                <div class="ad">
                    <h3><a href="http://playtini.ua/careers">
                        Остальные вакансии компании
                        <img src="..\..\..\_images\logo-playtini.png" alt="Playtini">
                    </a></h3>
                </div>
            </div>
        </div>

        <div id="main" class="col-sm-9">
            <ol class="breadcrumb">
                
                <li><a href="..\index.html">Документация</a></li>
                
                <li><a href="..\components\index.html">The Components</a></li>
                
                <li><a href="../components/index-ru.html">The Components</a></li>
                
                <li><a href="..\components\workflow.html">The Workflow Component</a></li>
                
                <li class="active">Как использовать рабочий поток</li>
            </ol>

            <div class="page">
                
  <div class="section" id="index-0">
<span id="id1"></span><h1>Как использовать рабочий поток<a class="headerlink" href="#index-0" title="Permalink to this headline">¶</a></h1>
<p>Рабочий поток - это процесс жизненного цикла, через который проходят ваши объекты.
Каждый шаг или этап процесса называется <em>местом</em>. Вы также определяете <em>переходы</em>,
которые описывают действие перехода из одного места в другое.</p>
<img alt="../_images/states_transitions.png" src="..\_images\states_transitions.png">
<p>Набор мест и переходов создаёт <strong>определение</strong>. Рабочему потоку необходимо <tt class="docutils literal"><code>Definition</code></tt>
(определение) и способ написать состояния объектов (например, сущность класса
<tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/MarkingStore/MarkingStoreInterface.html" title="Symfony\Component\Workflow\MarkingStore\MarkingStoreInterface">MarkingStoreInterface</a></code></tt>.)</p>
<p>Рассмотрите следующий пример для записи блога. Запись может иметь такие места:
&quot;черновик&quot;, &quot;обзор&quot;, &quot;отвергнутый&quot;, &quot;опубликованный&quot;. Вы можете определить рабочий
поток следующим образом:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">framework</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">workflows</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">blog_publishing</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="s">&#39;workflow&#39;</span> <span class="c1"># or &#39;state_machine&#39;</span>
            <span class="l l-Scalar l-Scalar-Plain">marking_store</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="s">&#39;multiple_state&#39;</span> <span class="c1"># or &#39;single_state&#39;</span>
                <span class="l l-Scalar l-Scalar-Plain">arguments</span><span class="p p-Indicator">:</span>
                    <span class="p p-Indicator">-</span> <span class="s">&#39;currentPlace&#39;</span>
            <span class="l l-Scalar l-Scalar-Plain">supports</span><span class="p p-Indicator">:</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">AppBundle\Entity\BlogPost</span>
            <span class="l l-Scalar l-Scalar-Plain">places</span><span class="p p-Indicator">:</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">draft</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">review</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">rejected</span>
                <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">published</span>
            <span class="l l-Scalar l-Scalar-Plain">transitions</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">to_review</span><span class="p p-Indicator">:</span>
                    <span class="l l-Scalar l-Scalar-Plain">from</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">draft</span>
                    <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>   <span class="l l-Scalar l-Scalar-Plain">review</span>
                <span class="l l-Scalar l-Scalar-Plain">publish</span><span class="p p-Indicator">:</span>
                    <span class="l l-Scalar l-Scalar-Plain">from</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">review</span>
                    <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>   <span class="l l-Scalar l-Scalar-Plain">published</span>
                <span class="l l-Scalar l-Scalar-Plain">reject</span><span class="p p-Indicator">:</span>
                    <span class="l l-Scalar l-Scalar-Plain">from</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">review</span>
                    <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>   <span class="l l-Scalar l-Scalar-Plain">rejected</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- app/config/config.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span>
<span class="nt">&lt;container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:framework=</span><span class="s">&quot;http://symfony.com/schema/dic/symfony&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd</span>
<span class="s">        http://symfony.com/schema/dic/symfony http://symfony.com/schema/dic/symfony/symfony-1.0.xsd&quot;</span>
<span class="nt">&gt;</span>

    <span class="nt">&lt;framework:config&gt;</span>
        <span class="nt">&lt;framework:workflow</span> <span class="na">name=</span><span class="s">&quot;blog_publishing&quot;</span> <span class="na">type=</span><span class="s">&quot;workflow&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;framework:marking-store</span> <span class="na">type=</span><span class="s">&quot;single_state&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;framework:arguments&gt;</span>currentPlace<span class="nt">&lt;/framework:arguments&gt;</span>
            <span class="nt">&lt;/framework:marking-store&gt;</span>

            <span class="nt">&lt;framework:support&gt;</span>AppBundle\Entity\BlogPost<span class="nt">&lt;/framework:support&gt;</span>

            <span class="nt">&lt;framework:place&gt;</span>draft<span class="nt">&lt;/framework:place&gt;</span>
            <span class="nt">&lt;framework:place&gt;</span>review<span class="nt">&lt;/framework:place&gt;</span>
            <span class="nt">&lt;framework:place&gt;</span>rejected<span class="nt">&lt;/framework:place&gt;</span>
            <span class="nt">&lt;framework:place&gt;</span>published<span class="nt">&lt;/framework:place&gt;</span>

            <span class="nt">&lt;framework:transition</span> <span class="na">name=</span><span class="s">&quot;to_review&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;framework:from&gt;</span>draft<span class="nt">&lt;/framework:from&gt;</span>

                <span class="nt">&lt;framework:to&gt;</span>review<span class="nt">&lt;/framework:to&gt;</span>
            <span class="nt">&lt;/framework:transition&gt;</span>

            <span class="nt">&lt;framework:transition</span> <span class="na">name=</span><span class="s">&quot;publish&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;framework:from&gt;</span>review<span class="nt">&lt;/framework:from&gt;</span>

                <span class="nt">&lt;framework:to&gt;</span>published<span class="nt">&lt;/framework:to&gt;</span>
            <span class="nt">&lt;/framework:transition&gt;</span>

            <span class="nt">&lt;framework:transition</span> <span class="na">name=</span><span class="s">&quot;reject&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;framework:from&gt;</span>review<span class="nt">&lt;/framework:from&gt;</span>

                <span class="nt">&lt;framework:to&gt;</span>rejected<span class="nt">&lt;/framework:to&gt;</span>
            <span class="nt">&lt;/framework:transition&gt;</span>

        <span class="nt">&lt;/framework:workflow&gt;</span>

    <span class="nt">&lt;/framework:config&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// app/config/config.php</span>

        <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;framework&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="c1">// ...</span>
            <span class="s1">&#39;workflows&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;blog_publishing&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                  <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;workflow&#39;</span><span class="p">,</span> <span class="c1">// or &#39;state_machine&#39;</span>
                  <span class="s1">&#39;marking_store&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;multiple_state&#39;</span><span class="p">,</span> <span class="c1">// or &#39;single_state&#39;</span>
                    <span class="s1">&#39;arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;currentPlace&#39;</span><span class="p">)</span>
                  <span class="p">),</span>
                  <span class="s1">&#39;supports&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;AppBundle\Entity\BlogPost&#39;</span><span class="p">),</span>
                  <span class="s1">&#39;places&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;draft&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;review&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;rejected&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;published&#39;</span><span class="p">,</span>
                  <span class="p">),</span>
                  <span class="s1">&#39;transitions&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                    <span class="s1">&#39;to_review&#39;</span><span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                      <span class="s1">&#39;from&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;draft&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;to&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;review&#39;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s1">&#39;publish&#39;</span><span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                      <span class="s1">&#39;from&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;review&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;to&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;published&#39;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s1">&#39;reject&#39;</span><span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                      <span class="s1">&#39;from&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;review&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;to&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;rejected&#39;</span><span class="p">,</span>
                    <span class="p">),</span>
                  <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BlogPost</span>
<span class="p">{</span>
    <span class="c1">// Это свойство используется хранилищем маркировки</span>
    <span class="k">public</span> <span class="nv">$currentPlace</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$title</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$content</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">Тип хранилища маркировки может быть множественным и единственным состоянием
(&quot;multiple_state&quot; или &quot;single_state&quot;). Единственное состояние не поддерживает
модель, которая нахолится в нескольких местах одновременно.</p>
</div></div>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p class="last">Атрибуты <tt class="docutils literal"><code>type</code></tt> (значение по умолчанию <tt class="docutils literal"><code>single_state</code></tt>) и <tt class="docutils literal"><code>arguments</code></tt> (значение
по умолчанию <tt class="docutils literal"><code>marking</code></tt>) опции <tt class="docutils literal"><code>marking_store</code></tt> необязательны. Если их опустить,
будут использованы их значения по умолчанию.</p>
</div></div>
<p>С этим рабочим потоком, названным <tt class="docutils literal"><code>blog_publishing</code></tt>, вы можете получить помощь в решении
того, какие действия разрешены в записи блога:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nv">$post</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\AppBundle\Entity\BlogPost</span><span class="p">();</span>

<span class="nv">$workflow</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;workflow.blog_publishing&#39;</span><span class="p">);</span>
<span class="nv">$workflow</span><span class="o">-&gt;</span><span class="na">can</span><span class="p">(</span><span class="nv">$post</span><span class="p">,</span> <span class="s1">&#39;publish&#39;</span><span class="p">);</span> <span class="c1">// False</span>
<span class="nv">$workflow</span><span class="o">-&gt;</span><span class="na">can</span><span class="p">(</span><span class="nv">$post</span><span class="p">,</span> <span class="s1">&#39;to_review&#39;</span><span class="p">);</span> <span class="c1">// True</span>

<span class="c1">// Update the currentState on the post</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="nv">$workflow</span><span class="o">-&gt;</span><span class="na">apply</span><span class="p">(</span><span class="nv">$post</span><span class="p">,</span> <span class="s1">&#39;to_review&#39;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">LogicException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="c1">// Смотрите все доступные переходы для записи в текущем состоянии</span>
<span class="nv">$transitions</span> <span class="o">=</span> <span class="nv">$workflow</span><span class="o">-&gt;</span><span class="na">getEnabledTransitions</span><span class="p">(</span><span class="nv">$post</span><span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="id2">
<h2>Использование событий<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Чтобы сделать ваши рабочие потоки еще более мощными, вы можете построить объект
<tt class="docutils literal"><code>Workflow</code></tt> с <tt class="docutils literal"><code>EventDispatcher</code></tt>. Теперь вы можете создавать слушателей событий
для блокировки переходов (т.е. в зависимости от данных в записи блога). Развёртываются
следующие события:</p>
<ul class="simple">
<li><tt class="docutils literal"><code>workflow.leave</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].leave</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].leave.[place name]</code></tt></li>
<li><tt class="docutils literal"><code>workflow.transition</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].transition</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].transition.[transition name]</code></tt></li>
<li><tt class="docutils literal"><code>workflow.enter</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].enter</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].enter.[place name]</code></tt></li>
<li><tt class="docutils literal"><code>workflow.entered</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].entered</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].entered.[place name]</code></tt></li>
<li><tt class="docutils literal"><code>workflow.announce</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].announce</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].announce.[transition name]</code></tt></li>
</ul>
<p>Вот пример того, как включать логирование каждый раз, когда рабочий поток &quot;blog_publishing&quot; покидает
место:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Log\LoggerInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\EventDispatcher\EventSubscriberInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Workflow\Event\Event</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">WorkflowLogger</span> <span class="k">implements</span> <span class="nx">EventSubscriberInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">LoggerInterface</span> <span class="nv">$logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">onLeave</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">alert</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span>
            <span class="s1">&#39;Blog post (id: &quot;%s&quot;) performed transaction &quot;%s&quot; from &quot;%s&quot; to &quot;%s&quot;&#39;</span><span class="p">,</span>
            <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getSubject</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">(),</span>
            <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getTransition</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span>
            <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getMarking</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getPlaces</span><span class="p">())),</span>
            <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getTransition</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getTos</span><span class="p">())</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getSubscribedEvents</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;workflow.blog_publishing.leave&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;onLeave&#39;</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="id3">
<h3>Защитные события<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Существует особенный тип событий, под названием &quot;защитные собтия&quot;. Их слушатели
событий вызываются каждый раз, когда выполняется вызов <tt class="docutils literal"><code>Workflow::can</code></tt>, <tt class="docutils literal"><code>Workflow::apply</code></tt>
или <tt class="docutils literal"><code>Workflow::getEnabledTransitions</code></tt>. С защитными собтиями вы можете добавлять пользовательскую
логику для того, чтобы решить, какие переходы валидны, а какие - нет. Вот список имён
защитных событий.</p>
<ul class="simple">
<li><tt class="docutils literal"><code>workflow.guard</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].guard</code></tt></li>
<li><tt class="docutils literal"><code>workflow.[workflow name].guard.[transition name]</code></tt></li>
</ul>
<p>Смотрите пример, чтобы убедиться, что ни одна запись блога без заголовка не будет
перенесена в состояние &quot;обзора&quot;:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Symfony\Component\Workflow\Event\GuardEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\EventDispatcher\EventSubscriberInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BlogPostReviewListener</span> <span class="k">implements</span> <span class="nx">EventSubscriberInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">guardReview</span><span class="p">(</span><span class="nx">GuardEvent</span> <span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="sd">/** @var \AppBundle\Entity\BlogPost $post */</span>
        <span class="nv">$post</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getSubject</span><span class="p">();</span>
        <span class="nv">$title</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$title</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Записи без заголовок не должны быть допущены</span>
            <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">setBlocked</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getSubscribedEvents</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;workflow.blogpost.guard.to_review&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;guardReview&#39;</span><span class="p">),</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="id4">
<h3>Методы событий<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Каждое событие рабочего потока - это экземпляр <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/Event/Event.html" title="Symfony\Component\Workflow\Event\Event">Event</a></code></tt>.
Это означает, что каждое событие имеет доступ к следующей информации:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/Event/Event.html#method_getMarking" title="Symfony\Component\Workflow\Event\Event::getMarking()">getMarking()</a></code></tt></dt>
<dd>Возвращает <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/Marking.html" title="Symfony\Component\Workflow\Marking">Marking</a></code></tt> рабочего потока.</dd>
<dt><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Worflow/Event/Event.html#method_getSubject" title="Symfony\Component\Worflow\Event\Event::getSubject()">getSubject()</a></code></tt></dt>
<dd>Возвращает объект, который развёртывает событие.</dd>
<dt><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/Event/Event.html#method_getTransition" title="Symfony\Component\Workflow\Event\Event::getTransition()">getTransition()</a></code></tt></dt>
<dd>Возвращает <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/Transition.html" title="Symfony\Component\Workflow\Transition">Transition</a></code></tt>, который развёртывает событие.</dd>
<dt><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/Event/Event.html#method_getWorkflowName" title="Symfony\Component\Workflow\Event\Event::getWorkflowName()">getWorkflowName()</a></code></tt></dt>
<dd><p class="first">Возвращает строку с именем рабочего потока, который вызвал событие.</p>
<div class="last versionadded">
<p><span class="versionmodified">New in version 3.3: </span>Метод <tt class="docutils literal"><code>getWorkflowName()</code></tt> был представлен в Symfony 3.3.</p>
</div>
</dd>
</dl>
<p>For Guard Events, there is an extended class <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/Event/GuardEvent.html" title="Symfony\Component\Workflow\Event\GuardEvent">GuardEvent</a></code></tt>.
This class has two more methods:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/Event/GuardEvent.html#method_isBlocked" title="Symfony\Component\Workflow\Event\GuardEvent::isBlocked()">isBlocked()</a></code></tt></dt>
<dd>Возвращается, если переход заблокирован.</dd>
<dt><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Workflow/Event/GuardEvent.html#method_setBlocked" title="Symfony\Component\Workflow\Event\GuardEvent::setBlocked()">setBlocked()</a></code></tt></dt>
<dd>Устанавливает заблокированное значение.</dd>
</dl>
</div>
</div>
<div class="section" id="twig">
<h2>Использование в Twig<a class="headerlink" href="#twig" title="Permalink to this headline">¶</a></h2>
<p>Symfony определяет несколько функций Twig для управления рабочими потоками и уменьшения
необходимости логики домена в ваших шаблонах:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><code>workflow_can()</code></tt></dt>
<dd>Возвращает <tt class="docutils literal"><code>true</code></tt>, если данный объект может выполнить данный переход.</dd>
<dt><tt class="docutils literal"><code>workflow_transitions()</code></tt></dt>
<dd>Возвращает массив со всеми переходами, включенными в данном объекте.</dd>
<dt><tt class="docutils literal"><code>workflow_marked_places()</code></tt></dt>
<dd>Возвращает массив с именами мест данной маркировки.</dd>
<dt><tt class="docutils literal"><code>workflow_has_marked_place()</code></tt></dt>
<dd>Возвращает <tt class="docutils literal"><code>true</code></tt>, если маркировка данного объекта имеет данное состояние.</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified">New in version 3.3: </span>Функции <tt class="docutils literal"><code>workflow_marked_places()</code></tt> и <tt class="docutils literal"><code>workflow_has_marked_place()</code></tt>
были представлены в Symfony 3.3.</p>
</div>
<p>Следующий пример иллюстрирует эти функции в действии:</p>
<div class="literal-block"><div class="highlight-twig"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="x">&lt;h3&gt;Actions&lt;/h3&gt;</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">workflow_can</span><span class="o">(</span><span class="nv">post</span><span class="o">,</span> <span class="s1">&#39;publish&#39;</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;a href=&quot;...&quot;&gt;Publish article&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">workflow_can</span><span class="o">(</span><span class="nv">post</span><span class="o">,</span> <span class="s1">&#39;to_review&#39;</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;a href=&quot;...&quot;&gt;Submit to review&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">workflow_can</span><span class="o">(</span><span class="nv">post</span><span class="o">,</span> <span class="s1">&#39;reject&#39;</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;a href=&quot;...&quot;&gt;Reject article&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="c">{# Или закольцевать через включенные переходы #}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">transition</span> <span class="k">in</span> <span class="nv">workflow_transitions</span><span class="o">(</span><span class="nv">post</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;a href=&quot;...&quot;&gt;</span><span class="cp">{{</span> <span class="nv">transition.name</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    No actions available.</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>

<span class="c">{# Проверить, находится ли объект в некотором особенном месте #}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">workflow_has_marked_place</span><span class="o">(</span><span class="nv">post</span><span class="o">,</span> <span class="s1">&#39;to_review&#39;</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;p&gt;This post is ready for review.&lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>

<span class="c">{# Проверить, если некоторое место было маркировано в объекте #}</span><span class="x"></span>
<span class="cp">{%</span> <span class="k">if</span> <span class="s1">&#39;waiting_some_approval&#39;</span> <span class="k">in</span> <span class="nv">workflow_marked_places</span><span class="o">(</span><span class="nv">post</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">    &lt;span class=&quot;label&quot;&gt;PENDING&lt;/span&gt;</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
</div>
</div>


            </div>

            
            <div class="navigation">
                <a href="state-machines-ru.html">« Рабочие потоки как конечные автоматы</a>
                <span class="separator">|</span>
                <a href="..\components\yaml.html">The Yaml Component »</a>
            </div>
            

            <div id="license">
                <p>Эта документация является переводом <a href="http://symfony.com/doc/current/index.html">официальной документации Symfony</a> и предоставляется по свободной лицензии <a rel="license nofollow" href="https://creativecommons.org/licenses/by-sa/3.0/deed.ru">CC BY-SA 3.0</a>.</p>
            </div>
        </div>
    </div>
</div></div>


  </body>
</body></html>