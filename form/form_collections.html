<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Как встроить коллекцию форм &mdash; Symfony Framework Documentation  documentation</title>
    
    <link rel="stylesheet" href="../_static/" type="text/css">
    <link rel="stylesheet" href="..\_static\pygments.css" type="text/css">
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <link rel="top" title="Symfony Framework Documentation  documentation" href="..\index.html">
    <link rel="up" title="Forms" href="..\forms.html">
    <link rel="next" title="How to Customize Form Rendering" href="form_customization.html">
    <link rel="prev" title="How to Embed a Collection of Forms" href="form_collections.html">

<link rel="stylesheet" href="..\_assets\app.css?v=8d6d457a0820d7c245bddae16bfd4c75">
<script src="..\_assets\manifest.js?v=d41d8cd98f00b204e980"></script>
<script src="..\_assets\app.js?v=900984040c7cb4dca514"></script>
<style>
    .header__top .container {
        overflow: hidden;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .header__top .header__logo {
        float: left;
    }
    .header__top .header__support {
        float: right;
    }

    .highlight .k, .highlight .gh, .highlight .gp,
    .highlight .gu, .highlight .kc, .highlight .kd,
    .highlight .kn, .highlight .kr, .highlight .nc,
    .highlight .nd, .highlight .ni, .highlight .nl,
    .highlight .nn, .highlight .nt, .highlight .ow,
    .highlight .se { font-weight: normal; }

    .highlight .c, .highlight .cm, .highlight .c1,
    .highlight .sd, .highlight .si { font-style: normal; }

    .doc { background: none; }
    #demo-warning {
        border: 3px dashed #c00;
        padding: 10px;
        margin-bottom: 30px;
    }
    #demo-warning h4 { font-size: 1.7em;font-weight: bold; }
    #demo-warning p { margin-bottom: 0; }
</style>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-107764519-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-107764519-1');
</script>

<!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '250281335689441');
    fbq('track', 'PageView');
</script>
<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=250281335689441&ev=PageView&noscript=1">
<!-- End Facebook Pixel Code -->

<script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://vk.com/js/api/openapi.js?159",t.onload=function(){VK.Retargeting.Init("VK-RTRG-279161-8p6Jv"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><img src="https://vk.com/rtrg?p=VK-RTRG-279161-8p6Jv" style="position:fixed; left:-999px;" alt="">


  </head>
  <body role="document">

<body class="form doc_article doc">

<header>
    <section class="header__top">
        <div class="container">
            <div class="header__logo">
                <a href="..\..\..\index.html">
                    <img src="..\..\..\_images\header-logo.svg" alt="Symfony.com.ua logo">
                </a>
            </div>
            <div class="header__support hidden-xs">
                <a href="http://playtini.ua/" title="Компания Playtini">
                    <img height="69" src="..\..\..\_images\support.png" alt="Symfony is a SensioLabs product">
                </a>
            </div>
        </div>
    </section>
</header>

<div class="container"><div id="page-content">
    <div class="row">
        <div id="sidebar" class="col-sm-3">
            <div id="sidebar-content"><div class="submenu">
    
    
    <ul class="list_submenu list-unstyled">
    
        <li class="first">
            <a href="..\index.html">Главная</a>
        </li>
    
        <li>
            <a href="..\components\index.html">Компоненты</a>
        </li>
    
        <li>
            <a href="..\best_practices\index.html">Лучшие практики</a>
        </li>
    
        <li>
            <a href="..\quick_tour\index.html">Быстрый старт</a>
        </li>
    
        <li>
            <a href="..\reference\index.html">Справочник</a>
        </li>
    
        <li>
            <a href="..\genindex.html">Индекс</a>
        </li>
    
        <li>
            <a href="..\contributing\index.html">Участие</a>
        </li>
    
    </ul>
</div>

                <div class="toc"> 
    <h4>Содержание</h4>
    <div class="toc-content">
        <ul>
<li><a class="reference internal" href="#">Как встроить коллекцию форм</a><ul>
<li><a class="reference internal" href="#form-collections-new-prototype-ru">Разрешение &quot;новых&quot; тегов с помощью &quot;прототипа&quot;</a></li>
<li><a class="reference internal" href="#form-collections-remove-ru">Разрешение удаления тегов</a><ul>
<li><a class="reference internal" href="#id4">Изменения шаблонов</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
</div>
                
            </div>

            <div class="ads m-b-30">
                <h2>Вакансии Playtini</h2>
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/php-dev">
                            Middle+ PHP Developer/Symfony
                        </a>
                    </h3>
                    <div><b>Playtini</b> активно поддерживает и развивает свои продукты, и профессионализм команды. И на данный момент в поиске специалиста на позицию <b>«Middle+ PHP Developer/Symfony»,</b> который улучшит качество внутренних сервисов компании и увеличит их количество.</div>
                </div>
                <!--
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/symfony-senior">
                            Senior PHP Developer/Symfony
                        </a>
                    </h3>
                    <div>We are looking for strong, experienced <b>Senior PHP Developer/Symfony.</b> We expect him/her to participate in improving and extending a system built using microservice architecture by means of modern technologies.</div>
                </div>
                -->
                <div class="ad">
                    <h3><a href="http://playtini.ua/careers">
                        Остальные вакансии компании
                        <img src="..\..\..\_images\logo-playtini.png" alt="Playtini">
                    </a></h3>
                </div>
            </div>
        </div>

        <div id="main" class="col-sm-9">
            <ol class="breadcrumb">
                
                <li><a href="..\index.html">Документация</a></li>
                
                <li><a href="..\forms.html">Forms</a></li>
                
                <li class="active">Как встроить коллекцию форм</li>
            </ol>

            <div class="page">
                
  <div class="section" id="index-0">
<span id="id1"></span><h1>Как встроить коллекцию форм<a class="headerlink" href="#index-0" title="Permalink to this headline">¶</a></h1>
<p>В этой статье вы узнаете, как создавать форму, в которую встроена коллекция
многих других форм. Это может быть полезно, к примеру, если у вас был класс
<tt class="docutils literal"><code>Task</code></tt> и вы хотели редактировать/создать/удалить много объектов <tt class="docutils literal"><code>Tag</code></tt>,
относящихся к этому классу, прямо внутри той же формы.</p>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p>В этой статье предполагается, что в качестве хранилища БД вы используете
Doctrine. Но если вы не используете Doctrine (а используете, например,
Propel или просто коллекцию БД), то всё очень похоже. Есть только несколько
частей этого туториала, которые действительно заботятся о &quot;персистенции&quot;.</p>
<p class="last">Если вы <em>используете</em> Doctrine, то вам нужно будет добавить метаданные
Doctrine, включая ассоциацию <tt class="docutils literal"><code>ManyToMany</code></tt>, связывающую определение со
свойством <tt class="docutils literal"><code>tags</code></tt>.</p>
</div></div>
<p>Для начала, представьте, что каждый <tt class="docutils literal"><code>Task</code></tt> принадлежит нескольким объектам <tt class="docutils literal"><code>Tag</code></tt>. Начните
с создания простого класса <tt class="docutils literal"><code>Task</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Task.php</span>
<span class="k">namespace</span> <span class="nx">App\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\Common\Collections\ArrayCollection</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Task</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$description</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$tags</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getDescription</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDescription</span><span class="p">(</span><span class="nv">$description</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="nv">$description</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTags</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><code>ArrayCollection</code></tt> относится именно к Doctrine, и фактически это то же
самое, что использовать <tt class="docutils literal"><code>array</code></tt> (но это должно быть <tt class="docutils literal"><code>ArrayCollection</code></tt>,
если вы используете Doctrine).</p>
</div></div>
<p>Теперь, создайте класс <tt class="docutils literal"><code>Tag</code></tt>. Как вы видели выше, <tt class="docutils literal"><code>Task</code></tt> может иметь много
объектов <tt class="docutils literal"><code>Tag</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Tag.php</span>
<span class="k">namespace</span> <span class="nx">App\Entity</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Tag</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setName</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Далее, создайте класс формы так, чтобы объект <tt class="docutils literal"><code>Tag</code></tt> мог быть изменён пользователем:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Form/Type/TagType.php</span>
<span class="k">namespace</span> <span class="nx">App\Form\Type</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Tag</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\AbstractType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\FormBuilderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\OptionsResolver\OptionsResolver</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">TagType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilderInterface</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">configureOptions</span><span class="p">(</span><span class="nx">OptionsResolver</span> <span class="nv">$resolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$resolver</span><span class="o">-&gt;</span><span class="na">setDefaults</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;data_class&#39;</span> <span class="o">=&gt;</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Теперь у вас есть достаточно, чтобы отобразить форму тега саму по себе. Но
так как конечная цель - позволить тегам <tt class="docutils literal"><code>Task</code></tt> быть изменёнными прямо внутри
самой формы задачи, создайте форму для класса <tt class="docutils literal"><code>Task</code></tt>.</p>
<p>Заметьте, что вы встраиваете коллекцию форм <tt class="docutils literal"><code>TagType</code></tt>, используя поле
<a class="reference internal" href="..\reference\forms\types\collection.html"><em>CollectionType</em></a>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Form/Type/TaskType.php</span>
<span class="k">namespace</span> <span class="nx">App\Form\Type</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Task</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\AbstractType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\FormBuilderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\OptionsResolver\OptionsResolver</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\CollectionType</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">TaskType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilderInterface</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">);</span>

        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="nx">CollectionType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;entry_type&#39;</span> <span class="o">=&gt;</span> <span class="nx">TagType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="s1">&#39;entry_options&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">),</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">configureOptions</span><span class="p">(</span><span class="nx">OptionsResolver</span> <span class="nv">$resolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$resolver</span><span class="o">-&gt;</span><span class="na">setDefaults</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;data_class&#39;</span> <span class="o">=&gt;</span> <span class="nx">Task</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>В вашем контроллере, вы создадите новую форму из <tt class="docutils literal"><code>TaskType</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/TaskController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Task</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Entity\Tag</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Form\Type\TaskType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">TaskController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">new</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$task</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Task</span><span class="p">();</span>

        <span class="c1">// фиктивный код - он здесь просто, чтобы Task имел какие-то теги</span>
        <span class="c1">// иначе это не будет интересным примером</span>
        <span class="nv">$tag1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tag</span><span class="p">();</span>
        <span class="nv">$tag1</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="s1">&#39;tag1&#39;</span><span class="p">);</span>
        <span class="nv">$task</span><span class="o">-&gt;</span><span class="na">getTags</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$tag1</span><span class="p">);</span>
        <span class="nv">$tag2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tag</span><span class="p">();</span>
        <span class="nv">$tag2</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="s1">&#39;tag2&#39;</span><span class="p">);</span>
        <span class="nv">$task</span><span class="o">-&gt;</span><span class="na">getTags</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$tag2</span><span class="p">);</span>
        <span class="c1">// конец фиктивного кода</span>

        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="nx">TaskType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nv">$task</span><span class="p">);</span>

        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">handleRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isSubmitted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// ... возможно, обработайте как-то код, например, сохраите объекты Task и Tag</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">&#39;task/new.html.twig&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;form&#39;</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">(),</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Соответствующий шаблон теперь может отображать как поле <tt class="docutils literal"><code>description</code></tt> для
формы задачи, так и все формы <tt class="docutils literal"><code>TagType</code></tt> для любых тегов, которые уже связаны
с этим <tt class="docutils literal"><code>Task</code></tt>. В контроллере выше, я добавил немного фиктивного кода, чтобы
вы могли увидеть это в действии (так как <tt class="docutils literal"><code>Task</code></tt> при создании не имеет ни одного
тега).</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Twig</em><div class="literal-block"><div class="highlight-html+twig"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">{# templates/task/new.html.twig #}</span>

<span class="c">{# ... #}</span>

<span class="cp">{{</span> <span class="nv">form_start</span><span class="o">(</span><span class="nv">form</span><span class="o">)</span> <span class="cp">}}</span>
    <span class="c">{# отобразить единственное поле задачи: описание #}</span>
    <span class="cp">{{</span> <span class="nv">form_row</span><span class="o">(</span><span class="nv">form.description</span><span class="o">)</span> <span class="cp">}}</span>

    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Tags<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;tags&quot;</span><span class="p">&gt;</span>
        <span class="c">{# выполнить перебор каждого существующего тега и отобразить его единственное</span>
<span class="c">           поле: имя #}</span>
        <span class="cp">{%</span> <span class="k">for</span> <span class="nv">tag</span> <span class="k">in</span> <span class="nv">form.tags</span> <span class="cp">%}</span>
            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">form_row</span><span class="o">(</span><span class="nv">tag.name</span><span class="o">)</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">{{</span> <span class="nv">form_end</span><span class="o">(</span><span class="nv">form</span><span class="o">)</span> <span class="cp">}}</span>

<span class="c">{# ... #}</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-html+php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- templates/task/new.html.php --&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>

<span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$view</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">(</span><span class="nv">$form</span><span class="p">)</span> <span class="cp">?&gt;</span>
    <span class="c">&lt;!-- отобразить единственное поле задачи: описание --&gt;</span>
    <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$view</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span> <span class="cp">?&gt;</span>

    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Tags<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;tags&quot;</span><span class="p">&gt;</span>
        <span class="cp">&lt;?php</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span><span class="o">:</span> <span class="cp">?&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$view</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="nv">$tag</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="cp">?&gt;</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="cp">&lt;?php</span> <span class="k">endforeach</span> <span class="cp">?&gt;</span>
    <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$view</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">(</span><span class="nv">$form</span><span class="p">)</span> <span class="cp">?&gt;</span>

<span class="c">&lt;!-- ... --&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Когда пользователь отправляет форму, оправленные данные для поля <tt class="docutils literal"><code>tags</code></tt> используются
для построения <tt class="docutils literal"><code>ArrayCollection</code></tt> объектов <tt class="docutils literal"><code>Tag</code></tt>, который потом устанавливается в
поле <tt class="docutils literal"><code>tag</code></tt> экземпляра <tt class="docutils literal"><code>Task</code></tt>.</p>
<p>К коллекции <tt class="docutils literal"><code>tags</code></tt> можно получить доступ через <tt class="docutils literal"><code>$task-&gt;getTags()</code></tt> и её
можно сохранить в БД или использовать так, как вам нужно.</p>
<p>До этих пор, всё работало отлично, но это не позволяет вам динамически добавлять
новые теги или удалять уже существующие. Так что, несмотря на то, что редактирование
существующих тегов будет отлично работать, вам пользователь на самом деле пока ещё
не может добавлять новые теги.</p>
<div class="admonition-wrapper">
<div class="caution"></div><div class="admonition admonition-caution"><p class="first admonition-title">Caution</p>
<p>В этой статье вы встраиваете только одну коллекцию, но у вас нет таких
ограничений. Вы также можете встроить вложенную коллекцию на столько
уровней ниже, насколько вам этого захочется. Но если в установке разработки
вы используете Xdebug, то вы можете получить ошибку
<tt class="docutils literal"><code>Достигнут максимальный уровень функционирования вложенности '100', прерывание!</code></tt>.
Это из-за PHP-установки <tt class="docutils literal"><code>xdebug.max_nesting_level</code></tt>, которая по умолчанию равняется
<tt class="docutils literal"><code>100</code></tt>.</p>
<p class="last">Эта директива ограничивает рекурсию до 100 вызовов, что может быть недостаточным
для отображения формы в шаблоне, если вы отображаете сразу всю форму целиком
(например, <tt class="docutils literal"><code>form_widget(form)</code></tt>). Чтобы исправить это, вы можете установить в
этой директиве более высокое значение (либо через файл <tt class="docutils literal"><code>php.ini</code></tt>, либо через
<tt class="docutils literal"><code><a class="reference external" href="http://php.net/manual/en/function.ini-set.php" title="ini_set">ini_set</a></code></tt>, например, в <tt class="docutils literal"><code>public/index.php</code></tt>), либо отбразить каждое
поле формы вручную, используя <tt class="docutils literal"><code>form_row()</code></tt>.</p>
</div></div>
<div class="section" id="form-collections-new-prototype-ru">
<span id="id2"></span><h2>Разрешение &quot;новых&quot; тегов с помощью &quot;прототипа&quot;<a class="headerlink" href="#form-collections-new-prototype-ru" title="Permalink to this headline">¶</a></h2>
<p>Разршить пользователю динамически добавлять новые теги - означает, что вам
понадобится использовать JavaScript. Ранее вы добавляли в вашу форму два тега
в контроллере. Теперь, позвольте пользователю добавлять столько форм тегов,
сколько ему нужно, прямо в браузере. Это будет достигнуто с помощью JavaScript.</p>
<p>Первое, что вам нужно сделать, это дать коллекции форм знать, что она будет получать
неизвестное число тегов. До этого этапа вы добавили два тега и тип формы ожидает
получать именно два, а иначе будет выдана ошибка:
<tt class="docutils literal"><code>Эта форма не должна содержать дополнительных полей</code></tt>. Чтобы сделать это более гибким,
добавьте опцию <tt class="docutils literal"><code>allow_add</code></tt> в ваше поле коллекции:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Form/Type/TaskType.php</span>

<span class="c1">// ...</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\FormBuilderInterface</span><span class="p">;</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilderInterface</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">);</span>

    <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="nx">CollectionType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;entry_type&#39;</span> <span class="o">=&gt;</span> <span class="nx">TagType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
        <span class="s1">&#39;entry_options&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;label&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">),</span>
        <span class="s1">&#39;allow_add&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>В дополнение к тому, чтобы заставить полю принимать любое количество отправленных
объектов, <tt class="docutils literal"><code>allow_add</code></tt> также создаёт переменную <em>&quot;прототип&quot;</em>, доступную вам. Этот
&quot;прототип&quot; - это маленький &quot;шаблон&quot;, содержащий весь HTML, чтобы иметь возможность
отображать любые новые формы &quot;тегов&quot;. Чтобы отобразить их, сделайте в вашем шаблоне
следующее изменение:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Twig</em><div class="literal-block"><div class="highlight-html+twig"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;tags&quot;</span> <span class="na">data-prototype</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">form_widget</span><span class="o">(</span><span class="nv">form.tags.vars.prototype</span><span class="o">)|</span><span class="nf">e</span><span class="o">(</span><span class="s1">&#39;html_attr&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span>
    ...
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-html+php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;tags&quot;</span> <span class="na">data-prototype</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">&lt;?php</span>
    <span class="k">echo</span> <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">escape</span><span class="p">(</span><span class="nv">$view</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">row</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">vars</span><span class="p">[</span><span class="s1">&#39;prototype&#39;</span><span class="p">]))</span>
<span class="cp">?&gt;</span><span class="s">&quot;</span><span class="p">&gt;</span>
    ...
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">Если вы отображаете всю вашу подформу &quot;теги&quot; одновременно (например,
<tt class="docutils literal"><code>form_row(form.tags)</code></tt>), тогда прототип будет автоматически доступен во
внешнем <tt class="docutils literal"><code>div</code></tt> в качестве атрибута <tt class="docutils literal"><code>data-prototype</code></tt>, похоже на то, что
вы видели выше.</p>
</div></div>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p><tt class="docutils literal"><code>form.tags.vars.prototype</code></tt> - это элемент формы, который выглядит и ведёт себя
точно так же, как индивдиуальные элементы <tt class="docutils literal"><code>form_widget(tag)</code></tt> внутри вашего цикла
<tt class="docutils literal"><code>for</code></tt>. Это означает, что вы можете вызвать <tt class="docutils literal"><code>form_widget()</code></tt>, <tt class="docutils literal"><code>form_row()</code></tt> или
<tt class="docutils literal"><code>form_label()</code></tt>. Вы даже можете выбрать отображение только одного из его полей
(например, поля <tt class="docutils literal"><code>name</code></tt>):</p>
<div class="literal-block"><div class="last highlight-html+twig"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">{{</span> <span class="nv">form_widget</span><span class="o">(</span><span class="nv">form.tags.vars.prototype.name</span><span class="o">)|</span><span class="nf">e</span> <span class="cp">}}</span>
</pre></div>
</td></tr></table></div></div>
</div></div>
<p>На отображённой странице, результат будет выглядеть как-то так:</p>
<div class="literal-block"><div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;tags&quot;</span> <span class="na">data-prototype</span><span class="o">=</span><span class="s">&quot;&amp;lt;div&amp;gt;&amp;lt;label class=&amp;quot; required&amp;quot;&amp;gt;__name__&amp;lt;/label&amp;gt;&amp;lt;div id=&amp;quot;task_tags___name__&amp;quot;&amp;gt;&amp;lt;div&amp;gt;&amp;lt;label for=&amp;quot;task_tags___name___name&amp;quot; class=&amp;quot; required&amp;quot;&amp;gt;Name&amp;lt;/label&amp;gt;&amp;lt;input type=&amp;quot;text&amp;quot; id=&amp;quot;task_tags___name___name&amp;quot; name=&amp;quot;task[tags][__name__][name]&amp;quot; required=&amp;quot;required&amp;quot; maxlength=&amp;quot;255&amp;quot; /&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;/div&amp;gt;&quot;</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div></div>
<p>Целью этого раздела будет использование JavaScript для чтения этого атрибута и
динамического добавления новых форм тегов, когда пользователь кликает по ссылке
&quot;Добавить тег&quot;. Чтобы всё упростить, этот пример использует jQuery и предполагает,
что вы включили его где-то на вашей странице.</p>
<p>Добавьте тег <tt class="docutils literal"><code>script</code></tt> где-то на вашей страниче, чтобы вы могли начать писать
JavaScript.</p>
<p>Для начала, добавьте ссылку внизу списка &quot;тегов&quot; через JavaScript. Потом, привяжите
событие &quot;клик&quot; этой ссылки так, чтобы вы могли добавлять новую форму тега
(<tt class="docutils literal"><code>addTagForm()</code></tt> будет показан дальше):</p>
<div class="literal-block"><div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">$collectionHolder</span><span class="p">;</span>

<span class="c1">// установка ссылки &quot;добавить тег&quot;</span>
<span class="kd">var</span> <span class="nx">$addTagLink</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;#&quot; class=&quot;add_tag_link&quot;&gt;Add a tag&lt;/a&gt;&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">$newLinkLi</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;/li&gt;&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">$addTagLink</span><span class="p">);</span>

<span class="nx">jQuery</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Получите ul, содержащий коллекцию тегов</span>
    <span class="nx">$collectionHolder</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;ul.tags&#39;</span><span class="p">);</span>

    <span class="c1">// добавьте привязку &quot;добавить тег&quot; и li к тегам ul</span>
    <span class="nx">$collectionHolder</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">$newLinkLi</span><span class="p">);</span>

    <span class="c1">// почитайте текущие вводы формы, которые у вас есть (например, 2) и используйте</span>
    <span class="c1">// это в качестве нового индекса при вставке нового объекта (например, 2)</span>
    <span class="nx">$collectionHolder</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="nx">$collectionHolder</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;:input&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>

    <span class="nx">$addTagLink</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// предотвратите ссылку от создания &quot;#&quot; в URL</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

        <span class="c1">// добавьте новую форму тега (смотрите следующий блок кода)</span>
        <span class="nx">addTagForm</span><span class="p">(</span><span class="nx">$collectionHolder</span><span class="p">,</span> <span class="nx">$newLinkLi</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table></div></div>
<p>Работой функции <tt class="docutils literal"><code>addTagForm()</code></tt> будет использовать атрибут <tt class="docutils literal"><code>data-prototype</code></tt>,
чтобы динамически добавлять новую форму, когда переходят по её ссылке. HTML
<tt class="docutils literal"><code>data-prototype</code></tt> содержит вводный элемент тега <tt class="docutils literal"><code>text</code></tt> с именем <tt class="docutils literal"><code>task[tags][__name__][name]</code></tt>
и id <tt class="docutils literal"><code>task_tags___name___name</code></tt>. <tt class="docutils literal"><code>__name__</code></tt> - это маленький &quot;заполнитель&quot;, который
вы замените уникальным увеличивающимся числом (например <tt class="docutils literal"><code>task[tags][3][name]</code></tt>).</p>
<p>Код, необходимый для того, чтобы это всё работало, может очень разниться, но
вот один пример:</p>
<div class="literal-block"><div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">addTagForm</span><span class="p">(</span><span class="nx">$collectionHolder</span><span class="p">,</span> <span class="nx">$newLinkLi</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Получить прототип данных, объяснённый ранее</span>
    <span class="kd">var</span> <span class="nx">prototype</span> <span class="o">=</span> <span class="nx">$collectionHolder</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;prototype&#39;</span><span class="p">);</span>

    <span class="c1">// получить новый индекс</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">$collectionHolder</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">newForm</span> <span class="o">=</span> <span class="nx">prototype</span><span class="p">;</span>
    <span class="c1">// Вам нужно это только в случае, если вы не установили &#39;label&#39;, как &quot;false&quot; в вашем поле тегов в TaskType</span>
    <span class="c1">// Заменить &#39;__name__label__&#39; в HTML прототипа, чтобы</span>
    <span class="c1">// он был числом, основанным на том, сколько объектов у нас есть</span>
    <span class="c1">// newForm = newForm.replace(/__name__label__/g, index);</span>

    <span class="c1">// Заменить &#39;__name__&#39; в HTML прототипа на</span>
    <span class="c1">// номер, основанный на количестве имеющихся объектов</span>
    <span class="nx">newForm</span> <span class="o">=</span> <span class="nx">newForm</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/__name__/g</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>

    <span class="c1">// увеличить индекс на единицу для следующего объекта</span>
    <span class="nx">$collectionHolder</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Отобразить форму на странице в li, до ссылки Li &quot;добавить тег&quot;</span>
    <span class="kd">var</span> <span class="nx">$newFormLi</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;/li&gt;&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">newForm</span><span class="p">);</span>
    <span class="nx">$newLinkLi</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">$newFormLi</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">Лучше разделять ваш JavaScript на реальные файлы JavaScript, вместо
того, чтобы писать его внутри HTML, как показано тут.</p>
</div></div>
<p>Теперь, каждый раз, когда пользователь кликает по ссылке <tt class="docutils literal"><code>Add a tag</code></tt>, на странице
будет появляться новая подформа. Когда форма будет отправлена, любые новые формы тегов
будут конвертированы в новые объекты <tt class="docutils literal"><code>Tag</code></tt> и добавлены в свойство <tt class="docutils literal"><code>tags</code></tt> объекта
<tt class="docutils literal"><code>Task</code></tt>.</p>
<div class="admonition-wrapper">
<div class="seealso"></div><div class="admonition admonition-seealso">Вы можете найти рабочий пример тут - <a class="reference external" href="http://jsfiddle.net/847Kf/4/">JSFiddle</a>.</div></div>
<div class="admonition-wrapper">
<div class="seealso"></div><div class="admonition admonition-seealso">Если вы хотите настроить HTML-код в прототипе, прочтите <a class="reference internal" href="form_customization-ru.html#form-custom-prototype"><span>Как настроить прототип коллекции</span></a>.</div></div>
<p>Чтобы облегчить управление новыми тегами, добавьте методы &quot;adder&quot; и &quot;remover&quot;
для тегов в классе <tt class="docutils literal"><code>Task</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Task.php</span>
<span class="k">namespace</span> <span class="nx">App\Entity</span><span class="p">;</span>

<span class="c1">// ...</span>
<span class="k">class</span> <span class="nc">Task</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">addTag</span><span class="p">(</span><span class="nx">Tag</span> <span class="nv">$tag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">removeTag</span><span class="p">(</span><span class="nx">Tag</span> <span class="nv">$tag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Далее, добавьте опцию <tt class="docutils literal"><code>by_reference</code></tt> в поле <tt class="docutils literal"><code>tags</code></tt> и установите её как <tt class="docutils literal"><code>false</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Form/Type/TaskType.php</span>

<span class="c1">// ...</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilderInterface</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="nx">CollectionType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="c1">// ...</span>
        <span class="s1">&#39;by_reference&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
    <span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>С этими двумя изменениями, при отправке форме, каждый новый объект <tt class="docutils literal"><code>Tag</code></tt> будет
добавляться в класс <tt class="docutils literal"><code>Task</code></tt>, путём вызова метода <tt class="docutils literal"><code>addTag()</code></tt>. До этого, они
добавлялись формой внутренне, путём вызова <tt class="docutils literal"><code>$task-&gt;getTags()-&gt;add($tag)</code></tt>.
Это было нормально, использование метода &quot;adder&quot; делает уапрвление новыми объектами
<tt class="docutils literal"><code>Tag</code></tt> более лёгким (особенно, если вы используете Doctrine, о чём вы узнаете далее!).</p>
<div class="admonition-wrapper">
<div class="caution"></div><div class="admonition admonition-caution"><p class="first admonition-title">Caution</p>
<p class="last">Вам нужно создать <strong>оба</strong> метода: <tt class="docutils literal"><code>addTag()</code></tt> и <tt class="docutils literal"><code>removeTag()</code></tt>, иначе форма всё
равно будет использовать <tt class="docutils literal"><code>setTag()</code></tt> даже если <tt class="docutils literal"><code>by_reference</code></tt> в значении <tt class="docutils literal"><code>false</code></tt>.
Вы узнаете больше о методе <tt class="docutils literal"><code>removeTag()</code></tt> далее в этой статье.</p>
</div></div>
<div class="admonition-wrapper">
<div class="sidebar"></div><div class="admonition admonition-sidebar"><p class="first sidebar-title">Doctrine: Каскадные отношения и сохранение стороы &quot;инверсии&quot; (&quot;inverse&quot;)</p>
<p>Чтобы сохранить в Doctrine новые теги, вам нужно учесть еще несколько вещей.
Для начала, если вы не выполните перебор всех новых объектов <tt class="docutils literal"><code>Tag</code></tt> и не
вызовете в каждом <tt class="docutils literal"><code>$em-&gt;persist($tag)</code></tt>, вы получите ошибку от Doctrine:</p>
<blockquote>
<div>Найдена новая сущность в отношениях <tt class="docutils literal"><code>AppBundle\Entity\Task#tags</code></tt>, которая
не была сконфигурирована для каскадного сохранения для сущности...</div></blockquote>
<p>Чтобы исправить это, вы можете выбрать автоматическиую операцию &quot;каскадного&quot;
сохранения из объекта <tt class="docutils literal"><code>Task</code></tt> в любst связанные теги. Чтобы сделать это, добавьте
опцию <tt class="docutils literal"><code>cascade</code></tt> в ваши метаданные <tt class="docutils literal"><code>ManyToMany</code></tt>:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Annotations</em><div class="literal-block"><div class="highlight-php-annotations"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Task.php</span>

<span class="c1">// ...</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\ManyToMany(targetEntity=&quot;Tag&quot;, cascade={&quot;persist&quot;})</span>
<span class="sd"> */</span>
<span class="k">protected</span> <span class="nv">$tags</span><span class="p">;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># src/Resources/config/doctrine/Task.orm.yml</span>
<span class="l l-Scalar l-Scalar-Plain">App\Entity\Task</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">entity</span>
    <span class="c1"># ...</span>
    <span class="l l-Scalar l-Scalar-Plain">oneToMany</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">targetEntity</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Tag</span>
            <span class="l l-Scalar l-Scalar-Plain">cascade</span><span class="p p-Indicator">:</span>      <span class="p p-Indicator">[</span><span class="nv">persist</span><span class="p p-Indicator">]</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- src/Resources/config/doctrine/Task.orm.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">                    http://doctrine-project.org/schemas/orm/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;App\Entity\Task&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;one-to-many</span> <span class="na">field=</span><span class="s">&quot;tags&quot;</span> <span class="na">target-entity=</span><span class="s">&quot;Tag&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;cascade&gt;</span>
                <span class="nt">&lt;cascade-persist</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/cascade&gt;</span>
        <span class="nt">&lt;/one-to-many&gt;</span>
    <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Вторая возможная проблема касается <a class="reference external" href="http://docs.doctrine-project.org/en/latest/reference/unitofwork-associations.html">Стороны владения и стороны инверсии</a>
отношений Doctrine. В этом примере, если сторона &quot;владения&quot; в отношениях -
это &quot;Task&quot;, тогда сохранение будет нормально работать, так как в Task правильно
добавлены теги. Однако, если стороны владения в &quot;Tag&quot;, тогда вам понадобится
проделать некоторую работу, чтобы убедиться, что изменена правильна сторона
отношений.</p>
<p>Секрет в том, чтобы убедиться, что один &quot;Task&quot; установлен в каждом
&quot;Tag&quot;. Простой способ сделать это - добавить дополнительную логику к
<tt class="docutils literal"><code>addTag()</code></tt>, которая вызывается типом формы, так как <tt class="docutils literal"><code>by_reference</code></tt>
установлен, как <tt class="docutils literal"><code>false</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Task.php</span>

<span class="c1">// ...</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">addTag</span><span class="p">(</span><span class="nx">Tag</span> <span class="nv">$tag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$tag</span><span class="o">-&gt;</span><span class="na">addTask</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Внутри <tt class="docutils literal"><code>Tag</code></tt>, убедитесь в том, что у вас есть метод <tt class="docutils literal"><code>addTask()</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Tag.php</span>

<span class="c1">// ...</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">addTask</span><span class="p">(</span><span class="nx">Task</span> <span class="nv">$task</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tasks</span><span class="o">-&gt;</span><span class="na">contains</span><span class="p">(</span><span class="nv">$task</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tasks</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$task</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p class="last">Если у вас есть отношение один-ко-многим, тогда обходной путь похож, кроме
того, что вы просто можете вызвать <tt class="docutils literal"><code>setTask()</code></tt> изнутри <tt class="docutils literal"><code>addTag()</code></tt>.</p>
</div></div>
</div>
<div class="section" id="form-collections-remove-ru">
<span id="id3"></span><h2>Разрешение удаления тегов<a class="headerlink" href="#form-collections-remove-ru" title="Permalink to this headline">¶</a></h2>
<p>Следующим шагом является разрешение удаления конкретного предмета в коллекции.
Решение схоже с разрешением на добавление тегов.</p>
<p>Начните, добавив опцию <tt class="docutils literal"><code>allow_delete</code></tt> a форму Type (Тип):</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Form/Type/TaskType.php</span>

<span class="c1">// ...</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilderInterface</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="nx">CollectionType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="c1">// ...</span>
        <span class="s1">&#39;allow_delete&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
    <span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Теперь, вам нужно поместить некоторый код в метод <tt class="docutils literal"><code>removeTag()</code></tt> в <tt class="docutils literal"><code>Task</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Task.php</span>

<span class="c1">// ...</span>
<span class="k">class</span> <span class="nc">Task</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">removeTag</span><span class="p">(</span><span class="nx">Tag</span> <span class="nv">$tag</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span><span class="o">-&gt;</span><span class="na">removeElement</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="id4">
<h3>Изменения шаблонов<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Опция <tt class="docutils literal"><code>allow_delete</code></tt> означает, что если предмет коллекци не отослан
при отправке, связанные данные удаляются из коллекции на сервере. Для того,
чтобы это работало в HTML форме, вам нужно удалить элемент DOM в удаляемом
объекте коллекции, до отправки формы.</p>
<p>Для начала, добавьте ссылку &quot;удалить этот тег&quot; к каждой форме тега:</p>
<div class="literal-block"><div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">jQuery</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Получить ul, которы содержит коллекцию тегов</span>
    <span class="nx">$collectionHolder</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;ul.tags&#39;</span><span class="p">);</span>

    <span class="c1">// добавить ссылку удаления ко всем существующим элементам li в форме тегов</span>
    <span class="nx">$collectionHolder</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">addTagFormDeleteLink</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
    <span class="p">});</span>

    <span class="c1">// ... оставшийся блок, описанный выше</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">addTagForm</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="c1">// добавить ссылку удаления к новой форме</span>
    <span class="nx">addTagFormDeleteLink</span><span class="p">(</span><span class="nx">$newFormLi</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Функция <tt class="docutils literal"><code>addTagFormDeleteLink()</code></tt> будет выглядеть примерно так:</p>
<div class="literal-block"><div class="highlight-javascript"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">addTagFormDeleteLink</span><span class="p">(</span><span class="nx">$tagFormLi</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">$removeFormA</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;#&quot;&gt;delete this tag&lt;/a&gt;&#39;</span><span class="p">);</span>
    <span class="nx">$tagFormLi</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">$removeFormA</span><span class="p">);</span>

    <span class="nx">$removeFormA</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// предотвратить ссылку от создания &quot;#&quot; в URL</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

        <span class="c1">// удалить li в форме тегов</span>
        <span class="nx">$tagFormLi</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Когда форма тегов удалена из DOM и отправлена, удалённый объект <tt class="docutils literal"><code>Tag</code></tt> не
будет включён в коллекцию, переданную в <tt class="docutils literal"><code>setTags()</code></tt>. В зависимости от вашего
уровня сохранения, это может быть (не) достаточным для удаления отношения между
удалённым <tt class="docutils literal"><code>Tag</code></tt> и объектом <tt class="docutils literal"><code>Task</code></tt>.</p>
<div class="admonition-wrapper">
<div class="sidebar"></div><div class="admonition admonition-sidebar"><p class="first sidebar-title">Doctrine: Гарантирование сохранения БД</p>
<p>При удалении объектов таким способом, вам может понадобиться проделать
немного больше работы, чтобы гарантировать правильное удаление отношений
между <tt class="docutils literal"><code>Task</code></tt> и удалённым <tt class="docutils literal"><code>Tag</code></tt>.</p>
<p>В Doctrine, у вас есть две стороны отношений: сторона владения и сторона инверсии.
Обычно в этом случае у вас будет отношение многие-ко-многим, и удалённые теги
исчезнут и будут правильно сохранены (добавление новых тегов также работает без
усилий).</p>
<p>Но если у вас отношение один-ко-многим, или отношение многие-ко-многим с
<tt class="docutils literal"><code>mappedBy</code></tt> в сущности Task (что означает, что Task - сторона &quot;инверсии&quot;),
вам понадобится проделать больше работы, чтобы удалённые теги правильно
сохранялись.</p>
<p>В этом случае, вы можете изменять контроллер так, чтобы он удалял отношения
удалённого тега. Это предполагает, что у вас есть некоторое действие <tt class="docutils literal"><code>edit()</code></tt>,
который работает над &quot;обновлением&quot; вашего Task:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/TaskController.php</span>

<span class="k">use</span> <span class="nx">App\Entity\Task</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Common\Collections\ArrayCollection</span><span class="p">;</span>

<span class="c1">// ...</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">edit</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>
    <span class="nv">$task</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Task</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$task</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNotFoundException</span><span class="p">(</span><span class="s1">&#39;No task found for id &#39;</span><span class="o">.</span><span class="nv">$id</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$originalTags</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayCollection</span><span class="p">();</span>

    <span class="c1">// Создать ArrayCollection текущих объектов Tag в БД</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$task</span><span class="o">-&gt;</span><span class="na">getTags</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$originalTags</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$editForm</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="nx">TaskType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nv">$task</span><span class="p">);</span>

    <span class="nv">$editForm</span><span class="o">-&gt;</span><span class="na">handleRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$editForm</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>

        <span class="c1">// удалить отошения между тегом и Task</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$originalTags</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$task</span><span class="o">-&gt;</span><span class="na">getTags</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">contains</span><span class="p">(</span><span class="nv">$tag</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// удалить Task из Tag</span>
                <span class="nv">$tag</span><span class="o">-&gt;</span><span class="na">getTasks</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">removeElement</span><span class="p">(</span><span class="nv">$task</span><span class="p">);</span>

                <span class="c1">// если это было отношение многие-к-одному, удалить отношения, как это</span>
                <span class="c1">// $tag-&gt;setTask(null);</span>

                <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$tag</span><span class="p">);</span>

                <span class="c1">// если вы хотите удалить Tag полностью, вы также можете это сделать</span>
                <span class="c1">// $em-&gt;remove($tag);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$task</span><span class="p">);</span>
        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="c1">// перенаправение на ту же страницу редактирования</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirectToRoute</span><span class="p">(</span><span class="s1">&#39;task_edit&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$id</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// отобразить какой-то шаблон формы</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p class="last">Как вы видите, правильное добавление и удаление элементов может быть коварным.
Кроме случаев, когда у вас отношение многие-ко-многим, где Task - сторона
&quot;владения&quot;, вам понадобится делать дополнительную работу, чтобы убедиться в том,
что отношения правильно обновлены (независимо от того, добавляете вы новые теги,
или удаляете уже существующие) в каждом объекте Tag.</p>
</div></div>
<div class="admonition-wrapper">
<div class="sidebar"></div><div class="admonition admonition-sidebar"><p class="first sidebar-title">Плагин коллекции форм jQuery</p>
<p class="last">Плагин jQuery  <a class="reference external" href="https://github.com/ninsuo/symfony-collection">symfony-collection</a> помогает с элекментами формы <tt class="docutils literal"><code>collection</code></tt>,
предоставляя JavaScript функциональность, необходимую для добавления, редактирования
и удаления элементов коллекции. Более продвинутая функциональность вроде перемещения
или дублирования элемента в коллекции и настройки кнопок также возможна.</p>
</div></div>
</div>
</div>
</div>


            </div>

            
            <div class="navigation">
                <a href="form_collections.html">« How to Embed a Collection of Forms</a>
                <span class="separator">|</span>
                <a href="form_customization.html">How to Customize Form Rendering »</a>
            </div>
            

            <div id="license">
                <p>Эта документация является переводом <a href="http://symfony.com/doc/current/index.html">официальной документации Symfony</a> и предоставляется по свободной лицензии <a rel="license nofollow" href="https://creativecommons.org/licenses/by-sa/3.0/deed.ru">CC BY-SA 3.0</a>.</p>
            </div>
        </div>
    </div>
</div></div>


  </body>
</body></html>