<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Объяснение изменений контейнера DI в Symfony 3.3 (autowiring, _defaults, и др.) &mdash; Symfony Framework Documentation  documentation</title>
    
    <link rel="stylesheet" href="../_static/" type="text/css">
    <link rel="stylesheet" href="..\_static\pygments.css" type="text/css">
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <link rel="top" title="Symfony Framework Documentation  documentation" href="..\index.html">
    <link rel="up" title="Service Container" href="..\service_container.html">
    <link rel="next" title="How to Create Service Aliases and Mark Services as Private" href="alias_private.html">
    <link rel="prev" title="The Symfony 3.3 DI Container Changes Explained (autowiring, _defaults, etc)" href="3.3-di-changes.html">

<link rel="stylesheet" href="..\_assets\app.css?v=8d6d457a0820d7c245bddae16bfd4c75">
<script src="..\_assets\manifest.js?v=d41d8cd98f00b204e980"></script>
<script src="..\_assets\app.js?v=900984040c7cb4dca514"></script>
<style>
    .header__top .container {
        overflow: hidden;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .header__top .header__logo {
        float: left;
    }
    .header__top .header__support {
        float: right;
    }

    .highlight .k, .highlight .gh, .highlight .gp,
    .highlight .gu, .highlight .kc, .highlight .kd,
    .highlight .kn, .highlight .kr, .highlight .nc,
    .highlight .nd, .highlight .ni, .highlight .nl,
    .highlight .nn, .highlight .nt, .highlight .ow,
    .highlight .se { font-weight: normal; }

    .highlight .c, .highlight .cm, .highlight .c1,
    .highlight .sd, .highlight .si { font-style: normal; }

    .doc { background: none; }
    #demo-warning {
        border: 3px dashed #c00;
        padding: 10px;
        margin-bottom: 30px;
    }
    #demo-warning h4 { font-size: 1.7em;font-weight: bold; }
    #demo-warning p { margin-bottom: 0; }
</style>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-107764519-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-107764519-1');
</script>

<!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '250281335689441');
    fbq('track', 'PageView');
</script>
<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=250281335689441&ev=PageView&noscript=1">
<!-- End Facebook Pixel Code -->

<script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://vk.com/js/api/openapi.js?159",t.onload=function(){VK.Retargeting.Init("VK-RTRG-279161-8p6Jv"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><img src="https://vk.com/rtrg?p=VK-RTRG-279161-8p6Jv" style="position:fixed; left:-999px;" alt="">


  </head>
  <body role="document">

<body class="service_container doc_article doc">

<header>
    <section class="header__top">
        <div class="container">
            <div class="header__logo">
                <a href="..\..\..\index.html">
                    <img src="..\..\..\_images\header-logo.svg" alt="Symfony.com.ua logo">
                </a>
            </div>
            <div class="header__support hidden-xs">
                <a href="http://playtini.ua/" title="Компания Playtini">
                    <img height="69" src="..\..\..\_images\support.png" alt="Symfony is a SensioLabs product">
                </a>
            </div>
        </div>
    </section>
</header>

<div class="container"><div id="page-content">
    <div class="row">
        <div id="sidebar" class="col-sm-3">
            <div id="sidebar-content"><div class="submenu">
    
    
    <ul class="list_submenu list-unstyled">
    
        <li class="first">
            <a href="..\index.html">Главная</a>
        </li>
    
        <li>
            <a href="..\components\index.html">Компоненты</a>
        </li>
    
        <li>
            <a href="..\best_practices\index.html">Лучшие практики</a>
        </li>
    
        <li>
            <a href="..\quick_tour\index.html">Быстрый старт</a>
        </li>
    
        <li>
            <a href="..\reference\index.html">Справочник</a>
        </li>
    
        <li>
            <a href="..\genindex.html">Индекс</a>
        </li>
    
        <li>
            <a href="..\contributing\index.html">Участие</a>
        </li>
    
    </ul>
</div>

                <div class="toc"> 
    <h4>Содержание</h4>
    <div class="toc-content">
        <ul>
<li><a class="reference internal" href="#">Объяснение изменений контейнера DI в Symfony 3.3 (autowiring, _defaults, и др.)</a><ul>
<li><a class="reference internal" href="#id1">Все измеения необязательны</a></li>
<li><a class="reference internal" href="#services-yml">Новый файл services.yml по умолчанию</a></li>
<li><a class="reference internal" href="#service-33-changes-automatic-registration-ru">1) Сервисы загружаются автоматически</a></li>
<li><a class="reference internal" href="#id">2) Автомонтаж по умолчанию: использование типизироване вместо id сервиса</a></li>
<li><a class="reference internal" href="#id3">3) Контроллеры регистрируются, как сервисы</a></li>
<li><a class="reference internal" href="#id4">4) Автотегирование с автоконфигурацией</a></li>
<li><a class="reference internal" href="#id5">Что насчёт производительности</a></li>
<li><a class="reference internal" href="#symfony-3-3">Обновление до новой конфигурации Symfony 3.3</a><ul>
<li><a class="reference internal" href="#defaults">Шаг 1): Добавление _defaults</a></li>
<li><a class="reference internal" href="#id6">Шаг 2) Использование id сервисов класса</a></li>
<li><a class="reference internal" href="#id7">Шаг 3) Сделайте сервисы приватными</a></li>
<li><a class="reference internal" href="#id8">Шаг 4) Авторегистрация сервисов</a></li>
<li><a class="reference internal" href="#id9">Шаг 5) Очистка!</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
</div>
                
            </div>

            <div class="ads m-b-30">
                <h2>Вакансии Playtini</h2>
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/php-dev">
                            Middle+ PHP Developer/Symfony
                        </a>
                    </h3>
                    <div><b>Playtini</b> активно поддерживает и развивает свои продукты, и профессионализм команды. И на данный момент в поиске специалиста на позицию <b>«Middle+ PHP Developer/Symfony»,</b> который улучшит качество внутренних сервисов компании и увеличит их количество.</div>
                </div>
                <!--
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/symfony-senior">
                            Senior PHP Developer/Symfony
                        </a>
                    </h3>
                    <div>We are looking for strong, experienced <b>Senior PHP Developer/Symfony.</b> We expect him/her to participate in improving and extending a system built using microservice architecture by means of modern technologies.</div>
                </div>
                -->
                <div class="ad">
                    <h3><a href="http://playtini.ua/careers">
                        Остальные вакансии компании
                        <img src="..\..\..\_images\logo-playtini.png" alt="Playtini">
                    </a></h3>
                </div>
            </div>
        </div>

        <div id="main" class="col-sm-9">
            <ol class="breadcrumb">
                
                <li><a href="..\index.html">Документация</a></li>
                
                <li><a href="..\service_container.html">Service Container</a></li>
                
                <li class="active">Объяснение изменений контейнера DI в Symfony 3.3 (autowiring, _defaults, и др.)</li>
            </ol>

            <div class="page">
                
  <div class="section" id="di-symfony-3-3-autowiring-defaults">
<h1>Объяснение изменений контейнера DI в Symfony 3.3 (autowiring, _defaults, и др.)<a class="headerlink" href="#di-symfony-3-3-autowiring-defaults" title="Permalink to this headline">¶</a></h1>
<p>Если вы посмотрите на файл <tt class="docutils literal"><code>services.yml</code></tt> в новом проекте Symfony 3.3, то вы заметите
некоторые большие изменения: <tt class="docutils literal"><code>_defaults</code></tt>, <tt class="docutils literal"><code>autowiring</code></tt>, <tt class="docutils literal"><code>autoconfigure</code></tt> и другие.
Эти функции созданы для <em>автоматизации</em> конфигурации и для того, чтобы разработка стала
быстрее, не жертвуя предсказуемостью, которая очень важна! Ещё одна цель - заставить
контроллеры и сервисы вести себя более последовательно. В Symfony 3.3, контроллеры <em>являются</em>
сервисами по умолчанию.</p>
<p>Документация уже была обновлена так, чтобы предположить, что у вас включены эти новые
функции. Если вы уже существующий пользователь Symfony и хотите понять &quot;что&quot; и &quot;почему&quot;,
стоящие за этими изменениями, то эта статья для вас!</p>
<div class="section" id="id1">
<h2>Все измеения необязательны<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Самое важное - <strong>сегодня вы можете обновиться до Symfony 3.3, не внося никаких изменений
в ваше приложение</strong>. Symfony имеет строгое <a class="reference internal" href="..\contributing\code\bc.html"><em>обещание обратной совместимости</em></a>,
что означает, что обновляться до упрощённых версий всегда безопасно.</p>
<p>Все новые функции являются <strong>необязательными</strong>: они не включаются по умолчанию, так
что вам нужно изменить ваши файлы конфигурации, чтобы их использовать.</p>
</div>
<div class="section" id="services-yml">
<h2>Новый файл services.yml по умолчанию<a class="headerlink" href="#services-yml" title="Permalink to this headline">¶</a></h2>
<p>Чтобы понять изменения, посмотрите на новый файл <tt class="docutils literal"><code>services.yml</code></tt> по умолчанию,
в стандартной версии Symfony:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># app/config/services.yml</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="c1"># конфигурация по умолчанию для сервисов в *этом* файле</span>
    <span class="l l-Scalar l-Scalar-Plain">_defaults</span><span class="p p-Indicator">:</span>
        <span class="c1"># автоматически внедряет зависимости в ваших сервисах</span>
        <span class="l l-Scalar l-Scalar-Plain">autowire</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="c1"># автоматически регистрирует ваши сервисы, как команды, подписчики событий и т.д.</span>
        <span class="l l-Scalar l-Scalar-Plain">autoconfigure</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="c1"># это означает, что вы не можете вызывать сервисы напрямую из контейнера через $container-&gt;get()</span>
        <span class="c1"># если вам нужно сделать это, вы можете переопределить эту настройку в отдельных сервисах</span>
        <span class="l l-Scalar l-Scalar-Plain">public</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

    <span class="c1"># делает так, чтобы классы в src/AppBundle available были использованы, как сервисы</span>
    <span class="c1"># это создаёт по сервису на класс, id которых является полностью сертифицированным именем класса</span>
    <span class="l l-Scalar l-Scalar-Plain">AppBundle\</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="s">&#39;../../src/AppBundle/*&#39;</span>
        <span class="c1"># you can exclude directories or files</span>
        <span class="c1"># but if a service is unused, it&#39;s removed anyway</span>
        <span class="l l-Scalar l-Scalar-Plain">exclude</span><span class="p p-Indicator">:</span> <span class="s">&#39;../../src/AppBundle/{Entity,Repository}&#39;</span>

    <span class="c1"># контроллеры импортируются отдельно, чтобы убедиться в том, что они публичны</span>
    <span class="c1"># и имеют тег, позволяющий действия по типизированию сервисов</span>
    <span class="l l-Scalar l-Scalar-Plain">AppBundle\Controller\</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="s">&#39;../../src/AppBundle/Controller&#39;</span>
        <span class="l l-Scalar l-Scalar-Plain">public</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;controller.service_arguments&#39;</span><span class="p p-Indicator">]</span>

    <span class="c1"># добавьте больше сервисов, или переопределите сервисы, которые требуют ручного монтажа</span>
    <span class="c1"># AppBundle\Service\ExampleService:</span>
    <span class="c1">#     аргументы:</span>
    <span class="c1">#         $someArgument: &#39;some_value&#39;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- app/config/services.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="nt">&lt;container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;services&gt;</span>
        <span class="nt">&lt;defaults</span> <span class="na">autowire=</span><span class="s">&quot;true&quot;</span> <span class="na">autoconfigure=</span><span class="s">&quot;true&quot;</span> <span class="na">public=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;prototype</span> <span class="na">namespace=</span><span class="s">&quot;AppBundle\&quot;</span> <span class="na">resource=</span><span class="s">&quot;../../src/AppBundle/*&quot;</span> <span class="na">exclude=</span><span class="s">&quot;../../src/AppBundle/{Entity,Repository}&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;prototype</span> <span class="na">namespace=</span><span class="s">&quot;AppBundle\Controller&quot;</span> <span class="na">resource=</span><span class="s">&quot;../../src/AppBundle/Controller&quot;</span> <span class="na">public=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tag</span> <span class="na">name=</span><span class="s">&quot;controller.service_arguments&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/prototype&gt;</span>
    <span class="nt">&lt;/services&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// app/config/services.php</span>

<span class="c1">// _defaults и загрузка целых каталогов невозможна с конфигурацией PHP</span>
<span class="c1">// вам нужно определить ваши сервисы один за другим</span>
<span class="k">use</span> <span class="nx">AppBundle\Controller\DefaultController</span><span class="p">;</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">autowire</span><span class="p">(</span><span class="nx">DefaultController</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setAutoconfigured</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">addTag</span><span class="p">(</span><span class="s1">&#39;controller.service_arguments&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setPublic</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Эта маленькая часть конфигурации содержит смену понятий того, как конфигурируются
сервисы в Symfony.</p>
</div>
<div class="section" id="service-33-changes-automatic-registration-ru">
<span id="id2"></span><h2>1) Сервисы загружаются автоматически<a class="headerlink" href="#service-33-changes-automatic-registration-ru" title="Permalink to this headline">¶</a></h2>
<div class="admonition-wrapper">
<div class="seealso"></div><div class="admonition admonition-seealso">Прочтите документацию по <a class="reference internal" href="..\service_container.html#service-psr4-loader"><span>автоматической загрузке сервисов</span></a>.</div></div>
<p>Первое большое изменение в том, что сервисы больше <em>не</em> должны быть определены один за
другим благодаря следующей конфигурации:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># app/config/services.yml</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="c1"># ...</span>

    <span class="c1"># делает классы в src/AppBundle доступными для использования в качестве сервисов</span>
    <span class="c1"># это создаёт по сервису на класс, id которых является полностью сертифицированным именем класса</span>
    <span class="l l-Scalar l-Scalar-Plain">AppBundle\</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="s">&#39;../../src/AppBundle/*&#39;</span>
        <span class="c1"># you can exclude directories or files</span>
        <span class="c1"># but if a service is unused, it&#39;s removed anyway</span>
        <span class="l l-Scalar l-Scalar-Plain">exclude</span><span class="p p-Indicator">:</span> <span class="s">&#39;../../src/AppBundle/{Entity,Repository}&#39;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- app/config/services.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="nt">&lt;container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;services&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>

        <span class="nt">&lt;prototype</span> <span class="na">namespace=</span><span class="s">&quot;AppBundle\&quot;</span> <span class="na">resource=</span><span class="s">&quot;../../src/AppBundle/*&quot;</span> <span class="na">exclude=</span><span class="s">&quot;../../src/AppBundle/{Entity,Repository}&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/services&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// app/config/services.php</span>

<span class="c1">// сервисы не могут быть загружены автоматически с PHP-конфигурацией</span>
<span class="c1">// вам нужно определить ваши сервисы один за другим</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Это означает, что каждый класс в <tt class="docutils literal"><code>src/AppBundle/</code></tt> <em>доступен</em> для использования в
качестве сервиса. И благодаря части <tt class="docutils literal"><code>_defaults</code></tt> сверху файла, все эти сервисы являются
<strong>автомонтируемым</strong> и <strong>приватными</strong> (т.е. <tt class="docutils literal"><code>public: false</code></tt>).</p>
<p>Id сервисов равняются имени класса (например, <tt class="docutils literal"><code>AppBundle\Service\InvoiceGenerator</code></tt>).
И это ещё одно изменение, которое вы заметите в Symfony 3.3: мы рекомендуем вам исползовать
имя класса в качестве id вашего сервиса, разве что у вас не
<a class="reference internal" href="..\service_container.html#services-explicitly-configure-wire-services"><span>множество сервисов для одного класса</span></a>.</p>
<blockquote>
<div>Но как контейнер может знать аргументы моего сервиса?</div></blockquote>
<p>Так как каждый сервис является <a class="reference internal" href="..\service_container.html#services-autowire"><span>автомонтируемым</span></a>, контейнер
может определить большинство аргументов автоматически. Но вы всегда можете переопределить
сервис и <a class="reference internal" href="..\service_container.html#services-manually-wire-args"><span>сконфигурировать аргументы вручную</span></a> или
сделать что-либо другое особенное с вашим сервисом.</p>
<blockquote>
<div>Но погодите, если у меня есть какие-то классы модели (не сервисы) в моём
каталоге <tt class="docutils literal"><code>src/AppBundle/</code></tt>, разве это не означает, что <em>они</em> тоже будут
зарегистрированы, как сервисы? Разве это не проблема?</div></blockquote>
<p>На самом деле, это <em>не</em> проблема. Так как все новые сервисы <a class="reference internal" href="..\service_container.html#container-public"><span>приватные</span></a>
(благодаря <tt class="docutils literal"><code>_defaults</code></tt>), то есть какие-то из сервисов <em>не</em> используются в вашем коде,
они будут автоматически удалены из скомпилированного контейнера. Это означает, что
число сервисов в вашем контейнере должно быть <em>одинаковым</em> независимо от того, ясно
ли вы сконфигурируете каждый сервис, или загрузите их все одномоментно с помощью этого
метода.</p>
<blockquote>
<div>Ладно, но могу ли я исключить некоторые пути, которые я <em>знаю</em>, не содержат
сервисов?</div></blockquote>
<p>Да! Ключ <tt class="docutils literal"><code>exclude</code></tt> - это глобальный шаблон, который можно использовать для внесения
в <em>черный список</em> тех путей, которые вы <em>не</em> хотите включать, как сервисы. Но, так как
неиспользуемые сервисы автоматически удаляются из контейнера, <tt class="docutils literal"><code>exclude</code></tt> не так уж и
важен. Наибольшим преимуществом является то, что эти пути не <em>отслеживаются</em> контейнером,
и поэтому могут привести к тому, что контейнеру нужно будет реже перестраиваться в окружении
<tt class="docutils literal"><code>dev</code></tt>.</p>
</div>
<div class="section" id="id">
<h2>2) Автомонтаж по умолчанию: использование типизироване вместо id сервиса<a class="headerlink" href="#id" title="Permalink to this headline">¶</a></h2>
<p>Второе большое изменение - автомонтирование включено (через <tt class="docutils literal"><code>_defaults</code></tt>) для всех
зарегистрированных вами сервисов. Это также означает, что id сервисов теперь <em>менее</em>
важны, а &quot;типы&quot; (т.е. имена класса или интерфеса) теперь <em>более</em> важны.</p>
<p>Например, до Symfony 3.3 (и это все еще разрешается), вы могли передать один сервис
в качестве аргумента к другому со следующей конфигурацией:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># app/config/services.yml</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app.invoice_generator</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\InvoiceGenerator</span>

    <span class="l l-Scalar l-Scalar-Plain">app.invoice_mailer</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\InvoiceMailer</span>
        <span class="l l-Scalar l-Scalar-Plain">arguments</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;@app.invoice_generator&#39;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- app/config/services.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="nt">&lt;container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;services&gt;</span>
        <span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;app.invoice_generator&quot;</span>
            <span class="na">class=</span><span class="s">&quot;AppBundle\Service\InvoiceGenerator&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">&quot;app.invoice_mailer&quot;</span>
            <span class="na">class=</span><span class="s">&quot;AppBundle\Service\InvoiceMailer&quot;</span><span class="nt">&gt;</span>

            <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">&quot;service&quot;</span> <span class="na">id=</span><span class="s">&quot;app.invoice_generator&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/service&gt;</span>
    <span class="nt">&lt;/services&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// app/config/services.php</span>
<span class="k">use</span> <span class="nx">AppBundle\Service\InvoiceGenerator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">AppBundle\Service\InvoiceMailer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\DependencyInjection\Reference</span><span class="p">;</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;app.invoice_generator&#39;</span><span class="p">,</span> <span class="nx">InvoiceGenerator</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="s1">&#39;app.invoice_mailer&#39;</span><span class="p">,</span> <span class="nx">InvoiceMailer</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setArguments</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="k">new</span> <span class="nx">Reference</span><span class="p">(</span><span class="s1">&#39;app.invoice_generator&#39;</span><span class="p">)));</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Чтобы передать <tt class="docutils literal"><code>InvoiceGenerator</code></tt> в качестве аргумента к <tt class="docutils literal"><code>InvoiceMailer</code></tt>, вам
нужно было указать <em>id</em> сервиса, как аргумент: <tt class="docutils literal"><code>app.invoice_generator</code></tt>. Id сервисов
были главным способом конфигурации вещей.</p>
<p>Но в Symfony 3.3, благодаря автомонтированию, всё, что вам надо сделать - это типизировать
аргумент с помощью <tt class="docutils literal"><code>InvoiceGenerator</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/AppBundle/Service/InvoiceMailer.php</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">InvoiceMailer</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$generator</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">InvoiceGenerator</span> <span class="nv">$generator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generator</span> <span class="o">=</span> <span class="nv">$generator</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Вот и всё! Оба сервиса <a class="reference internal" href="3.3-di-changes.html#service-33-changes-automatic-registration"><span>автоматически зарегистрированы</span></a>
и установлены для автомонтированя. Без <em>какой-либо</em> конфигурации, контейнер знает, что
надо передать автоматически зарегистрированный <tt class="docutils literal"><code>AppBundle\Service\InvoiceGenerator</code></tt> в
качестве первого аргумента. Как вы видите, <em>тип</em> класса - <tt class="docutils literal"><code>AppBundle\Service\InvoiceGenerator</code></tt>
- это самое важное, не id. Вы запрашиваете <em>экземпляр</em> конкретного типа и контейнер автоматически
передаёт вам правильный сервис.</p>
<blockquote>
<div>Ну разве не магия? Как он знает, какой именно сервис передать мне? Что, если
у меня множество сервисов одного экземпляра?</div></blockquote>
<p>Система автомонтирования была создана так, чтобы быть <em>очень</em> предсказуемов. Вначале
она работает путём поиска сервиса, iв которого <em>точно</em> совпадает с типизацией. Это
означает, что вы полностью контролируете, какое типизирование ведёт к какому сервису.
Вы даже можете использовать союзников сервисов, чтобы получить больше контроля. Если
у вас множесво сервисов конкретного типа, <em>вы</em> выбираете, какие из них должны быть
использованы для автомонтирования. Чтобы узнать все детали о логике автомонтирования,
см. <a class="reference internal" href="autowiring.html#autowiring-logic-explained"><span>Autowiring Logic Explained</span></a>.</p>
<blockquote>
<div>Но что, если у меня скалярный (например, строка) аргумент? Как он автомонтируется?</div></blockquote>
<p>Если у вас есть аргумент, который <em>не</em> является объетом, то он не может быть автоматически
смонтирован. Но это не страшно! Symfony предоставит вам чёткое исключение (при последующем
обновлении <em>любой</em> страницы), сообщающее вам, какой аргумент какого сервиса не мог быть
автосмонтирован. Чтобы исправить это, вы можете
<a class="reference internal" href="..\service_container.html#services-manually-wire-args"><span>вручную сконфигурировать *только* этот один аргумент</span></a>.
В этом заключается философия автомонтирования: конфигурировать только те части, которые
вам необходимы. Большинство конфигураций автоматизированы.</p>
<blockquote>
<div>Ладно, но автомонтирование делае ваше приложение менее стабильным. Если вы измените
одну вещь, или сделаете ошибку, могут случиться непредвиденные вещи. Разве это не
проблема?</div></blockquote>
<p>Symfony всегда ценила стабильность, безопасность и предсказуемость в первую очередь.
Автомонтирование было создано с мыслью об этом. В особенности:</p>
<ul class="simple">
<li>Если естьпроблема с монтированием <em>любого</em> аргумента к <em>любому</em> сервису, выдаётся
чёткое исключение при последующем обновлении <em>любой</em> страницы, даже если вы не
используете этот сревис на этой странице. Это <em>мощно</em>: <em>невозможно</em> сделать ошибку
автомонтирования и не заметить этого.</li>
<li>Контейнер определяет, <em>какой</em> сервис передать в подробной манере: он ищет сервис,
id которого точно совпадает с типизированием. Он <em>не</em> сканирует все сервисы, в поисках
объектов, которые имеют этот класс или интерфейс (на самом деле, он <em>делает</em> это в
Symfony 3.3, но это было осуждено. Если вы полагаетесь на это, то вы увидите ясное
предупреждение о возражении).</li>
</ul>
<p>Автомонтирование стремится <em>автоматизировать</em> конфигурацию без магии.</p>
</div>
<div class="section" id="id3">
<h2>3) Контроллеры регистрируются, как сервисы<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Третье большое изменение состоит в том, что в новом проекте Symfony 3.3, ваши
контроллеры - это <em>сервисы</em>:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># app/config/services.yml</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="c1"># ...</span>

    <span class="c1"># контроллеры импортируются отдельно, чтобы убедиться в том, что они публичные</span>
    <span class="c1"># и имеют тег, который позволяет действия по типизированию сервисов</span>
    <span class="l l-Scalar l-Scalar-Plain">AppBundle\Controller\</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="s">&#39;../../src/AppBundle/Controller&#39;</span>
        <span class="l l-Scalar l-Scalar-Plain">public</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;controller.service_arguments&#39;</span><span class="p p-Indicator">]</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- app/config/services.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="nt">&lt;container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;services&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>

        <span class="nt">&lt;prototype</span> <span class="na">namespace=</span><span class="s">&quot;AppBundle\Controller&quot;</span> <span class="na">resource=</span><span class="s">&quot;../../src/AppBundle/Controller&quot;</span> <span class="na">public=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;tag</span> <span class="na">name=</span><span class="s">&quot;controller.service_arguments&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/prototype&gt;</span>
    <span class="nt">&lt;/services&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// app/config/services.php</span>

<span class="c1">// загрузка каталогов целиком невозможна с PHP-конфигурацией</span>
<span class="c1">// вам нужно определить ваши сервисы один за другим</span>
<span class="k">use</span> <span class="nx">AppBundle\Controller\DefaultController</span><span class="p">;</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">autowire</span><span class="p">(</span><span class="nx">DefaultController</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setAutoconfigured</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">addTag</span><span class="p">(</span><span class="s1">&#39;controller.service_arguments&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">setPublic</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Однако, вы этого можете дажене заметить. Во-первых, ваши контроллеры всё ещё <em>могут</em>
расширять тот же базовый класс <tt class="docutils literal"><code>Controller</code></tt> или новый <a class="reference internal" href="..\controller.html#controller-abstract-versus-controller"><span>AbstractController</span></a>.
Это означает, что у вас есть доступ ко всем тем же шорткатам, что и раньше. Кроме
того, аннотация <tt class="docutils literal"><code>&#64;Route</code></tt> и синтаксис <tt class="docutils literal"><code>_controller</code></tt> (например,``AppBundle:Default:homepage``),
используемые в маршрутизации, автоматически будут использовать ваш контроллер в качестве
сервиса (до тех пор, пока id сервиса будет совпадать с именем класса, что <em>верно</em> в этом
случае). Смотрите <a class="reference internal" href="..\controller\service.html"><em>How to Define Controllers as Services</em></a>, чтобы узнать больше деталей. Вы даже можете
создать <a class="reference internal" href="..\controller\service.html#controller-service-invoke"><span>вызываемые контроллеры</span></a></p>
<p>Другими словами, всё работает точно так же. Вы даже можете добавлять конфигурацию,
описанную выше, к вашему существующему проекту без каких-либо проблем: ваши контроллеры
будут вести себя так же, как и раньше. Но теперь, когда ваши контроллеры являются
сервисами, вы можете использовать внедрение зависимости и автомонтирование, как любой
другой сервис.</p>
<p>Чтобы ещё больше облегчить вам жизнь, теперь возможно автомонтировать аргументы в ваших
методах действий контроллера, так же, как вы можете это сделать с конструктором сервисов.
Например:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Log\LoggerInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">InvoiceController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">listAction</span><span class="p">(</span><span class="nx">LoggerInterface</span> <span class="nv">$logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$logger</span><span class="o">-&gt;</span><span class="na">info</span><span class="p">(</span><span class="s1">&#39;A new way to access services!&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Это возможно <em>только</em> в контроллере, и ваш сервис контроллера должен быть тегирован
с помощью <tt class="docutils literal"><code>controller.service_arguments</code></tt>, чтобы это сработало. Эта новая функция
используется по всей документации.</p>
<p>В общем, новой наилучшей практикой является использование нормального конструктора
внедрения зависимости (или внедрения &quot;действия&quot; в контроллерах), вместо вызова публичных
сервисов через <tt class="docutils literal"><code>$this-&gt;get()</code></tt> (хотя это всё ещё работает).</p>
</div>
<div class="section" id="id4">
<h2>4) Автотегирование с автоконфигурацией<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Последнее большое изменение - это ключ <tt class="docutils literal"><code>autoconfigure</code></tt>, который установлен как
<tt class="docutils literal"><code>true</code></tt> в <tt class="docutils literal"><code>_defaults</code></tt>. Благодаря этому, контейнер будет автоматически тегировать
сервисы, зарегистрированные в этом файле. Например, представьте, что вы хотите создать
подписчика событий. Для начала, вы создаёте класс:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/AppBundle/EventSubscriber/SetHeaderSusbcriber.php</span>
<span class="c1">// ...</span>

<span class="k">use</span> <span class="nx">Symfony\Component\EventDispatcher\EventSubscriberInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\Event\FilterResponseEvent</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\KernelEvents</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SetHeaderSusbcriber</span> <span class="k">implements</span> <span class="nx">EventSubscriberInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onKernelResponse</span><span class="p">(</span><span class="nx">FilterResponseEvent</span> <span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getResponse</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">headers</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">&#39;X-SYMFONY-3.3&#39;</span><span class="p">,</span> <span class="s1">&#39;Less config&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getSubscribedEvents</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nx">KernelEvents</span><span class="o">::</span><span class="na">RESPONSE</span> <span class="o">=&gt;</span> <span class="s1">&#39;onKernelResponse&#39;</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Отлично! В Symfony 3.2 или более ранних версиях, вам бы сейчас понадобилось регистрировать
это как сервис в <tt class="docutils literal"><code>services.yml</code></tt> и тегировать с помощью <tt class="docutils literal"><code>kernel.event_subscriber</code></tt>. В
Symfony 3.3, вы уже закончили! Сервис <a class="reference internal" href="3.3-di-changes.html#service-33-changes-automatic-registration"><span>зарегистрирован автоматически</span></a>.
И благодаря <tt class="docutils literal"><code>autoconfigure</code></tt>, Symfony автоматически тегирует сервис, так как он реализует
<tt class="docutils literal"><code>EventSubscriberInterface</code></tt>.</p>
<blockquote>
<div>Это звучит как магия - он <em>автоматически</em> тегирует мои сервисы?</div></blockquote>
<p>В этом случае, вы создали класс, который реализует <tt class="docutils literal"><code>EventSubscriberInterface</code></tt> и
зарегистрировали его в качестве сервиса. Это более, чем достаточно для того, чтобы
контейнер знал, что вы хотите использовать это в качестве подписчика событий:
дальнейшая конфигурация не требуется. А система тегирования - это собвственный
механизм Symfony. И конечно же, вы всегда можете установить <tt class="docutils literal"><code>autowire</code></tt> по умолчанию
в значенни &quot;false&quot; в <tt class="docutils literal"><code>services.yml</code></tt>, или отключить его для конкретного сервиса.</p>
<blockquote>
<div>Это значит, что теги умерли? Это работает для всех тегов?</div></blockquote>
<p>Это <em>не</em> работает для всех тегов. Многие теги имеют <em>обязательные</em> атрибуты, как
<em>слушатели</em> событий, когда вам также нужно указать имя события и метод в вашем теге.
Автоконфигурация работает только для тегов, которые не имеют обязательных атрибутов
тега, и когда вы прочтёте документы по функции, из них вы узнаете, требуется ли тег.
Вы также можете посмотреть классы расширений (например, <a class="reference external" href="https://github.com/symfony/symfony/blob/7938fdeceb03cc1df277a249cf3da70f0b50eb98/src/Symfony/Bundle/FrameworkBundle/DependencyInjection/FrameworkExtension.php#L247-L284">FrameworkExtension для 3.3.0</a>),
чтобы увидеть, что они конфигурируют автоматически.</p>
<blockquote>
<div>Что если мне надо добавить в моей тег приоритетность?</div></blockquote>
<p>Множество автоматически сокнфигурированных тегов имеют необязательную приоритетность.
Если вам нужно указать приоритет (или любой другой необязательный атрибут тега), то
это не проблема! Просто <a class="reference internal" href="..\service_container.html#services-manually-wire-args"><span>сконфигурируйте ваш сервис вручную</span></a>
и добавьте тег. Вам тег будет превосходить по значимости тот, что был добавлен автоконфигурацией.</p>
</div>
<div class="section" id="id5">
<h2>Что насчёт производительности<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Symfony уникальна, так как она имеет <em>скомпилированный</em> контейнер. Это означает, что
<em>нет</em> никакого влияния на время прогона производительности при использовании любых из
этих функций. Это также то, почему система автомонтирования может выдвать вам такие
чёткие ошибки.</p>
<p>Однако, есть некоторое влияние на производительность в окружении <tt class="docutils literal"><code>dev</code></tt>. Самое важное -
ваш контейнер скорее всего будет перестариваться более часто при изменении ваших классов
сервиса. Это так потому что ему требуется перестраиваться каждый раз, когда вы добавляете
в сервис новый аргумент, или добавляете интерфейс в ваш класс, который должен быть сконфигурирован
автоматически.</p>
<p>В очень больших проектах это может стать проблемой. Если так случится, вы всегда можете
выбрать <em>не</em> использвать автомонтирование. Если вы думаете, что система перестройки кеша
могла бы быть умнее в какой-то ситуации, пожалуйста, создайте вопрос!</p>
</div>
<div class="section" id="symfony-3-3">
<h2>Обновление до новой конфигурации Symfony 3.3<a class="headerlink" href="#symfony-3-3" title="Permalink to this headline">¶</a></h2>
<p>Готовы обновить ваш существующий проект? Отлично! Представьте, что у вас есть следующая
конфигурация:</p>
<div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># app/config/services.yml</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app.github_notifier</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\GitHubNotifier</span>
        <span class="l l-Scalar l-Scalar-Plain">arguments</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;@app.api_client_github&#39;</span>

    <span class="l l-Scalar l-Scalar-Plain">markdown_transformer</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\MarkdownTransformer</span>

    <span class="l l-Scalar l-Scalar-Plain">app.api_client_github</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\ApiClient</span>
        <span class="l l-Scalar l-Scalar-Plain">arguments</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;https://api.github.com&#39;</span>

    <span class="l l-Scalar l-Scalar-Plain">app.api_client_sl_connect</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\ApiClient</span>
        <span class="l l-Scalar l-Scalar-Plain">arguments</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;https://connect.sensiolabs.com/api&#39;</span>
</pre></div>
</td></tr></table></div></div>
<p>Это необязательно, но давайте обновим это до конфигурации Symfony 3.3 шаг за шагом, <em>не</em>
сломав наше приложение.</p>
<div class="section" id="defaults">
<h3>Шаг 1): Добавление _defaults<a class="headerlink" href="#defaults" title="Permalink to this headline">¶</a></h3>
<p>Начните с добавления раздела <tt class="docutils literal"><code>_defaults</code></tt> с <tt class="docutils literal"><code>autowire</code></tt> и <tt class="docutils literal"><code>autoconfigure</code></tt>.</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span># app/config/services.yml
services:
<span class="gi">+     _defaults:</span>
<span class="gi">+         autowire: true</span>
<span class="gi">+         autoconfigure: true</span>

    # ...
</pre></div>
</td></tr></table></div></div>
<p>Этот шаг очень простой: вы уже <em>ясно</em> конфигурируете все ваши сервисы. Так что
<tt class="docutils literal"><code>autowire</code></tt> не делает ничего. Вы также уже тегируете все ваши сервисы, так что
<tt class="docutils literal"><code>autoconfigure</code></tt> тоже не изменяет никакие существующие сервисы.</p>
<p>Вы пока ещё не добавили <tt class="docutils literal"><code>public: false</code></tt>. Это случится через минуту.</p>
</div>
<div class="section" id="id6">
<h3>Шаг 2) Использование id сервисов класса<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>На данный момент, id сервисов - это машинные имена, например, <tt class="docutils literal"><code>app.github_notifier</code></tt>.
Чтобы хорошо работать с новой системой конфигурации, ваши id сервисов должны быть именами
класса, кроме тех случаев, когда у вас множество экземпляров одного и того же сервиса.</p>
<p>Начните с обновления id сервисов до имён класса:</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span># app/config/services.yml
services:
    # ...

<span class="gd">-     app.github_notifier:</span>
<span class="gd">-         class: AppBundle\Service\GitHubNotifier</span>
<span class="gi">+     AppBundle\Service\GitHubNotifier:</span>
        arguments:
            - &#39;@app.api_client_github&#39;

<span class="gd">-     markdown_transformer:</span>
<span class="gd">-         class: AppBundle\Service\MarkdownTransformer</span>
<span class="gi">+     AppBundle\Service\MarkdownTransformer: ~</span>

    # оставьте id, так как существует множество экземпляров в классе
    app.api_client_github:
        # ...
    app.api_client_sl_connect:
        # ...
</pre></div>
</td></tr></table></div></div>
<p>Но это изменение сломает наше приложение! Старые id сервисов (например, <tt class="docutils literal"><code>app.github_notifier</code></tt>)
больше не существуют. Самый простой способ исправить это - найти все ваши старые id сервисов,
и обновить их до новых id класса: <tt class="docutils literal"><code>app.github_notifier</code></tt> до <tt class="docutils literal"><code>AppBundle\Service\GitHubNotifier</code></tt>.</p>
<p>В больших проектах есть способ получше: создайте союзнические наследования, которые свяжут старый
id с новым. Создайте файл <tt class="docutils literal"><code>legacy_aliases.yml</code></tt>:</p>
<div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># app/config/legacy_aliases.yml</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="c1"># союзники для того, чтобы к старым id сервисов оставался доступ</span>
    <span class="c1"># удалите их если/когда вы не вызываете их напрямую</span>
    <span class="c1"># из контейнера через $container-&gt;get()</span>
    <span class="l l-Scalar l-Scalar-Plain">app.github_notifier</span><span class="p p-Indicator">:</span> <span class="s">&#39;@AppBundle\Service\GitHubNotifier&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">markdown_transformer</span><span class="p p-Indicator">:</span> <span class="s">&#39;@AppBundle\Service\MarkdownTransformer&#39;</span>
</pre></div>
</td></tr></table></div></div>
<p>Потом, импортируйте это сверху <tt class="docutils literal"><code>services.yml</code></tt>:</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span># app/config/services.yml
<span class="gi">+ imports:</span>
<span class="gi">+     - { resource: legacy_aliases.yml }</span>

# ...
</pre></div>
</td></tr></table></div></div>
<p>Вот и всё! Старые id сервисов всё ещё работают. Позже, (см. шаг по очистке ниже), вы
можете удалить их из своего приложения.</p>
</div>
<div class="section" id="id7">
<h3>Шаг 3) Сделайте сервисы приватными<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Теперь вы готовы сделать так, чтобы все сервисы по умолчанию были приватными:</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span># app/config/services.yml
# ...

services:
     _defaults:
         autowire: true
         autoconfigure: true
<span class="gi">+          public: false</span>
</pre></div>
</td></tr></table></div></div>
<p>Благодаря этому, любые сервисы, созданные в этом файле, не могут быть вызваны напрямую
из контейнера. Однако, так как старые id сервиса являются союзниками в отдельном файле
(<tt class="docutils literal"><code>legacy_aliases.yml</code></tt>), они всё ещё <em>являются</em> публичными. Таким образом приложение
продолжает работать.</p>
<p>Если вы <em>не</em> изменили id некоторых из ваших сервисов (потому что они являются множеством
экземпляров одного класса), вам может понадобиться сделать их публичными:</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span># app/config/services.yml
# ...

services:
    # ...

    app.api_client_github:
        # ...

<span class="gi">+         # удалите это если/когда вы не вызываете это</span>
<span class="gi">+         # напрямую из контейнера через $container-&gt;get()</span>
<span class="gi">+         public: true</span>

    app.api_client_sl_connect:
        # ...
<span class="gi">+         public: true</span>
</pre></div>
</td></tr></table></div></div>
<p>Это для того, чтобы гарантировать, что приложение не сломается. Если вы не вызываете
эти сервисы напрямую из контейнера - это не нужно. Через минуту вы это очистите.</p>
</div>
<div class="section" id="id8">
<h3>Шаг 4) Авторегистрация сервисов<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>Теперь вы готовы автоматически регистрировать все сервисы в <tt class="docutils literal"><code>src/AppBundle/</code></tt>
(и/или любом другом каталоге/пакете, который у вас есть):</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span># app/config/services.yml

services:
    _defaults:
        # ...

<span class="gi">+     AppBundle\:</span>
<span class="gi">+         resource: &#39;../../src/AppBundle/*&#39;</span>
<span class="gi">+         exclude: &#39;../../src/AppBundle/{Entity,Repository}&#39;</span>
<span class="gi">+</span>
<span class="gi">+     AppBundle\Controller\:</span>
<span class="gi">+         resource: &#39;../../src/AppBundle/Controller&#39;</span>
<span class="gi">+         public: true</span>
<span class="gi">+         tags: [&#39;controller.service_arguments&#39;]</span>

    # ...
</pre></div>
</td></tr></table></div></div>
<p>Вот и всё! На самом деле, вы уже переопределяете и переконфигурируете все сервисы,
которые вы используете (<tt class="docutils literal"><code>AppBundle\Service\GitHubNotifier</code></tt> и
<tt class="docutils literal"><code>AppBundle\Service\MarkdownTransformer</code></tt>). Но теперь, вам не нужно будет вручную
регистрировать будущие сервисы.</p>
<p>Ещё раз, существует дополнительное осложнение, если у вас есть множественные сервисы
одного класса:</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span># app/config/services.yml

services:
    # ...

<span class="gi">+     # союзник ApiClient одного из ваших сервисов ниже</span>
<span class="gi">+     # app.api_client_github будет использован для автомонтирования типизирований ApiClient</span>
<span class="gi">+     AppBundle\Service\ApiClient: &#39;@app.api_client_github&#39;</span>

    app.api_client_github:
        # ...
    app.api_client_sl_connect:
        # ...
</pre></div>
</td></tr></table></div></div>
<p>Это гарантирует, что если вы попробуете автоматически смонтировать экземпляр <tt class="docutils literal"><code>ApiClient</code></tt>,
будет использован <tt class="docutils literal"><code>app.api_client_github</code></tt>. Если у вас этого <em>нет</em>, функция авторегистрации
попробует зарегистрировать третий сервис <tt class="docutils literal"><code>ApiClient</code></tt> и исползовать его для автомонтирования
(которое не удастся, так как класс имеет не поддающийся автомонтированию аргумент).</p>
</div>
<div class="section" id="id9">
<h3>Шаг 5) Очистка!<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>Чтобы убедиться в том, что ваше приложение не сломалось, вы проделали излишнюю работу.
Теперь пора немного убраться! Для начала, обновите ваше приложение так, чтобы оно <em>не</em>
использовало старые id сервисов (те, которые в <tt class="docutils literal"><code>legacy_aliases.yml</code></tt>). Это означает
обновление любых аргументов сервиса (например, с <tt class="docutils literal"><code>&#64;app.github_notifier</code></tt> на
<tt class="docutils literal"><code>&#64;AppBundle\Service\GitHubNotifier</code></tt>) и обновление вашего кода так, чтобы он не вызывал
этот сервис напрямую из контейнера. Например:</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gd">-     public function indexAction()</span>
<span class="gi">+     public function indexAction(GitHubNotifier $gitHubNotifier, MarkdownTransformer $markdownTransformer)</span>
    {
<span class="gd">-         // старый способ вызова сервисов</span>
<span class="gd">-         $githubNotifier = $this-&gt;container-&gt;get(&#39;app.github_notifier&#39;);</span>
<span class="gd">-         $markdownTransformer = $this-&gt;container-&gt;get(&#39;markdown_transformer&#39;);</span>

        // ...
    }
</pre></div>
</td></tr></table></div></div>
<p>Как только вы это сделаете, вы можете удалить <tt class="docutils literal"><code>legacy_aliases.yml</code></tt>  и удалить его
импорт. Вы должны сделать то же самое с любыми сервисами, которые вы сделали публичными,
такими как <tt class="docutils literal"><code>app.api_client_github</code></tt> и <tt class="docutils literal"><code>app.api_client_sl_connect</code></tt>. Как только вы
перестанете вызывать их напрямую из контейнера, вы можете удалить метку <tt class="docutils literal"><code>public: true</code></tt>:</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span># app/config/services.yml
services:
    # ...

    app.api_client_github:
        # ...
<span class="gd">-         public: true</span>

    app.api_client_sl_connect:
        # ...
<span class="gd">-         public: true</span>
</pre></div>
</td></tr></table></div></div>
<p>Наконец, вы можете по желанию удалить любые сервисы из <tt class="docutils literal"><code>services.yml</code></tt>, аргументы
которых могут быть автоматически смонтированы. Финальная конфигурация выглядит так:</p>
<div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">_defaults</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">autowire</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">autoconfigure</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">public</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

    <span class="l l-Scalar l-Scalar-Plain">AppBundle\</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="s">&#39;../../src/AppBundle/*&#39;</span>
        <span class="l l-Scalar l-Scalar-Plain">exclude</span><span class="p p-Indicator">:</span> <span class="s">&#39;../../src/AppBundle/{Entity,Repository}&#39;</span>

    <span class="l l-Scalar l-Scalar-Plain">AppBundle\Controller\</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="s">&#39;../../src/AppBundle/Controller&#39;</span>
        <span class="l l-Scalar l-Scalar-Plain">public</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;controller.service_arguments&#39;</span><span class="p p-Indicator">]</span>

    <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\GitHubNotifier</span><span class="p p-Indicator">:</span>
        <span class="c1"># это можно удалить, или я могу быть ясным</span>
        <span class="l l-Scalar l-Scalar-Plain">arguments</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;@app.api_client_github&#39;</span>

    <span class="c1"># союзник ApiClient одного из наших сервисов ниже</span>
    <span class="c1"># app.api_client_github будет использован для автомонтирования типизирований ApiClient</span>
    <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\ApiClient</span><span class="p p-Indicator">:</span> <span class="s">&#39;@app.api_client_github&#39;</span>

    <span class="c1"># оставьте эти id, так как существует множество экземпляров одного класса</span>
    <span class="l l-Scalar l-Scalar-Plain">app.api_client_github</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\ApiClient</span>
        <span class="l l-Scalar l-Scalar-Plain">arguments</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;https://api.github.com&#39;</span>

    <span class="l l-Scalar l-Scalar-Plain">app.api_client_sl_connect</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AppBundle\Service\ApiClient</span>
        <span class="l l-Scalar l-Scalar-Plain">arguments</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&#39;https://connect.sensiolabs.com/api&#39;</span>
</pre></div>
</td></tr></table></div></div>
<p>Теперь вы можете пользоваться преимуществами новых функций в будущем.</p>
</div>
</div>
</div>


            </div>

            
            <div class="navigation">
                <a href="3.3-di-changes.html">« The Symfony 3.3 DI Container Changes Explained (autowiring, _defaults, etc)</a>
                <span class="separator">|</span>
                <a href="alias_private.html">How to Create Service Aliases and Mark Services as Private »</a>
            </div>
            

            <div id="license">
                <p>Эта документация является переводом <a href="http://symfony.com/doc/current/index.html">официальной документации Symfony</a> и предоставляется по свободной лицензии <a rel="license nofollow" href="https://creativecommons.org/licenses/by-sa/3.0/deed.ru">CC BY-SA 3.0</a>.</p>
            </div>
        </div>
    </div>
</div></div>


  </body>
</body></html>