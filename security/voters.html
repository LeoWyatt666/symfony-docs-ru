<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Как использовать избирателей для проверки разрешений данных &mdash; Symfony Framework Documentation  documentation</title>
    
    <link rel="stylesheet" href="../_static/" type="text/css">
    <link rel="stylesheet" href="..\_static\pygments.css" type="text/css">
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <link rel="top" title="Symfony Framework Documentation  documentation" href="..\index.html">
    <link rel="up" title="The Security Component" href="..\components\security.html">
    <link rel="next" title="Security Configuration Reference (SecurityBundle)" href="..\reference\configuration\security.html">
    <link rel="prev" title="Как создавать и подключать пользовательские программы проверки пользователя" href="user_checkers-ru.html">

<link rel="stylesheet" href="..\_assets\app.css?v=8d6d457a0820d7c245bddae16bfd4c75">
<script src="..\_assets\manifest.js?v=d41d8cd98f00b204e980"></script>
<script src="..\_assets\app.js?v=900984040c7cb4dca514"></script>
<style>
    .header__top .container {
        overflow: hidden;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .header__top .header__logo {
        float: left;
    }
    .header__top .header__support {
        float: right;
    }

    .highlight .k, .highlight .gh, .highlight .gp,
    .highlight .gu, .highlight .kc, .highlight .kd,
    .highlight .kn, .highlight .kr, .highlight .nc,
    .highlight .nd, .highlight .ni, .highlight .nl,
    .highlight .nn, .highlight .nt, .highlight .ow,
    .highlight .se { font-weight: normal; }

    .highlight .c, .highlight .cm, .highlight .c1,
    .highlight .sd, .highlight .si { font-style: normal; }

    .doc { background: none; }
    #demo-warning {
        border: 3px dashed #c00;
        padding: 10px;
        margin-bottom: 30px;
    }
    #demo-warning h4 { font-size: 1.7em;font-weight: bold; }
    #demo-warning p { margin-bottom: 0; }
</style>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-107764519-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-107764519-1');
</script>

<!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '250281335689441');
    fbq('track', 'PageView');
</script>
<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=250281335689441&ev=PageView&noscript=1">
<!-- End Facebook Pixel Code -->

<script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://vk.com/js/api/openapi.js?159",t.onload=function(){VK.Retargeting.Init("VK-RTRG-279161-8p6Jv"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><img src="https://vk.com/rtrg?p=VK-RTRG-279161-8p6Jv" style="position:fixed; left:-999px;" alt="">


  </head>
  <body role="document">

<body class="security doc_article doc">

<header>
    <section class="header__top">
        <div class="container">
            <div class="header__logo">
                <a href="..\..\..\index.html">
                    <img src="..\..\..\_images\header-logo.svg" alt="Symfony.com.ua logo">
                </a>
            </div>
            <div class="header__support hidden-xs">
                <a href="http://playtini.ua/" title="Компания Playtini">
                    <img height="69" src="..\..\..\_images\support.png" alt="Symfony is a SensioLabs product">
                </a>
            </div>
        </div>
    </section>
</header>

<div class="container"><div id="page-content">
    <div class="row">
        <div id="sidebar" class="col-sm-3">
            <div id="sidebar-content"><div class="submenu">
    
    
    <ul class="list_submenu list-unstyled">
    
        <li class="first">
            <a href="..\index.html">Главная</a>
        </li>
    
        <li>
            <a href="..\components\index.html">Компоненты</a>
        </li>
    
        <li>
            <a href="..\best_practices\index.html">Лучшие практики</a>
        </li>
    
        <li>
            <a href="..\quick_tour\index.html">Быстрый старт</a>
        </li>
    
        <li>
            <a href="..\reference\index.html">Справочник</a>
        </li>
    
        <li>
            <a href="..\genindex.html">Индекс</a>
        </li>
    
        <li>
            <a href="..\contributing\index.html">Участие</a>
        </li>
    
    </ul>
</div>

                <div class="toc"> 
    <h4>Содержание</h4>
    <div class="toc-content">
        <ul>
<li><a class="reference internal" href="#">Как использовать избирателей для проверки разрешений данных</a><ul>
<li><a class="reference internal" href="#symfony">Как Symfony использует избирателей</a></li>
<li><a class="reference internal" href="#id2">Интерфейс избирателя</a></li>
<li><a class="reference internal" href="#how-to-use-the-voter-in-a-controller">Установка: Проверка доступа в контроллере</a></li>
<li><a class="reference internal" href="#id4">Создание пользовательского избирателя</a></li>
<li><a class="reference internal" href="#declaring-the-voter-as-a-service-ru">Конфигурация избирателя</a></li>
<li><a class="reference internal" href="#id6">Проверка ролей внутри избирателя</a></li>
<li><a class="reference internal" href="#security-voters-change-strategy">Изменение стратегии решений доступа</a></li>
</ul>
</li>
</ul>

    </div>
</div>
                
            </div>

            <div class="ads m-b-30">
                <h2>Вакансии Playtini</h2>
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/php-dev">
                            Middle+ PHP Developer/Symfony
                        </a>
                    </h3>
                    <div><b>Playtini</b> активно поддерживает и развивает свои продукты, и профессионализм команды. И на данный момент в поиске специалиста на позицию <b>«Middle+ PHP Developer/Symfony»,</b> который улучшит качество внутренних сервисов компании и увеличит их количество.</div>
                </div>
                <!--
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/symfony-senior">
                            Senior PHP Developer/Symfony
                        </a>
                    </h3>
                    <div>We are looking for strong, experienced <b>Senior PHP Developer/Symfony.</b> We expect him/her to participate in improving and extending a system built using microservice architecture by means of modern technologies.</div>
                </div>
                -->
                <div class="ad">
                    <h3><a href="http://playtini.ua/careers">
                        Остальные вакансии компании
                        <img src="..\..\..\_images\logo-playtini.png" alt="Playtini">
                    </a></h3>
                </div>
            </div>
        </div>

        <div id="main" class="col-sm-9">
            <ol class="breadcrumb">
                
                <li><a href="..\index.html">Документация</a></li>
                
                <li><a href="..\components\index.html">The Components</a></li>
                
                <li><a href="../components/index-ru.html">The Components</a></li>
                
                <li><a href="..\components\security.html">The Security Component</a></li>
                
                <li class="active">Как использовать избирателей для проверки разрешений данных</li>
            </ol>

            <div class="page">
                
  <div class="section" id="index-0">
<span id="id1"></span><h1>Как использовать избирателей для проверки разрешений данных<a class="headerlink" href="#index-0" title="Permalink to this headline">¶</a></h1>
<p>В Symfony вы можете проверить разрешения на доступ к данным, используя
<a class="reference internal" href="acl.html"><em>модуль СКД</em></a>, что может быть слишком непомерным для
некоторых приложений. Намного более лёгким решением будет работа с пользовательскими
избирателями, которые похожи на простые условные утверждения.</p>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p class="last">Посмотрите на статью <a class="reference internal" href="..\components\security\authorization.html"><em>авторизация</em></a>,
чтобы ещё глубже понять избирателей.</p>
</div></div>
<div class="section" id="symfony">
<h2>Как Symfony использует избирателей<a class="headerlink" href="#symfony" title="Permalink to this headline">¶</a></h2>
<p>Для того, чтобы использовать избирателей, вам нужно понять, как Symfony работает
с ними. Все избиратели вызываются каждый раз, кога вы используете метод <tt class="docutils literal"><code>isGranted()</code></tt>
в проверке авторизации Symfony или вызываете <tt class="docutils literal"><code>denyAccessUnlessGranted</code></tt> в контроллере
(который использует проверку авторизации).</p>
<p>В конечном счёте, Symfony берёт ответы от всех избирателей и принимает окончательное
решение (о том, чтобы разрешить или запретить доступ к ресурсу) в соответствии со
стратегией, определённой в приложении, которая можетбыть:according to the strategy defined
in the application, which can be: утвердительной, консенсусной или единогласной.</p>
<p>Чтобы узнать больше, посмотрите
<a class="reference internal" href="..\components\security\authorization.html#components-security-access-decision-manager"><span>раздел о менеджерах решений доступа</span></a>.</p>
</div>
<div class="section" id="id2">
<h2>Интерфейс избирателя<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Пользовательский избиратель должен реализовывать
<tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/Authorization/Voter/VoterInterface.html" title="Symfony\Component\Security\Core\Authorization\Voter\VoterInterface">VoterInterface</a></code></tt>
или расширять <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/Authorization/Voter/Voter.html" title="Symfony\Component\Security\Core\Authorization\Voter\Voter">Voter</a></code></tt>,
что делает создание избирателя ещё легче.</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">abstract</span> <span class="k">class</span> <span class="nc">Voter</span> <span class="k">implements</span> <span class="nx">VoterInterface</span>
<span class="p">{</span>
    <span class="k">abstract</span> <span class="k">protected</span> <span class="k">function</span> <span class="nf">supports</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">);</span>
    <span class="k">abstract</span> <span class="k">protected</span> <span class="k">function</span> <span class="nf">voteOnAttribute</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nx">TokenInterface</span> <span class="nv">$token</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="how-to-use-the-voter-in-a-controller">
<span id="id3"></span><h2>Установка: Проверка доступа в контроллере<a class="headerlink" href="#how-to-use-the-voter-in-a-controller" title="Permalink to this headline">¶</a></h2>
<p>Представьте, что у вас есть объект <tt class="docutils literal"><code>Post</code></tt> и вам нужно решить, может ли текущий
пользователь <em>редактировать</em> или <em>просматривать</em> объект. В вашем контроллере, вы
проверите доступ со следующим кодом:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/AppBundle/Controller/PostController.php</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">PostController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Route(&quot;/posts/{id}&quot;, name=&quot;post_show&quot;)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// получить объект Post - например, запросить его</span>
        <span class="nv">$post</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

        <span class="c1">// проверить разрешение &quot;просмотра&quot;: вызов всех избирателей</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">denyAccessUnlessGranted</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @Route(&quot;/posts/{id}/edit&quot;, name=&quot;post_edit&quot;)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// получить объект Post - например, запросить его</span>
        <span class="nv">$post</span> <span class="o">=</span> <span class="o">...</span><span class="p">;</span>

        <span class="c1">// проверить разрешение &quot;редактирования&quot;: вызов всех избирателей</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">denyAccessUnlessGranted</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="nv">$post</span><span class="p">);</span>

        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Метод <tt class="docutils literal"><code>denyAccessUnlessGranted()</code></tt> (а также метод <tt class="docutils literal"><code>isGranted()</code></tt>) делает вызов к
системе &quot;избирателей&quot;. Сейчас, ни один избиратель не проголосует о том, может ли
пользователь &quot;просматривать&quot; или &quot;редактировать&quot; <tt class="docutils literal"><code>Post</code></tt>. Но вы можете создать вашего
<em>собственного</em> избирателя, который решает это, используя любую желаемую вами логику.</p>
</div>
<div class="section" id="id4">
<h2>Создание пользовательского избирателя<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Представьте, что логика для решения, может ли пользователь &quot;просматривать&quot; или
&quot;редактировать&quot; объект, достаточно сложная. Например, <tt class="docutils literal"><code>User</code></tt> может всегда
просматривать или редактировать <tt class="docutils literal"><code>Post</code></tt>, который он создал. А если <tt class="docutils literal"><code>Post</code></tt>
отмечен, как &quot;публичный&quot;, то его может просмотреть кто угодно. Избиратель для
этой ситуации будет выглядеть так:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/AppBundle/Security/PostVoter.php</span>
<span class="k">namespace</span> <span class="nx">AppBundle\Security</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">AppBundle\Entity\Post</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">AppBundle\Entity\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Authentication\Token\TokenInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Authorization\Voter\Voter</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PostVoter</span> <span class="k">extends</span> <span class="nx">Voter</span>
<span class="p">{</span>
    <span class="c1">// эти строки были просто выдуманы: вы можете использовать что угодно</span>
    <span class="k">const</span> <span class="no">VIEW</span> <span class="o">=</span> <span class="s1">&#39;view&#39;</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">EDIT</span> <span class="o">=</span> <span class="s1">&#39;edit&#39;</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">supports</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// если это не один из поддерживаемых атрибутов, возвращается false</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">VIEW</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">EDIT</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// голосовать только по объектам Post внутри этого избирателя</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$subject</span> <span class="nx">instanceof</span> <span class="nx">Post</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">voteOnAttribute</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nx">TokenInterface</span> <span class="nv">$token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="na">getUser</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span> <span class="nx">instanceof</span> <span class="nx">User</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// пользователь должен быть в системе; если нет - отказать в доступе</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// вы знаете, что $subject - это объект Post, благодаря поддержке</span>
        <span class="sd">/** @var Post $post */</span>
        <span class="nv">$post</span> <span class="o">=</span> <span class="nv">$subject</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="nv">$attribute</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">self</span><span class="o">::</span><span class="na">VIEW</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canView</span><span class="p">(</span><span class="nv">$post</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
            <span class="k">case</span> <span class="nx">self</span><span class="o">::</span><span class="na">EDIT</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canEdit</span><span class="p">(</span><span class="nv">$post</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\LogicException</span><span class="p">(</span><span class="s1">&#39;This code should not be reached!&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">canView</span><span class="p">(</span><span class="nx">Post</span> <span class="nv">$post</span><span class="p">,</span> <span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// если они могут просматривать, то они могут редактировать</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">canEdit</span><span class="p">(</span><span class="nv">$post</span><span class="p">,</span> <span class="nv">$user</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// обьект Post может иметь, например, метод isPrivate(),</span>
        <span class="c1">// который проверяет булево свойство $private</span>
        <span class="k">return</span> <span class="o">!</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">isPrivate</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">canEdit</span><span class="p">(</span><span class="nx">Post</span> <span class="nv">$post</span><span class="p">,</span> <span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// предполагает, что объект данных имеет метод getOwner(),</span>
        <span class="c1">// чтобы получить сущность пользователя, который владеет этим объектом данных</span>
        <span class="k">return</span> <span class="nv">$user</span> <span class="o">===</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">getOwner</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Вот и всё! Избиратель готов! Далее, <a class="reference internal" href="voters.html#declaring-the-voter-as-a-service"><span>сконфигурируйте его</span></a>.</p>
<p>Чтобы подытожить, вот то, что ожидается от двух абстрактных методов:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><code>Voter::supports($attribute, $subject)</code></tt></dt>
<dd>Когда вызывается <tt class="docutils literal"><code>isGranted()</code></tt> (или <tt class="docutils literal"><code>denyAccessUnlessGranted()</code></tt>), первый аргумент
передаётся как <tt class="docutils literal"><code>$attribute</code></tt> (например, <tt class="docutils literal"><code>ROLE_USER</code></tt>, <tt class="docutils literal"><code>edit</code></tt>), а второй аргумент
(если он есть) - как <tt class="docutils literal"><code>$subject</code></tt> (например, <tt class="docutils literal"><code>null</code></tt>, объект <tt class="docutils literal"><code>Post</code></tt>). Ваша задача -
определить, должен ли ваш избиратель голосовать по комбинации атрибут/субъект. Если вы
вернёте &quot;true&quot;, то <tt class="docutils literal"><code>voteOnAttribute()</code></tt> будет вызван. В обратном случае, ваш избиратель
закончил: какой-то другой избиратель должен это обработать. В этом примере, вы возвращаете
<tt class="docutils literal"><code>true</code></tt>, если атрибут - <tt class="docutils literal"><code>view</code></tt> или <tt class="docutils literal"><code>edit</code></tt>, и если объект - экземпляр <tt class="docutils literal"><code>Post</code></tt>.</dd>
<dt><tt class="docutils literal"><code>voteOnAttribute($attribute, $subject, TokenInterface $token)</code></tt></dt>
<dd>Если вы возвращаете <tt class="docutils literal"><code>true</code></tt> из <tt class="docutils literal"><code>supports()</code></tt>, то вызывается этот метод. Ваша
задача проста: вернуть <tt class="docutils literal"><code>true</code></tt>, чтобы разрешить доступ, и <tt class="docutils literal"><code>false</code></tt>, чтобы его
запретить. <tt class="docutils literal"><code>$token</code></tt> может быть использован, чтобы найти текущий объект пользователя
(если он есть). В этомпримере, вся сложная бизнес-логика включена для того, чтобы
определить доступ.</dd>
</dl>
</div>
<div class="section" id="declaring-the-voter-as-a-service-ru">
<span id="id5"></span><h2>Конфигурация избирателя<a class="headerlink" href="#declaring-the-voter-as-a-service-ru" title="Permalink to this headline">¶</a></h2>
<p>Чтобы внедрить избирателя в слой безопасности, вы должны объявить его, как сервис
и тегировать его с помощью <tt class="docutils literal"><code>security.voter</code></tt>. Но если вы используете
<a class="reference internal" href="..\service_container.html#service-container-services-load-example"><span>конфигурацию services.yml по умолчанию</span></a>,
то это делается за вас автоматически! Когда вы
<a class="reference internal" href="#how-to-use-the-voter-in-a-controller"><span>вызываете isGranted() с просмотром/редактированием и передаёте объект Post</span></a>,
ваш избиратель будет выполнен и вы сможете контролировать доступ.</p>
</div>
<div class="section" id="id6">
<h2>Проверка ролей внутри избирателя<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>Что, если вы хотите вызвать <tt class="docutils literal"><code>isGranted()</code></tt> <em>изнутри</em> вашего избирателя - например,
вы хотите увидеть, имеет ли текущий пользователь  <tt class="docutils literal"><code>ROLE_SUPER_ADMIN</code></tt>. Это возможно
с помощью внедрения <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/Authorization/AccessDecisionManager.html" title="Symfony\Component\Security\Core\Authorization\AccessDecisionManager">AccessDecisionManager</a></code></tt>
в вашего избирателя. Вы можете использовать это для того, чтобы, к примеру, <em>всегда</em>
разрешать доступ пользователю с <tt class="docutils literal"><code>ROLE_SUPER_ADMIN</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/AppBundle/Security/PostVoter.php</span>

<span class="c1">// ...</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Authorization\AccessDecisionManagerInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PostVoter</span> <span class="k">extends</span> <span class="nx">Voter</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">private</span> <span class="nv">$decisionManager</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">AccessDecisionManagerInterface</span> <span class="nv">$decisionManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">decisionManager</span> <span class="o">=</span> <span class="nv">$decisionManager</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">voteOnAttribute</span><span class="p">(</span><span class="nv">$attribute</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nx">TokenInterface</span> <span class="nv">$token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>

        <span class="c1">// ROLE_SUPER_ADMIN может сделать что угодно! Вот это сила!</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">decisionManager</span><span class="o">-&gt;</span><span class="na">decide</span><span class="p">(</span><span class="nv">$token</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;ROLE_SUPER_ADMIN&#39;</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ... вся логика нормального избирателя</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Если вы используете <a class="reference internal" href="..\service_container.html#service-container-services-load-example"><span>конфигурацию services.yml по умолчанию</span></a>,
то вы закончили! Symfony автоматически передаст сервис <tt class="docutils literal"><code>security.access.decision_manager</code></tt>
при инстанциировании вашего избирателя (благодаря автомонтированию).</p>
<p>Вызов <tt class="docutils literal"><code>decide()</code></tt> в <tt class="docutils literal"><code>AccessDecisionManager</code></tt> это по сути то же самое, что
вызов <tt class="docutils literal"><code>isGranted()</code></tt> из контроллера или других мест (просто немного ниже по
уровню, что необходимо для избирателя).</p>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">Если вам нужно проверить доступ к любому сервису не являющемуся избирателем, используйте
сервис <tt class="docutils literal"><code>security.authorization_checker</code></tt> (т.е. типизируйте
<tt class="docutils literal"><code>Symfony\Component\Security\Core\Authorization\AuthorizationCheckerInterface</code></tt>) вместо
сервиса <tt class="docutils literal"><code>security.access.decision_manager</code></tt>, показанного здесь.</p>
</div></div>
</div>
<div class="section" id="security-voters-change-strategy">
<span id="id7"></span><h2>Изменение стратегии решений доступа<a class="headerlink" href="#security-voters-change-strategy" title="Permalink to this headline">¶</a></h2>
<p>Обычно, один избиратель буде голосовать в любое данное время (а остальные будут
&quot;воздерживаться&quot;, что означает, что они вернут <tt class="docutils literal"><code>false</code></tt> из <tt class="docutils literal"><code>supports()</code></tt>). Но
в теории, вы можете заставить несколько избирателей голосоватьпо одному действию
и объекту. Например, представьте, что у вас есть один избиратель, который проверяет,
является ли пользователь членом этого сайта, и второй, который проверяет, чтобы
возраст пользователя был старше 18 лет.</p>
<p>Чтобы обработать эти случаи, менеджер решений доступа использует стратегию
решений доступа. Вы можете сконфигурировать её под ваши потребности. Существует
три доступные стратегии:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><code>affirmative</code></tt> (по умолчанию)</dt>
<dd>Гарантирует доступ, как только есть <em>один</em> избиратель, гарантирующий доступ;</dd>
<dt><tt class="docutils literal"><code>consensus</code></tt></dt>
<dd>Гарантирует доступ, если больше избирателей гарантируют доступ, чем отказывают в нём;</dd>
<dt><tt class="docutils literal"><code>unanimous</code></tt></dt>
<dd>Гарантирует доступ только, если <em>все</em> избиратели гарантируют доступ.</dd>
</dl>
<p>В вышеописанном сценарии, оба избирателя должны гарантировать доступ, чтобы
гарантировать пользователю доступ к чтению записи. В этом случае, стратегия
по умолчанию не валидна, и вместо неё должна быть использована <tt class="docutils literal"><code>unanimous</code></tt>.
Вы можете установить это в конфигурации безопасности:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># app/config/security.yml</span>
<span class="l l-Scalar l-Scalar-Plain">security</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">access_decision_manager</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">strategy</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">unanimous</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- app/config/security.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="nt">&lt;srv:container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/security&quot;</span>
    <span class="na">xmlns:srv=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span>
<span class="nt">&gt;</span>

    <span class="nt">&lt;config&gt;</span>
        <span class="nt">&lt;access-decision-manager</span> <span class="na">strategy=</span><span class="s">&quot;unanimous&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/config&gt;</span>
<span class="nt">&lt;/srv:container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// app/config/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;access_decision_manager&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;strategy&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;unanimous&#39;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
</div>
</div>


            </div>

            
            <div class="navigation">
                <a href="user_checkers-ru.html">« Как создавать и подключать пользовательские программы проверки пользователя</a>
                <span class="separator">|</span>
                <a href="..\reference\configuration\security.html">Security Configuration Reference (SecurityBundle) »</a>
            </div>
            

            <div id="license">
                <p>Эта документация является переводом <a href="http://symfony.com/doc/current/index.html">официальной документации Symfony</a> и предоставляется по свободной лицензии <a rel="license nofollow" href="https://creativecommons.org/licenses/by-sa/3.0/deed.ru">CC BY-SA 3.0</a>.</p>
            </div>
        </div>
    </div>
</div></div>


  </body>
</body></html>