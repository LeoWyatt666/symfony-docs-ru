<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Как работает безопасность access_control? &mdash; Symfony Framework Documentation  documentation</title>
    
    <link rel="stylesheet" href="../_static/" type="text/css">
    <link rel="stylesheet" href="..\_static\pygments.css" type="text/css">
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <link rel="top" title="Symfony Framework Documentation  documentation" href="..\index.html">
    <link rel="up" title="The Security Component" href="..\components\security.html">
    <link rel="next" title="Как создать пользовательский обработчик отказа в доступе" href="access_denied_handler-ru.html">
    <link rel="prev" title="Безопасное генерирование произвольных значений" href="../components/security/secure_tools-ru.html">

<link rel="stylesheet" href="..\_assets\app.css?v=8d6d457a0820d7c245bddae16bfd4c75">
<script src="..\_assets\manifest.js?v=d41d8cd98f00b204e980"></script>
<script src="..\_assets\app.js?v=900984040c7cb4dca514"></script>
<style>
    .header__top .container {
        overflow: hidden;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .header__top .header__logo {
        float: left;
    }
    .header__top .header__support {
        float: right;
    }

    .highlight .k, .highlight .gh, .highlight .gp,
    .highlight .gu, .highlight .kc, .highlight .kd,
    .highlight .kn, .highlight .kr, .highlight .nc,
    .highlight .nd, .highlight .ni, .highlight .nl,
    .highlight .nn, .highlight .nt, .highlight .ow,
    .highlight .se { font-weight: normal; }

    .highlight .c, .highlight .cm, .highlight .c1,
    .highlight .sd, .highlight .si { font-style: normal; }

    .doc { background: none; }
    #demo-warning {
        border: 3px dashed #c00;
        padding: 10px;
        margin-bottom: 30px;
    }
    #demo-warning h4 { font-size: 1.7em;font-weight: bold; }
    #demo-warning p { margin-bottom: 0; }
</style>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-107764519-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-107764519-1');
</script>

<!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '250281335689441');
    fbq('track', 'PageView');
</script>
<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=250281335689441&ev=PageView&noscript=1">
<!-- End Facebook Pixel Code -->

<script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://vk.com/js/api/openapi.js?159",t.onload=function(){VK.Retargeting.Init("VK-RTRG-279161-8p6Jv"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><img src="https://vk.com/rtrg?p=VK-RTRG-279161-8p6Jv" style="position:fixed; left:-999px;" alt="">


  </head>
  <body role="document">

<body class="security doc_article doc">

<header>
    <section class="header__top">
        <div class="container">
            <div class="header__logo">
                <a href="..\..\..\index.html">
                    <img src="..\..\..\_images\header-logo.svg" alt="Symfony.com.ua logo">
                </a>
            </div>
            <div class="header__support hidden-xs">
                <a href="http://playtini.ua/" title="Компания Playtini">
                    <img height="69" src="..\..\..\_images\support.png" alt="Symfony is a SensioLabs product">
                </a>
            </div>
        </div>
    </section>
</header>

<div class="container"><div id="page-content">
    <div class="row">
        <div id="sidebar" class="col-sm-3">
            <div id="sidebar-content"><div class="submenu">
    
    
    <ul class="list_submenu list-unstyled">
    
        <li class="first">
            <a href="..\index.html">Главная</a>
        </li>
    
        <li>
            <a href="..\components\index.html">Компоненты</a>
        </li>
    
        <li>
            <a href="..\best_practices\index.html">Лучшие практики</a>
        </li>
    
        <li>
            <a href="..\quick_tour\index.html">Быстрый старт</a>
        </li>
    
        <li>
            <a href="..\reference\index.html">Справочник</a>
        </li>
    
        <li>
            <a href="..\genindex.html">Индекс</a>
        </li>
    
        <li>
            <a href="..\contributing\index.html">Участие</a>
        </li>
    
    </ul>
</div>

                <div class="toc"> 
    <h4>Содержание</h4>
    <div class="toc-content">
        <ul>
<li><a class="reference internal" href="#">Как работает безопасность access_control?</a><ul>
<li><a class="reference internal" href="#security-access-control-matching-options-ru">1. Опции совпадения</a></li>
<li><a class="reference internal" href="#security-access-control-enforcement-options-ru">2. Форсирование доступа</a></li>
<li><a class="reference internal" href="#access-control-ip">Соответствие access_control по IP</a><ul>
<li><a class="reference internal" href="#security-allow-if-ru">Безопасность по выражению</a></li>
</ul>
</li>
<li><a class="reference internal" href="#http-https">Форсирование канала (http, https)</a></li>
</ul>
</li>
</ul>

    </div>
</div>
                
            </div>

            <div class="ads m-b-30">
                <h2>Вакансии Playtini</h2>
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/php-dev">
                            Middle+ PHP Developer/Symfony
                        </a>
                    </h3>
                    <div><b>Playtini</b> активно поддерживает и развивает свои продукты, и профессионализм команды. И на данный момент в поиске специалиста на позицию <b>«Middle+ PHP Developer/Symfony»,</b> который улучшит качество внутренних сервисов компании и увеличит их количество.</div>
                </div>
                <!--
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/symfony-senior">
                            Senior PHP Developer/Symfony
                        </a>
                    </h3>
                    <div>We are looking for strong, experienced <b>Senior PHP Developer/Symfony.</b> We expect him/her to participate in improving and extending a system built using microservice architecture by means of modern technologies.</div>
                </div>
                -->
                <div class="ad">
                    <h3><a href="http://playtini.ua/careers">
                        Остальные вакансии компании
                        <img src="..\..\..\_images\logo-playtini.png" alt="Playtini">
                    </a></h3>
                </div>
            </div>
        </div>

        <div id="main" class="col-sm-9">
            <ol class="breadcrumb">
                
                <li><a href="..\index.html">Документация</a></li>
                
                <li><a href="..\components\index.html">The Components</a></li>
                
                <li><a href="../components/index-ru.html">The Components</a></li>
                
                <li><a href="..\components\security.html">The Security Component</a></li>
                
                <li class="active">Как работает безопасность access_control?</li>
            </ol>

            <div class="page">
                
  <div class="section" id="access-control">
<h1>Как работает безопасность access_control?<a class="headerlink" href="#access-control" title="Permalink to this headline">¶</a></h1>
<p>Для каждого входящего запроса, Symfony роверяет каждую запись <tt class="docutils literal"><code>access_control</code></tt>, чтобы
найти <em>одну</em>, соответствующую текущему запросу. Как только она находит совпадающую запись
<tt class="docutils literal"><code>access_control</code></tt>, она останавливается - только <strong>первая</strong> совпадающая <tt class="docutils literal"><code>access_control</code></tt>
используется для предоставления доступа.</p>
<p>Каждый <tt class="docutils literal"><code>access_control</code></tt> имеет несколько опций, которые конфигурируют две разных вещи:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="access_control.html#security-access-control-matching-options"><span>должен ли входящий запрос совпадать с этой записью управления доступа</span></a></li>
<li><a class="reference internal" href="access_control.html#security-access-control-enforcement-options"><span>при совпадении, должно ли применяться какое-либо ограничение доступа</span></a>:</li>
</ol>
<div class="section" id="security-access-control-matching-options-ru">
<span id="id1"></span><h2>1. Опции совпадения<a class="headerlink" href="#security-access-control-matching-options-ru" title="Permalink to this headline">¶</a></h2>
<p>Symfony создаёт экземпляр класса <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/HttpFoundation/RequestMatcher.html" title="Symfony\Component\HttpFoundation\RequestMatcher">RequestMatcher</a></code></tt>
для каждой записи <tt class="docutils literal"><code>access_control</code></tt>, который определяет должно ли быть использовано данное
управлеие доступом в этом запросе. Слелдующие опции <tt class="docutils literal"><code>access_control</code></tt> используются для
сопоставления:</p>
<ul class="simple">
<li><tt class="docutils literal"><code>path</code></tt></li>
<li><tt class="docutils literal"><code>ip</code></tt> или <tt class="docutils literal"><code>ips</code></tt></li>
<li><tt class="docutils literal"><code>host</code></tt></li>
<li><tt class="docutils literal"><code>methods</code></tt></li>
</ul>
<p>Возьмите следующие записи <tt class="docutils literal"><code>access_control</code></tt> в качестве примера:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/security.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">security</span><span class="p p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l l-Scalar l-Scalar-Plain">access_control</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">path</span><span class="p p-Indicator">:</span> <span class="nv">^/admin</span><span class="p p-Indicator">,</span> <span class="nv">roles</span><span class="p p-Indicator">:</span> <span class="nv">ROLE_USER_IP</span><span class="p p-Indicator">,</span> <span class="nv">ip</span><span class="p p-Indicator">:</span> <span class="nv">127.0.0.1</span> <span class="p p-Indicator">}</span>
        <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">path</span><span class="p p-Indicator">:</span> <span class="nv">^/admin</span><span class="p p-Indicator">,</span> <span class="nv">roles</span><span class="p p-Indicator">:</span> <span class="nv">ROLE_USER_HOST</span><span class="p p-Indicator">,</span> <span class="nv">host</span><span class="p p-Indicator">:</span> <span class="nv">symfony\.com$</span> <span class="p p-Indicator">}</span>
        <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">path</span><span class="p p-Indicator">:</span> <span class="nv">^/admin</span><span class="p p-Indicator">,</span> <span class="nv">roles</span><span class="p p-Indicator">:</span> <span class="nv">ROLE_USER_METHOD</span><span class="p p-Indicator">,</span> <span class="nv">methods</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">POST</span><span class="p p-Indicator">,</span> <span class="nv">PUT</span><span class="p p-Indicator">]</span> <span class="p p-Indicator">}</span>
        <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">path</span><span class="p p-Indicator">:</span> <span class="nv">^/admin</span><span class="p p-Indicator">,</span> <span class="nv">roles</span><span class="p p-Indicator">:</span> <span class="nv">ROLE_USER</span> <span class="p p-Indicator">}</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/packages/security.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;srv:container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/security&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:srv=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;config&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/admin&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_USER_IP&quot;</span> <span class="na">ip=</span><span class="s">&quot;127.0.0.1&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/admin&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_USER_HOST&quot;</span> <span class="na">host=</span><span class="s">&quot;symfony\.com$&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/admin&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_USER_METHOD&quot;</span> <span class="na">methods=</span><span class="s">&quot;POST, PUT&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/admin&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_USER&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/config&gt;</span>
<span class="nt">&lt;/srv:container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// config/packages/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="c1">// ...</span>
    <span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/admin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_USER_IP&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ip&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/admin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_USER_HOST&#39;</span><span class="p">,</span>
            <span class="s1">&#39;host&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;symfony\.com$&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/admin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_USER_METHOD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;methods&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;POST, PUT&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/admin&#39;</span><span class="p">,</span>
            <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_USER&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Для каждого входящего запроса, Symfony будет решать, какой <tt class="docutils literal"><code>access_control</code></tt>
использовать, основываясь на URI, IP-адресе клиента, имени входящего хоста и
методе запроса. Помните, используется первое совпадающее правило, и если для
записи не указаны <tt class="docutils literal"><code>ip</code></tt>, <tt class="docutils literal"><code>host</code></tt> или <tt class="docutils literal"><code>method</code></tt>, то этот <tt class="docutils literal"><code>access_control</code></tt>
совпадёт с любым <tt class="docutils literal"><code>ip</code></tt>, <tt class="docutils literal"><code>host</code></tt> или <tt class="docutils literal"><code>method</code></tt>:</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%">
<col width="8%">
<col width="8%">
<col width="8%">
<col width="21%">
<col width="1%">
<col width="42%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">URI</th>
<th class="head">IP</th>
<th class="head">ХОСТ</th>
<th class="head">МЕТОД</th>
<th class="head" colspan="2"><tt class="docutils literal"><code>access_control</code></tt></th>
<th class="head">Почему?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><code>/admin/user</code></tt></td>
<td>127.0.0.1</td>
<td>example.com</td>
<td>GET</td>
<td colspan="2">правило #1 (<tt class="docutils literal"><code>ROLE_USER_IP</code></tt>)</td>
<td>URI совпадает с <tt class="docutils literal"><code>path</code></tt>, а IP - с <tt class="docutils literal"><code>ip</code></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><code>/admin/user</code></tt></td>
<td>127.0.0.1</td>
<td>symfony.com</td>
<td>GET</td>
<td colspan="3"><dl class="first last docutils">
<dt>правило #1 (<tt class="docutils literal"><code>ROLE_USER_IP</code></tt>)     | <tt class="docutils literal"><code>path</code></tt> и <tt class="docutils literal"><code>ip</code></tt> всё ещё совпадают. Это также будет</dt>
<dd><div class="first last line-block">
<div class="line">совпадать с записью <tt class="docutils literal"><code>ROLE_USER_HOST</code></tt>, но используется</div>
<div class="line"><em>только</em> <strong>первое</strong> совпадение <tt class="docutils literal"><code>access_control</code></tt>.</div>
</div>
</dd>
</dl>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><code>/admin/user</code></tt></td>
<td>168.0.0.1</td>
<td>symfony.com</td>
<td>GET</td>
<td colspan="3"><dl class="first last docutils">
<dt>правило #2 (<tt class="docutils literal"><code>ROLE_USER_HOST</code></tt>)   | <tt class="docutils literal"><code>ip</code></tt> не совпадает с первым правилом, так что используется</dt>
<dd><div class="first last line-block">
<div class="line">второе (совпадающее) правило.</div>
</div>
</dd>
</dl>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><code>/admin/user</code></tt></td>
<td>168.0.0.1</td>
<td>symfony.com</td>
<td>POST</td>
<td colspan="2">правило #2 (<tt class="docutils literal"><code>ROLE_USER_HOST</code></tt>)</td>
<td>Второе правило всё ещё совпадает. Это также будет совпадать
с третьим правилом (<tt class="docutils literal"><code>ROLE_USER_METHOD</code></tt>), но используется
только <strong>первое</strong> совпадение <tt class="docutils literal"><code>access_control</code></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><code>/admin/user</code></tt></td>
<td>168.0.0.1</td>
<td>example.com</td>
<td>POST</td>
<td colspan="2">правило #3 (<tt class="docutils literal"><code>ROLE_USER_METHOD</code></tt>)</td>
<td><tt class="docutils literal"><code>ip</code></tt> и <tt class="docutils literal"><code>host</code></tt> не совпадают с первыми двумя записями, но
совпадают с третьей - <tt class="docutils literal"><code>ROLE_USER_METHOD</code></tt> (она используется).</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><code>/admin/user</code></tt></td>
<td>168.0.0.1</td>
<td>example.com</td>
<td>GET</td>
<td colspan="2">правило #4 (<tt class="docutils literal"><code>ROLE_USER</code></tt>)</td>
<td><tt class="docutils literal"><code>ip</code></tt>, <tt class="docutils literal"><code>host</code></tt> и <tt class="docutils literal"><code>method</code></tt> предотвращают совпадение с
первыми тремя записями. Но так как URI совпадает с шаблоном
<tt class="docutils literal"><code>path</code></tt> записи <tt class="docutils literal"><code>ROLE_USER</code></tt>, она используется.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><code>/foo</code></tt></td>
<td>127.0.0.1</td>
<td>symfony.com</td>
<td>POST</td>
<td colspan="2">не совпадает ни с одной
записью</td>
<td>Не совпадает ни с одним правилом <tt class="docutils literal"><code>access_control</code></tt> так как
его URI не совпадает ни с одним значением <tt class="docutils literal"><code>path</code></tt>.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="security-access-control-enforcement-options-ru">
<span id="id2"></span><h2>2. Форсирование доступа<a class="headerlink" href="#security-access-control-enforcement-options-ru" title="Permalink to this headline">¶</a></h2>
<p>После того, как Symfony решила, какая запись <tt class="docutils literal"><code>access_control</code></tt> совпадает (если таковая есть),
она <em>форсирует</em> ограничения доступа, основанные на опциях <tt class="docutils literal"><code>roles</code></tt>, <tt class="docutils literal"><code>allow_if</code></tt> и <tt class="docutils literal"><code>requires_channel</code></tt>:</p>
<ul class="simple">
<li><tt class="docutils literal"><code>roles</code></tt> Если пользователь не имеет данной(ых) роли(ей), то в доступе
будет отказано (внутренне, вызывается
<tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/Exception/AccessDeniedException.html" title="Symfony\Component\Security\Core\Exception\AccessDeniedException">AccessDeniedException</a></code></tt>);</li>
<li><tt class="docutils literal"><code>allow_if</code></tt> Если выражение возвращает &quot;неверно&quot;, то в доступе будет отказано;</li>
<li><tt class="docutils literal"><code>requires_channel</code></tt> Если канал входящего запроса (например, <tt class="docutils literal"><code>http</code></tt>)
не совпадает с этим значением (например, <tt class="docutils literal"><code>https</code></tt>), пользователь будет
перенаправлен (например, перенаправлен с <tt class="docutils literal"><code>http</code></tt> на <tt class="docutils literal"><code>https</code></tt>, или наоборот).</li>
</ul>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p class="last">Если в доступе отказано, система попробует аутентифицировать пользователя,
если это ещё не было сделано (например, перенаправить ползователя на страницу
входа). Если пользователь уже выполил вход, будет показана страница ошибки
403 &quot;доступ запрещён&quot;. Смотрите <a class="reference internal" href="..\controller\error_pages.html"><em>How to Customize Error Pages</em></a>, чтобы узнать
больше.</p>
</div></div>
</div>
<div class="section" id="access-control-ip">
<h2>Соответствие access_control по IP<a class="headerlink" href="#access-control-ip" title="Permalink to this headline">¶</a></h2>
<p>Некоторые ситуации могут возникнуть, когда вам нужна запись <tt class="docutils literal"><code>access_control</code></tt>,
которая совпадает <em>только</em> с запросами, исходящими от какого-то IP-адреса или
их спектра. Например, это <em>может</em> быть использовано, для отказа в доступе к
URL-шаблону для всех запросов, <em>кроме</em> тех, что исходят от внутреннего доверенного
сервера.</p>
<div class="admonition-wrapper">
<div class="caution"></div><div class="admonition admonition-caution"><p class="first admonition-title">Caution</p>
<p class="last">Как вы прочтёте в объяснении под примером, опция <tt class="docutils literal"><code>ips</code></tt> не ограничивается
конкретным IP-адресом. Вместо этого, использование ключа <tt class="docutils literal"><code>ips</code></tt> означает,
что запись <tt class="docutils literal"><code>access_control</code></tt> будет совпадать только с этим IP-адресом, а
пользователи, получающие доступ к ней с других IP-адресов, будут идти дальше
по списку <tt class="docutils literal"><code>access_control</code></tt>.</p>
</div></div>
<p>Вот пример того, как вы можете сконфигурировать некоторый шаблон URL <tt class="docutils literal"><code>/internal*</code></tt> так,
чтобы он был доступен только по запросам с локального сервера:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/security.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">security</span><span class="p p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l l-Scalar l-Scalar-Plain">access_control</span><span class="p p-Indicator">:</span>
        <span class="c1">#</span>
        <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">path</span><span class="p p-Indicator">:</span> <span class="nv">^/internal</span><span class="p p-Indicator">,</span> <span class="nv">roles</span><span class="p p-Indicator">:</span> <span class="nv">IS_AUTHENTICATED_ANONYMOUSLY</span><span class="p p-Indicator">,</span> <span class="nv">ips</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">127.0.0.1</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">::</span><span class="nv">1</span><span class="p p-Indicator">]</span> <span class="p p-Indicator">}</span>
        <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">path</span><span class="p p-Indicator">:</span> <span class="nv">^/internal</span><span class="p p-Indicator">,</span> <span class="nv">roles</span><span class="p p-Indicator">:</span> <span class="nv">ROLE_NO_ACCESS</span> <span class="p p-Indicator">}</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/packages/security.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;srv:container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/security&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:srv=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;config&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/internal&quot;</span>
            <span class="na">role=</span><span class="s">&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;</span>
            <span class="na">ips=</span><span class="s">&quot;127.0.0.1, ::1&quot;</span>
        <span class="nt">/&gt;</span>

        <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/internal&quot;</span> <span class="na">role=</span><span class="s">&quot;ROLE_NO_ACCESS&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/config&gt;</span>
<span class="nt">&lt;/srv:container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// config/packages/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="c1">// ...</span>
    <span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/internal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;IS_AUTHENTICATED_ANONYMOUSLY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ips&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1, ::1&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/internal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ROLE_NO_ACCESS&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Вот, как это работает, когда путь - <tt class="docutils literal"><code>/internal/something</code></tt> исходит от внешнего
IP-адреса <tt class="docutils literal"><code>10.0.0.1</code></tt>:</p>
<ul class="simple">
<li>Первое правило контроля доступа игнорируется, так как <tt class="docutils literal"><code>path</code></tt> совпадает, но
IP-адреса не совпадают ни с одним из перечисленных IP;</li>
<li>Включается второе правило контроля доступа (единственное ограничение -
<tt class="docutils literal"><code>path</code></tt>) и оно совпадает. Если вы убедитесь в том, что ни один пользователь
не имеет <tt class="docutils literal"><code>ROLE_NO_ACCESS</code></tt>, то в доступе будет отказано (<tt class="docutils literal"><code>ROLE_NO_ACCESS</code></tt>
может быть чем угодно, что не совпадает с существующей ролью, оно просто служит
способом всегда отказывать в доступе).</li>
</ul>
<p>Но если тот же запрос поступит от <tt class="docutils literal"><code>127.0.0.1</code></tt> или <tt class="docutils literal"><code>::1</code></tt> (адрес обратной
связи IPv6):</p>
<ul class="simple">
<li>Теперь, первое правило контроля доступа включается, так как совпадает и
<tt class="docutils literal"><code>path</code></tt> и <tt class="docutils literal"><code>ip</code></tt>: доступ разрешён, так как пользователь всегда имеет роль
<tt class="docutils literal"><code>IS_AUTHENTICATED_ANONYMOUSLY</code></tt>.</li>
<li>Второе правило контроля доступа не рассматривается, так как совпало первое.</li>
</ul>
<div class="section" id="security-allow-if-ru">
<span id="id3"></span><h3>Безопасность по выражению<a class="headerlink" href="#security-allow-if-ru" title="Permalink to this headline">¶</a></h3>
<p>Когда запись <tt class="docutils literal"><code>access_control</code></tt> совпадает, вы можете отказать в доступе через ключ
<tt class="docutils literal"><code>roles</code></tt> или использовать более сложную логику с выражением в ключе <tt class="docutils literal"><code>allow_if</code></tt>:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/security.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">security</span><span class="p p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l l-Scalar l-Scalar-Plain">access_control</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span>
            <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">^/_internal/secure</span>
            <span class="l l-Scalar l-Scalar-Plain">allow_if</span><span class="p p-Indicator">:</span> <span class="s">&quot;&#39;127.0.0.1&#39;</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">request.getClientIp()</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">has_role(&#39;ROLE_ADMIN&#39;)&quot;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">&lt;access-control&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/_internal/secure&quot;</span>
        <span class="na">allow-if=</span><span class="s">&quot;&#39;127.0.0.1&#39; == request.getClientIp() or has_role(&#39;ROLE_ADMIN&#39;)&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/access-control&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/_internal/secure&#39;</span><span class="p">,</span>
        <span class="s1">&#39;allow_if&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&quot;127.0.0.1&quot; == request.getClientIp() or has_role(&quot;ROLE_ADMIN&quot;)&#39;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">),</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>В этом случае, когда пользователь пытается получить доступ к любому URL,
начинающемуся с <tt class="docutils literal"><code>/_internal/secure</code></tt>, он его получит только, если IP-адрес
- <tt class="docutils literal"><code>127.0.0.1</code></tt>, или если он имеет роль <tt class="docutils literal"><code>ROLE_ADMIN</code></tt>.</p>
<p>Внутри выражения, у вас есть доступ к нескольким разным переменным и функциям,
включая <tt class="docutils literal"><code>request</code></tt>, которая является объектом Symfony
<tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/HttpFoundation/Request.html" title="Symfony\Component\HttpFoundation\Request">Request</a></code></tt> (смотрите
<a class="reference internal" href="..\components\http_foundation.html#component-http-foundation-request"><span>Request</span></a>).</p>
<p>Чтобы увидеть список других функций и переменных, смотрите
<a class="reference internal" href="expressions.html#security-expression-variables"><span>functions and variables</span></a>.</p>
</div>
</div>
<div class="section" id="http-https">
<h2>Форсирование канала (http, https)<a class="headerlink" href="#http-https" title="Permalink to this headline">¶</a></h2>
<p>Вы также можете обязать пользователя получать доступ к URL через SSL; просто
используйте аргумент <tt class="docutils literal"><code>requires_channel</code></tt> в любых записях <tt class="docutils literal"><code>access_control</code></tt>.
Если <tt class="docutils literal"><code>access_control</code></tt> совпадёт, и запрос использует канал <tt class="docutils literal"><code>http</code></tt>, то пользователь
будет перенаправлен на <tt class="docutils literal"><code>https</code></tt>:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/security.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">security</span><span class="p p-Indicator">:</span>
    <span class="c1"># ...</span>
    <span class="l l-Scalar l-Scalar-Plain">access_control</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">path</span><span class="p p-Indicator">:</span> <span class="nv">^/cart/checkout</span><span class="p p-Indicator">,</span> <span class="nv">roles</span><span class="p p-Indicator">:</span> <span class="nv">IS_AUTHENTICATED_ANONYMOUSLY</span><span class="p p-Indicator">,</span> <span class="nv">requires_channel</span><span class="p p-Indicator">:</span> <span class="nv">https</span> <span class="p p-Indicator">}</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/packages/security.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;srv:container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/security&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:srv=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;rule</span> <span class="na">path=</span><span class="s">&quot;^/cart/checkout&quot;</span>
        <span class="na">role=</span><span class="s">&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;</span>
        <span class="na">requires-channel=</span><span class="s">&quot;https&quot;</span>
    <span class="nt">/&gt;</span>
<span class="nt">&lt;/srv:container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// config/packages/security.php</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;access_control&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;^/cart/checkout&#39;</span><span class="p">,</span>
            <span class="s1">&#39;role&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;IS_AUTHENTICATED_ANONYMOUSLY&#39;</span><span class="p">,</span>
            <span class="s1">&#39;requires_channel&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;https&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
</div>
</div>


            </div>

            
            <div class="navigation">
                <a href="../components/security/secure_tools-ru.html">« Безопасное генерирование произвольных значений</a>
                <span class="separator">|</span>
                <a href="access_denied_handler-ru.html">Как создать пользовательский обработчик отказа в доступе »</a>
            </div>
            

            <div id="license">
                <p>Эта документация является переводом <a href="http://symfony.com/doc/current/index.html">официальной документации Symfony</a> и предоставляется по свободной лицензии <a rel="license nofollow" href="https://creativecommons.org/licenses/by-sa/3.0/deed.ru">CC BY-SA 3.0</a>.</p>
            </div>
        </div>
    </div>
</div></div>


  </body>
</body></html>