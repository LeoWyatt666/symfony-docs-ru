<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Как загружать пользователей безопасности из БД (поставщик сущностей) &mdash; Symfony Framework Documentation  documentation</title>
    
    <link rel="stylesheet" href="../_static/" type="text/css">
    <link rel="stylesheet" href="..\_static\pygments.css" type="text/css">
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <link rel="top" title="Symfony Framework Documentation  documentation" href="..\index.html">
    <link rel="up" title="The Security Component" href="..\components\security.html">
    <link rel="next" title="Security: Complex Access Controls with Expressions" href="expressions.html">
    <link rel="prev" title="Как создать пользовательского поставщика пользователей" href="custom_provider-ru.html">

<link rel="stylesheet" href="..\_assets\app.css?v=8d6d457a0820d7c245bddae16bfd4c75">
<script src="..\_assets\manifest.js?v=d41d8cd98f00b204e980"></script>
<script src="..\_assets\app.js?v=900984040c7cb4dca514"></script>
<style>
    .header__top .container {
        overflow: hidden;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .header__top .header__logo {
        float: left;
    }
    .header__top .header__support {
        float: right;
    }

    .highlight .k, .highlight .gh, .highlight .gp,
    .highlight .gu, .highlight .kc, .highlight .kd,
    .highlight .kn, .highlight .kr, .highlight .nc,
    .highlight .nd, .highlight .ni, .highlight .nl,
    .highlight .nn, .highlight .nt, .highlight .ow,
    .highlight .se { font-weight: normal; }

    .highlight .c, .highlight .cm, .highlight .c1,
    .highlight .sd, .highlight .si { font-style: normal; }

    .doc { background: none; }
    #demo-warning {
        border: 3px dashed #c00;
        padding: 10px;
        margin-bottom: 30px;
    }
    #demo-warning h4 { font-size: 1.7em;font-weight: bold; }
    #demo-warning p { margin-bottom: 0; }
</style>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-107764519-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-107764519-1');
</script>

<!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '250281335689441');
    fbq('track', 'PageView');
</script>
<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=250281335689441&ev=PageView&noscript=1">
<!-- End Facebook Pixel Code -->

<script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://vk.com/js/api/openapi.js?159",t.onload=function(){VK.Retargeting.Init("VK-RTRG-279161-8p6Jv"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><img src="https://vk.com/rtrg?p=VK-RTRG-279161-8p6Jv" style="position:fixed; left:-999px;" alt="">


  </head>
  <body role="document">

<body class="security doc_article doc">

<header>
    <section class="header__top">
        <div class="container">
            <div class="header__logo">
                <a href="..\..\..\index.html">
                    <img src="..\..\..\_images\header-logo.svg" alt="Symfony.com.ua logo">
                </a>
            </div>
            <div class="header__support hidden-xs">
                <a href="http://playtini.ua/" title="Компания Playtini">
                    <img height="69" src="..\..\..\_images\support.png" alt="Symfony is a SensioLabs product">
                </a>
            </div>
        </div>
    </section>
</header>

<div class="container"><div id="page-content">
    <div class="row">
        <div id="sidebar" class="col-sm-3">
            <div id="sidebar-content"><div class="submenu">
    
    
    <ul class="list_submenu list-unstyled">
    
        <li class="first">
            <a href="..\index.html">Главная</a>
        </li>
    
        <li>
            <a href="..\components\index.html">Компоненты</a>
        </li>
    
        <li>
            <a href="..\best_practices\index.html">Лучшие практики</a>
        </li>
    
        <li>
            <a href="..\quick_tour\index.html">Быстрый старт</a>
        </li>
    
        <li>
            <a href="..\reference\index.html">Справочник</a>
        </li>
    
        <li>
            <a href="..\genindex.html">Индекс</a>
        </li>
    
        <li>
            <a href="..\contributing\index.html">Участие</a>
        </li>
    
    </ul>
</div>

                <div class="toc"> 
    <h4>Содержание</h4>
    <div class="toc-content">
        <ul>
<li><a class="reference internal" href="#">Как загружать пользователей безопасности из БД (поставщик сущностей)</a><ul>
<li><a class="reference internal" href="#id2">Вступление</a></li>
<li><a class="reference internal" href="#the-data-model-ru">1) Создайте вашу сущность Пользователя</a><ul>
<li><a class="reference internal" href="#userinterface">Что это за UserInterface?</a></li>
<li><a class="reference internal" href="#id4">Что делают методы сериализации и десериализации?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#security-config-entity-provider-ru">2) Сконфигурируйте безопасность так, чтобы она загружала из вашей сущности</a><ul>
<li><a class="reference internal" href="#id6">Создание вашего первого пользователя</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanceduserinterface">Запрет неактивных пользователей (AdvancedUserInterface)</a></li>
<li><a class="reference internal" href="#authenticating-someone-with-a-custom-entity-provider-ru">Исползование пользовательского запроса для загрузки пользователя</a></li>
<li><a class="reference internal" href="#security-serialize-equatable-ru">Понимание сериализации и того, как сохраняется пользователь в сессии</a></li>
</ul>
</li>
</ul>

    </div>
</div>
                
            </div>

            <div class="ads m-b-30">
                <h2>Вакансии Playtini</h2>
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/php-dev">
                            Middle+ PHP Developer/Symfony
                        </a>
                    </h3>
                    <div><b>Playtini</b> активно поддерживает и развивает свои продукты, и профессионализм команды. И на данный момент в поиске специалиста на позицию <b>«Middle+ PHP Developer/Symfony»,</b> который улучшит качество внутренних сервисов компании и увеличит их количество.</div>
                </div>
                <!--
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/symfony-senior">
                            Senior PHP Developer/Symfony
                        </a>
                    </h3>
                    <div>We are looking for strong, experienced <b>Senior PHP Developer/Symfony.</b> We expect him/her to participate in improving and extending a system built using microservice architecture by means of modern technologies.</div>
                </div>
                -->
                <div class="ad">
                    <h3><a href="http://playtini.ua/careers">
                        Остальные вакансии компании
                        <img src="..\..\..\_images\logo-playtini.png" alt="Playtini">
                    </a></h3>
                </div>
            </div>
        </div>

        <div id="main" class="col-sm-9">
            <ol class="breadcrumb">
                
                <li><a href="..\index.html">Документация</a></li>
                
                <li><a href="..\components\index.html">The Components</a></li>
                
                <li><a href="../components/index-ru.html">The Components</a></li>
                
                <li><a href="..\components\security.html">The Security Component</a></li>
                
                <li class="active">Как загружать пользователей безопасности из БД (поставщик сущностей)</li>
            </ol>

            <div class="page">
                
  <div class="section" id="index-0">
<span id="id1"></span><h1>Как загружать пользователей безопасности из БД (поставщик сущностей)<a class="headerlink" href="#index-0" title="Permalink to this headline">¶</a></h1>
<p>Система безопасности Symfony может загружать пользователей откуда угодно,
например, из БД через Active Directory или сервер OAuth. Эта статья покажет
вам, как загружать ваших пользователей из БД через сущность Doctrine.</p>
<div class="section" id="id2">
<h2>Вступление<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Загрузка пользователей через сущность Doctrine имеет 2 базовых шага:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="entity_provider.html#security-crete-user-entity"><span>Создайте вашу сущность Пользователя</span></a></li>
<li><a class="reference internal" href="entity_provider.html#security-config-entity-provider"><span>Сконфигурируйте security.yaml так, чтобы он загружал из вашей сущности</span></a></li>
</ol>
<p>После этого, вы можете узнать больше о <a class="reference internal" href="entity_provider.html#security-advanced-user-interface"><span>запрете неактивных пользователей</span></a>,
<a class="reference internal" href="entity_provider.html#authenticating-someone-with-a-custom-entity-provider"><span>использовании пользовательского запроса</span></a>
и <a class="reference internal" href="entity_provider.html#security-serialize-equatable"><span>сериализации пользователя в сессии</span></a></p>
</div>
<div class="section" id="the-data-model-ru">
<span id="security-crete-user-entity-ru"></span><span id="id3"></span><h2>1) Создайте вашу сущность Пользователя<a class="headerlink" href="#the-data-model-ru" title="Permalink to this headline">¶</a></h2>
<p>До того, как вы начнёте, для начала убедитесь, что вы установили компонент
Безопасность:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> composer require security
</pre></div>
</td></tr></table></div></div>
<p>Для этой записи, представьте, что у вас уже есть сущность <tt class="docutils literal"><code>User</code></tt>
со следующими полями: <tt class="docutils literal"><code>id</code></tt>, <tt class="docutils literal"><code>username</code></tt>, <tt class="docutils literal"><code>password</code></tt>, <tt class="docutils literal"><code>email</code></tt>
и <tt class="docutils literal"><code>isActive</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/User.php</span>
<span class="k">namespace</span> <span class="nx">App\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\User\UserInterface</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Table(name=&quot;app_users&quot;)</span>
<span class="sd"> * @ORM\Entity(repositoryClass=&quot;App\Repository\UserRepository&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">User</span> <span class="k">implements</span> <span class="nx">UserInterface</span><span class="p">,</span> <span class="nx">\Serializable</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     * @ORM\Id</span>
<span class="sd">     * @ORM\GeneratedValue(strategy=&quot;AUTO&quot;)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;, length=25, unique=true)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$username</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;, length=64)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$password</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;, length=60, unique=true)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$email</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(name=&quot;is_active&quot;, type=&quot;boolean&quot;)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$isActive</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isActive</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="c1">// может не понадобиться, см. раздел о соли ниже</span>
        <span class="c1">// $this-&gt;salt = md5(uniqid(&#39;&#39;, true));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUsername</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSalt</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// вам *может* понадобиться настоящая соль в зависимости от вашего кодировщика</span>
        <span class="c1">// см. раздел о соли ниже</span>
        <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getPassword</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRoles</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;ROLE_USER&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">eraseCredentials</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="sd">/** @see \Serializable::serialize() */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">serialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">,</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">,</span>
            <span class="c1">// см. раздел о соли ниже</span>
            <span class="c1">// $this-&gt;salt,</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="sd">/** @see \Serializable::unserialize() */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">unserialize</span><span class="p">(</span><span class="nv">$serialized</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">list</span> <span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">,</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">,</span>
            <span class="c1">// см. раздел о соли ниже</span>
            <span class="c1">// $this-&gt;salt</span>
        <span class="p">)</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$serialized</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Чтобы немного всё скоратить, некоторые из геттер и сеттер методов не показаны.
Но вы можете сгенерировать их вручную или с помощью вашего собственного IDE.</p>
<p>Далее, не забудьте <a class="reference internal" href="..\doctrine.html#doctrine-creating-the-database-tables-schema"><span>создатьтаблицу БД</span></a>:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:migrations:diff
</pre></div>
</td></tr></table></div></div>
<div class="section" id="userinterface">
<h3>Что это за UserInterface?<a class="headerlink" href="#userinterface" title="Permalink to this headline">¶</a></h3>
<p>До этих пор, это просто обычная сущность. Но для того, чтобы использовать
этот класс в системе безопасности, она должна реализовывать
<tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/UserInterface.html" title="Symfony\Component\Security\Core\User\UserInterface">UserInterface</a></code></tt>. Это
принуждает класс к тому, чтобы он имел пять следующих методов:</p>
<ul class="simple">
<li><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/UserInterface.html#method_getRoles" title="Symfony\Component\Security\Core\User\UserInterface::getRoles()">getRoles()</a></code></tt></li>
<li><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/UserInterface.html#method_getPassword" title="Symfony\Component\Security\Core\User\UserInterface::getPassword()">getPassword()</a></code></tt></li>
<li><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/UserInterface.html#method_getSalt" title="Symfony\Component\Security\Core\User\UserInterface::getSalt()">getSalt()</a></code></tt></li>
<li><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/UserInterface.html#method_getUsername" title="Symfony\Component\Security\Core\User\UserInterface::getUsername()">getUsername()</a></code></tt></li>
<li><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/UserInterface.html#method_eraseCredentials" title="Symfony\Component\Security\Core\User\UserInterface::eraseCredentials()">eraseCredentials()</a></code></tt></li>
</ul>
<p>Чтобы узнать больше о каждом из них, смотрите <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/UserInterface.html" title="Symfony\Component\Security\Core\User\UserInterface">UserInterface</a></code></tt>.</p>
<div class="admonition-wrapper">
<div class="caution"></div><div class="admonition admonition-caution"><p class="first admonition-title">Caution</p>
<p class="last">Метод <tt class="docutils literal"><code>eraseCredentials()</code></tt> предназначен только для того, чтобы очищать
потенциально сохранённые нешифрованные пароли (или схожую аккредитацию).
Будьте осторожны с тем, что удаляете, если ваш класс пользователя также
связан с базой данных, так как изменённый объект скорее всего будет
сохраняться во время запроса.</p>
</div></div>
</div>
<div class="section" id="id4">
<h3>Что делают методы сериализации и десериализации?<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>В конце каждого запроса, объект User сериализуется в сессии. В следующем
запросе он десериализуется. Чтобы помочь PHP делать это правильно, вам нужно
реализовать <tt class="docutils literal"><code>Serializable</code></tt>. Но вам не нужно сериализовать всё: вам нужно
только несколько полей (те, что показаны выше плюс несколько дополнительных,
если вы добавляли другие важные поля к вашей сущности пользователя). По каждому
запросу, используется <tt class="docutils literal"><code>id</code></tt>, чтобы запросить свежий объект <tt class="docutils literal"><code>User</code></tt> из БД.</p>
<p>Хотите знать больше? Смотрите <a class="reference internal" href="entity_provider.html#security-serialize-equatable"><span>Understanding serialize and how a User is Saved in the Session</span></a>.</p>
</div>
</div>
<div class="section" id="security-config-entity-provider-ru">
<span id="authenticating-someone-against-a-database-ru"></span><span id="id5"></span><h2>2) Сконфигурируйте безопасность так, чтобы она загружала из вашей сущности<a class="headerlink" href="#security-config-entity-provider-ru" title="Permalink to this headline">¶</a></h2>
<p>Теперь, когда у вас есть сущность <tt class="docutils literal"><code>User</code></tt>, реализующая <tt class="docutils literal"><code>UserInterface</code></tt>, вам
просто надо сказать системе безопасности Symfony о ней в <tt class="docutils literal"><code>security.yaml</code></tt>.</p>
<p>В этом примере, пользователь будет вводить своё имя пользователя и пароль
через базовую аутентификацию HTTP. Symfony запросит сущность <tt class="docutils literal"><code>User</code></tt>,
совпадающую с этим именем пользователя и потом проверит парль (больше о
паролях через секунду):</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/security.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">security</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">encoders</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">App\Entity\User</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">algorithm</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">bcrypt</span>

    <span class="c1"># ...</span>

    <span class="l l-Scalar l-Scalar-Plain">providers</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">our_db_provider</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">entity</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">App\Entity\User</span>
                <span class="l l-Scalar l-Scalar-Plain">property</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">username</span>
                <span class="c1"># если вы используете несколько менеджеров сущностей</span>
                <span class="c1"># manager_name: customer</span>

    <span class="l l-Scalar l-Scalar-Plain">firewalls</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">main</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">pattern</span><span class="p p-Indicator">:</span>    <span class="l l-Scalar l-Scalar-Plain">^/</span>
            <span class="l l-Scalar l-Scalar-Plain">http_basic</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">~</span>
            <span class="l l-Scalar l-Scalar-Plain">provider</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">our_db_provider</span>

    <span class="c1"># ...</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/packages/security.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;srv:container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/security&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:srv=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;config&gt;</span>
        <span class="nt">&lt;encoder</span> <span class="na">class=</span><span class="s">&quot;App\Entity\User&quot;</span> <span class="na">algorithm=</span><span class="s">&quot;bcrypt&quot;</span> <span class="nt">/&gt;</span>

        <span class="c">&lt;!-- ... --&gt;</span>

        <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">&quot;our_db_provider&quot;</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- если вы используете несколько менеджеров сущностей, добавьте:</span>
<span class="c">                 manager-name=&quot;customer&quot; --&gt;</span>
            <span class="nt">&lt;entity</span> <span class="na">class=</span><span class="s">&quot;App\Entity\User&quot;</span> <span class="na">property=</span><span class="s">&quot;username&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/provider&gt;</span>

        <span class="nt">&lt;firewall</span> <span class="na">name=</span><span class="s">&quot;main&quot;</span> <span class="na">pattern=</span><span class="s">&quot;^/&quot;</span> <span class="na">provider=</span><span class="s">&quot;our_db_provider&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;http-basic</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/firewall&gt;</span>

        <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;/config&gt;</span>
<span class="nt">&lt;/srv:container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// config/packages/security.php</span>
<span class="k">use</span> <span class="nx">App\Entity\User</span><span class="p">;</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;encoders&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="nx">User</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;algorithm&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bcrypt&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>

    <span class="c1">// ...</span>

    <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;our_db_provider&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;entity&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;class&#39;</span>    <span class="o">=&gt;</span> <span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
                <span class="s1">&#39;property&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="s1">&#39;firewalls&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;main&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;pattern&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;^/&#39;</span><span class="p">,</span>
            <span class="s1">&#39;http_basic&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>
            <span class="s1">&#39;provider&#39;</span>   <span class="o">=&gt;</span> <span class="s1">&#39;our_db_provider&#39;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>

    <span class="c1">// ...</span>
<span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Во-первых, раздел <tt class="docutils literal"><code>encoders</code></tt> сообщает Symfony ожидать, что пароли в БД
будут зашифрованы с использоваием <tt class="docutils literal"><code>bcrypt</code></tt>. Во-вторых, раздел <tt class="docutils literal"><code>providers</code></tt>
создаёт &quot;поставщика пользователя&quot; под названием <tt class="docutils literal"><code>our_db_provider</code></tt>, который
знает, что надо запросить из вашей сущности <tt class="docutils literal"><code>App\Entity\User</code></tt> по свойству
<tt class="docutils literal"><code>username</code></tt>. Имя <tt class="docutils literal"><code>our_db_provider</code></tt> не важно: оно просто должно совпадать со
значением ключа <tt class="docutils literal"><code>provider</code></tt> в вашем брандмауэре. Или, если вы не хотите
устанавливать ключ <tt class="docutils literal"><code>provider</code></tt> в вашем брандмауэре, то будет автоматически
использован первый &quot;поставщик пользователя&quot;.</p>
<div class="section" id="id6">
<h3>Создание вашего первого пользователя<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Чтобы добавлять пользователей, вы можете реализовать <a class="reference internal" href="..\doctrine\registration_form.html"><em>форму регистрации</em></a>
или добавить некоторые <a class="reference external" href="https://symfony.com/doc/master/bundles/DoctrineFixturesBundle/index.html">fixtures</a>. Это просто обычная сущность, так что нет
ничего сложного <em>кроме</em> того, что вам нужно зашифровать пароль каждого пользователя.
Но не волнуйтесь, Symfony предоставляет вам сервис, который сделает это за вас.
Смотрите <a class="reference internal" href="password_encoding.html"><em>How to Manually Encode a Password</em></a>, чтобы узнать детали.</p>
<p>Ниже вы можете увидеть экспорт таблицы <tt class="docutils literal"><code>app_users</code></tt> из MySQL с пользователем <tt class="docutils literal"><code>admin</code></tt>
и паролем <tt class="docutils literal"><code>admin</code></tt> (который был зашифрован).</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> mysql&gt; SELECT * FROM app_users<span class="p">;</span>
<span class="go">+----+------------------+--------------------------------------------------------------+--------------------+-----------+</span>
<span class="go">| id | имя пользователя | пароль                                                       | email              | is_active |</span>
<span class="go">+----+------------------+--------------------------------------------------------------+--------------------+-----------+</span>
<span class="go">|  1 | admin            | $2a$08$jHZj/wJfcVKlIwr5AvR78euJxYK7Ku5kURNhNx.7.CSIJ3Pq6LEPC | <a href="..\..\..\cdn-cgi\l\email-protection.html" class="__cf_email__" data-cfemail="49282d242027092c31282439252c672a2624">[email&#160;protected]</a>  |         1 |</span>
<span class="go">+----+------------------+--------------------------------------------------------------+--------------------+-----------+</span>
</pre></div>
</td></tr></table></div></div>
<div class="admonition-wrapper">
<div class="sidebar"></div><div class="admonition admonition-sidebar"><p class="first sidebar-title">Нужно ли вам использовать свойство Salt?</p>
<p class="last">Если вы используете <tt class="docutils literal"><code>bcrypt</code></tt> или <tt class="docutils literal"><code>argon2i</code></tt>, то нет. В других случаях - да.
Все пароли должны быть хешированы с солью, но <tt class="docutils literal"><code>bcrypt</code></tt> и <tt class="docutils literal"><code>argon2i</code></tt> делают
это внутренне. Так как этот туториал <em>использует</em> <tt class="docutils literal"><code>bcrypt</code></tt>, метод <tt class="docutils literal"><code>getSalt()</code></tt>
в <tt class="docutils literal"><code>User</code></tt> может просто вернуть <tt class="docutils literal"><code>null</code></tt> (не используется). Если вы используете
другой алгоритм, вам нужно будет убрать комментарии из строк <tt class="docutils literal"><code>salt</code></tt> в сущности
<tt class="docutils literal"><code>User</code></tt> и добавить сохранённое свойство <tt class="docutils literal"><code>salt</code></tt>.</p>
</div></div>
</div>
</div>
<div class="section" id="advanceduserinterface">
<span id="security-advanced-user-interface-ru"></span><h2>Запрет неактивных пользователей (AdvancedUserInterface)<a class="headerlink" href="#advanceduserinterface" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified">New in version 4.1: </span>Класс <tt class="docutils literal"><code>AdvancedUserInterface</code></tt> устарел в Symfony 4.1 и альтернативы предоставлено
не было. Если вам нужен этот функционал в вашем приложении, реализуйте
<a class="reference internal" href="user_checkers.html"><em>собственного проверщика пользователя</em></a>, который
выоплняет необходимые проверки.</p>
</div>
<p>Если свойство пользователя <tt class="docutils literal"><code>isActive</code></tt> установлено, как <tt class="docutils literal"><code>false</code></tt> (т.е.
<tt class="docutils literal"><code>is_active</code></tt> равняется 0 в БД), то пользователь всё равно сможет заходить
на сайт нормально. Это легко исправить.</p>
<p>Чтобы исключить неактивных пользователей, измените ваш класс <tt class="docutils literal"><code>User</code></tt>,
чтобы он реализовывал <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/AdvancedUserInterface.html" title="Symfony\Component\Security\Core\User\AdvancedUserInterface">AdvancedUserInterface</a></code></tt>.
Это расширяет <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/UserInterface.html" title="Symfony\Component\Security\Core\User\UserInterface">UserInterface</a></code></tt>,
так что вам нужен только новый интерфейс:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/User.php</span>

<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\User\AdvancedUserInterface</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">implements</span> <span class="nx">AdvancedUserInterface</span><span class="p">,</span> <span class="nx">\Serializable</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isAccountNonExpired</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isAccountNonLocked</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isCredentialsNonExpired</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isEnabled</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isActive</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// сериализация и десериализация должны быть обновлены - см. ниже</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">serialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="c1">// ...</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isActive</span><span class="p">,</span>
        <span class="p">));</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">unserialize</span><span class="p">(</span><span class="nv">$serialized</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">list</span> <span class="p">(</span>
            <span class="c1">// ...</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isActive</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$serialized</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Интерфейс <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/AdvancedUserInterface.html" title="Symfony\Component\Security\Core\User\AdvancedUserInterface">AdvancedUserInterface</a></code></tt>
добавляет четыре дополнительных метода для валидации статуса учётной записи:</p>
<ul class="simple">
<li><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/AdvancedUserInterface.html#method_isAccountNonExpired" title="Symfony\Component\Security\Core\User\AdvancedUserInterface::isAccountNonExpired()">isAccountNonExpired()</a></code></tt>
проверяет, не истёк ли срок годности учётной записи пользователя;</li>
<li><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/AdvancedUserInterface.html#method_isAccountNonLocked" title="Symfony\Component\Security\Core\User\AdvancedUserInterface::isAccountNonLocked()">isAccountNonLocked()</a></code></tt>
проверяет, не закрыт ли пользователь;</li>
<li><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/AdvancedUserInterface.html#method_isCredentialsNonExpired" title="Symfony\Component\Security\Core\User\AdvancedUserInterface::isCredentialsNonExpired()">isCredentialsNonExpired()</a></code></tt>
проверяет, не истёк ли срок годности аккредитации пользователя (пароля);</li>
<li><tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/AdvancedUserInterface.html#method_isEnabled" title="Symfony\Component\Security\Core\User\AdvancedUserInterface::isEnabled()">isEnabled()</a></code></tt>
проверяет, включен ли пользователь.</li>
</ul>
<p>Если <em>любой</em> из них вернёт <tt class="docutils literal"><code>false</code></tt>, ползователю нельзя будет выполнить вход.
Выможете выбрать иметь сохранённые свойства для всех из них, или то, что вам
надо (в этом примере, только <tt class="docutils literal"><code>isActive</code></tt> извлекает из БД).</p>
<p>Так в чём разница между методами? Каждый возвращает слегка разные сообщения об
ошибке (и они могут быть переведены, когда вы отображаете их в вашем шаблоне входа
в систему, чтобы настроить их больше).</p>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">Если вы используете <tt class="docutils literal"><code>AdvancedUserInterface</code></tt>, вам также надо добавить
любые из свойств, используемых этими методами (как <tt class="docutils literal"><code>isActive</code></tt>) к методам
<tt class="docutils literal"><code>serialize()</code></tt> и <tt class="docutils literal"><code>unserialize()</code></tt>. Если вы <em>не</em> сделаете этого, то ваш
пользователь может быть неправильно десериализован из сессии по каждому
запросу.</p>
</div></div>
<p>Поздравляем! Ваша система безопаности загрузки из БД полностью настроена!
Далее, добавьте настоящую <a class="reference internal" href="form_login_setup.html"><em>форму входа</em></a> вместо
базового HTTP или продолжайте читать о других темах.</p>
</div>
<div class="section" id="authenticating-someone-with-a-custom-entity-provider-ru">
<span id="id7"></span><h2>Исползование пользовательского запроса для загрузки пользователя<a class="headerlink" href="#authenticating-someone-with-a-custom-entity-provider-ru" title="Permalink to this headline">¶</a></h2>
<p>Было бы отлично, если бы пользователь мог выполнять вход с помощью имени
пользователя <em>или</em> электронной почты, так как оба уникальны в БД. К сожалению,
родной поставщик сущностей способен обрабатывать запросы только через одно
свйоство пользователя.</p>
<p>Чтобы сделать это, заставьте ваш <tt class="docutils literal"><code>UserRepository</code></tt> реализовывать специальный
<tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Bridge/Doctrine/Security/User/UserLoaderInterface.html" title="Symfony\Bridge\Doctrine\Security\User\UserLoaderInterface">UserLoaderInterface</a></code></tt>. Этот
интерфейс требует только одного метода: <tt class="docutils literal"><code>loadUserByUsername($username)</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/UserRepository.php</span>
<span class="k">namespace</span> <span class="nx">App\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bridge\Doctrine\Security\User\UserLoaderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span> <span class="k">implements</span> <span class="nx">UserLoaderInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">loadUserByUsername</span><span class="p">(</span><span class="nv">$username</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;u.username = :username OR u.email = :email&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nv">$username</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="nv">$username</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="na">getOneOrNullResult</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Чтобы завершить это, просто удалите ключ <tt class="docutils literal"><code>property</code></tt> из поставщика пользователя
в <tt class="docutils literal"><code>security.yaml</code></tt>:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/packages/security.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">security</span><span class="p p-Indicator">:</span>
    <span class="c1"># ...</span>

    <span class="l l-Scalar l-Scalar-Plain">providers</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">our_db_provider</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">entity</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">App\Entity\User</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/packages/security.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;srv:container</span> <span class="na">xmlns=</span><span class="s">&quot;http://symfony.com/schema/dic/security&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:srv=</span><span class="s">&quot;http://symfony.com/schema/dic/services&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://symfony.com/schema/dic/services</span>
<span class="s">        http://symfony.com/schema/dic/services/services-1.0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;config&gt;</span>
        <span class="c">&lt;!-- ... --&gt;</span>

        <span class="nt">&lt;provider</span> <span class="na">name=</span><span class="s">&quot;our_db_provider&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;entity</span> <span class="na">class=</span><span class="s">&quot;App\Entity\User&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/provider&gt;</span>
    <span class="nt">&lt;/config&gt;</span>
<span class="nt">&lt;/srv:container&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>PHP</em><div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// config/packages/security.php</span>
<span class="k">use</span> <span class="nx">App\Entity\User</span><span class="p">;</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;security&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="c1">// ...</span>

    <span class="s1">&#39;providers&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;our_db_provider&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;entity&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Это сообщает Symfony <em>не</em> запрашивать Ползователя автоматически. Вместо этого,
когда кто-то выполняет вход, будет вызван метод <tt class="docutils literal"><code>loadUserByUsername()</code></tt> в
<tt class="docutils literal"><code>UserRepository</code></tt>.</p>
</div>
<div class="section" id="security-serialize-equatable-ru">
<span id="id8"></span><h2>Понимание сериализации и того, как сохраняется пользователь в сессии<a class="headerlink" href="#security-serialize-equatable-ru" title="Permalink to this headline">¶</a></h2>
<p>Если вас интересует важность метода <tt class="docutils literal"><code>serialize()</code></tt> внутри класса <tt class="docutils literal"><code>User</code></tt>,
или то, как объект Пользователя сериализуется или десериализуется, то этот
раздел для вас. Если нет - просто пропустите его.</p>
<p>Когда пользователь выполнил вход, весь объект Пользователя сериализуется в
сессию. По следующему запросу, объект Пользователя десериализуется. Потом,
значение свойства <tt class="docutils literal"><code>id</code></tt> используется для повторного запроса свежего объекта
пользователя из БД. Наконец, свежий объект Пользователя сравнивается с
десериализованным объектом Пользователя, чтобы убедиться, что они представляют
одного пользователя. Например, если <tt class="docutils literal"><code>username</code></tt> в объектах 2 Пользователя не
совпадает по какой-либо причине, то ползователь будет выведен из системы из
соображений безопасности.</p>
<p>Несмотря на то, что всё это происходит автоматически, существует несколько важных
побочных эффектов.</p>
<p>Во-первых, интерфейс <tt class="docutils literal"><code><a class="reference external" href="http://php.net/manual/en/class.serializable.php" title="Serializable">Serializable</a></code></tt> и его методы <tt class="docutils literal"><code>serialize()</code></tt>
и <tt class="docutils literal"><code>unserialize()</code></tt> были добавлены, чтобы разрешить классу <tt class="docutils literal"><code>User</code></tt> быть
сериализованым в сессии. Это может быть не нужно, в зависимости от ваших
настроек, но скорее всего, это хорошая идея. В теории, сериализовать нужно
только <tt class="docutils literal"><code>id</code></tt>, потому что метод <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Bridge/Doctrine/Security/User/EntityUserProvider.html#method_refreshUser" title="Symfony\Bridge\Doctrine\Security\User\EntityUserProvider::refreshUser()">refreshUser()</a></code></tt>
обновляет пользователя по каждому запросу, используя <tt class="docutils literal"><code>id</code></tt> (как объяснялось
выше). Это даёт нам &quot;свежий&quot; объект Пользователя.</p>
<p>Ео Symfony также использует <tt class="docutils literal"><code>username</code></tt>, <tt class="docutils literal"><code>salt</code></tt>, и <tt class="docutils literal"><code>password</code></tt>, чтобы
верифицировать, что Пользователь не изменился между запросами (она также
вызывает ваш метод <tt class="docutils literal"><code>AdvancedUserInterface</code></tt>, если вы его реализуете).
Неудача сериализации может привести к тому, что вы будете выходить из системы
покаждому запросу. Если ваш ползователь реализует
<tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/EquatableInterface.html" title="Symfony\Component\Security\Core\User\EquatableInterface">EquatableInterface</a></code></tt>,
то вместо проврки этих свойств, вызывается ваш <tt class="docutils literal"><code><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/Security/Core/User/EquatableInterface.html#method_isEqualTo" title="Symfony\Component\Security\Core\User\EquatableInterface::isEqualTo()">isEqualTo()</a></code></tt>,
и вы можете проверить те свойства, которые вы хотите. Кроме случаев,
and you can check whatever properties you want. Если вы не понимаете это,
то вы, скорее всего, <em>не</em> будете реализовывать этот интерфейс или беспокоиться
о нём.</p>
</div>
</div>


            </div>

            
            <div class="navigation">
                <a href="custom_provider-ru.html">« Как создать пользовательского поставщика пользователей</a>
                <span class="separator">|</span>
                <a href="expressions.html">Security: Complex Access Controls with Expressions »</a>
            </div>
            

            <div id="license">
                <p>Эта документация является переводом <a href="http://symfony.com/doc/current/index.html">официальной документации Symfony</a> и предоставляется по свободной лицензии <a rel="license nofollow" href="https://creativecommons.org/licenses/by-sa/3.0/deed.ru">CC BY-SA 3.0</a>.</p>
            </div>
        </div>
    </div>
</div></div>


  <script data-cfasync="false" src="..\..\..\cdn-cgi\scripts\5c5dd728\cloudflare-static\email-decode.min.js"></script></body>
</body></html>