<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Базы данных и Doctrine ORM &mdash; Symfony Framework Documentation  documentation</title>
    
    <link rel="stylesheet" href="_static/" type="text/css">
    <link rel="stylesheet" href="_static\pygments.css" type="text/css">
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <link rel="top" title="Symfony Framework Documentation  documentation" href="index.html">

<link rel="stylesheet" href="_assets\app.css?v=8d6d457a0820d7c245bddae16bfd4c75">
<script src="_assets\manifest.js?v=d41d8cd98f00b204e980"></script>
<script src="_assets\app.js?v=900984040c7cb4dca514"></script>
<style>
    .header__top .container {
        overflow: hidden;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    .header__top .header__logo {
        float: left;
    }
    .header__top .header__support {
        float: right;
    }

    .highlight .k, .highlight .gh, .highlight .gp,
    .highlight .gu, .highlight .kc, .highlight .kd,
    .highlight .kn, .highlight .kr, .highlight .nc,
    .highlight .nd, .highlight .ni, .highlight .nl,
    .highlight .nn, .highlight .nt, .highlight .ow,
    .highlight .se { font-weight: normal; }

    .highlight .c, .highlight .cm, .highlight .c1,
    .highlight .sd, .highlight .si { font-style: normal; }

    .doc { background: none; }
    #demo-warning {
        border: 3px dashed #c00;
        padding: 10px;
        margin-bottom: 30px;
    }
    #demo-warning h4 { font-size: 1.7em;font-weight: bold; }
    #demo-warning p { margin-bottom: 0; }
</style>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-107764519-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-107764519-1');
</script>

<!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '250281335689441');
    fbq('track', 'PageView');
</script>
<img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=250281335689441&ev=PageView&noscript=1">
<!-- End Facebook Pixel Code -->

<script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://vk.com/js/api/openapi.js?159",t.onload=function(){VK.Retargeting.Init("VK-RTRG-279161-8p6Jv"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><img src="https://vk.com/rtrg?p=VK-RTRG-279161-8p6Jv" style="position:fixed; left:-999px;" alt="">


  </head>
  <body role="document">

<body class="doctrine-r doc_article doc">

<header>
    <section class="header__top">
        <div class="container">
            <div class="header__logo">
                <a href="..\..\index.html">
                    <img src="..\..\_images\header-logo.svg" alt="Symfony.com.ua logo">
                </a>
            </div>
            <div class="header__support hidden-xs">
                <a href="http://playtini.ua/" title="Компания Playtini">
                    <img height="69" src="..\..\_images\support.png" alt="Symfony is a SensioLabs product">
                </a>
            </div>
        </div>
    </section>
</header>

<div class="container"><div id="page-content">
    <div class="row">
        <div id="sidebar" class="col-sm-3">
            <div id="sidebar-content"><div class="submenu">
    
    
    <ul class="list_submenu list-unstyled">
    
        <li class="first">
            <a href="index.html">Главная</a>
        </li>
    
        <li>
            <a href="components\index.html">Компоненты</a>
        </li>
    
        <li>
            <a href="best_practices\index.html">Лучшие практики</a>
        </li>
    
        <li>
            <a href="quick_tour\index.html">Быстрый старт</a>
        </li>
    
        <li>
            <a href="reference\index.html">Справочник</a>
        </li>
    
        <li>
            <a href="genindex.html">Индекс</a>
        </li>
    
        <li>
            <a href="contributing\index.html">Участие</a>
        </li>
    
    </ul>
</div>

                <div class="toc"> 
    <h4>Содержание</h4>
    <div class="toc-content">
        <ul>
<li><a class="reference internal" href="#">Базы данных и Doctrine ORM</a><ul>
<li><a class="reference internal" href="#doctrine">Установка Doctrine</a><ul>
<li><a class="reference internal" href="#id1">Конфигурация базы данных</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entity">Создание класса сущности (Entity)</a></li>
<li><a class="reference internal" href="#doctrine-adding-mapping-ru">Отображение большего количества полей / колонок</a></li>
<li><a class="reference internal" href="#doctrine-creating-the-database-tables-schema-ru">Миграции: Создание таблиц / схемы базы данных</a></li>
<li><a class="reference internal" href="#id4">Миграции и добавление полей</a><ul>
<li><a class="reference internal" href="#doctrine-generating-getters-and-setters-ru">Создание геттеров и сеттеров</a></li>
<li><a class="reference internal" href="#id6">Сохранение объектов в базе данных</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7">Извлечение объектов из базы данных</a></li>
<li><a class="reference internal" href="#paramconverter">Автоматическое извлечение объектов (ParamConverter)</a></li>
<li><a class="reference internal" href="#id8">Обновление объекта</a></li>
<li><a class="reference internal" href="#id9">Удаление объекта</a></li>
<li><a class="reference internal" href="#doctrine-queries-ru">Запрашивание объектов: Хранилище</a></li>
<li><a class="reference internal" href="#dql-sql">Запрашивание объектов через DQL или SQL</a></li>
<li><a class="reference internal" href="#id11">Конфигурация</a></li>
<li><a class="reference internal" href="#id12">Отношения и ассоциации</a></li>
<li><a class="reference internal" href="#id13">Коррекция пустых данных</a></li>
<li><a class="reference internal" href="#id14">Узнать больше</a></li>
</ul>
</li>
</ul>

    </div>
</div>
                
            </div>

            <div class="ads m-b-30">
                <h2>Вакансии Playtini</h2>
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/php-dev">
                            Middle+ PHP Developer/Symfony
                        </a>
                    </h3>
                    <div><b>Playtini</b> активно поддерживает и развивает свои продукты, и профессионализм команды. И на данный момент в поиске специалиста на позицию <b>«Middle+ PHP Developer/Symfony»,</b> который улучшит качество внутренних сервисов компании и увеличит их количество.</div>
                </div>
                <!--
                <div class="ad m-b-15">
                    <h3>
                        <a href="http://playtini.ua/careers/symfony-senior">
                            Senior PHP Developer/Symfony
                        </a>
                    </h3>
                    <div>We are looking for strong, experienced <b>Senior PHP Developer/Symfony.</b> We expect him/her to participate in improving and extending a system built using microservice architecture by means of modern technologies.</div>
                </div>
                -->
                <div class="ad">
                    <h3><a href="http://playtini.ua/careers">
                        Остальные вакансии компании
                        <img src="..\..\_images\logo-playtini.png" alt="Playtini">
                    </a></h3>
                </div>
            </div>
        </div>

        <div id="main" class="col-sm-9">
            <ol class="breadcrumb">
                
                <li><a href="index.html">Документация</a></li>
                
                <li class="active">Базы данных и Doctrine ORM</li>
            </ol>

            <div class="page">
                
  <div class="section" id="doctrine-orm">
<span id="index-0"></span><h1>Базы данных и Doctrine ORM<a class="headerlink" href="#doctrine-orm" title="Permalink to this headline">¶</a></h1>
<p>Symfony не предоставляет компонента для работы с БД, но <em>предоставляет</em> тесную
интеграцию со сторонней библиотекой под названием <a class="reference external" href="http://www.doctrine-project.org/">Doctrine</a>.</p>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p>Эта статья полностью описывает использование Doctrine ORM. сли вы предпочитаете
использовать чистые запросы БД, см. статью &quot;<a class="reference internal" href="doctrine\dbal.html"><em>How to Use Doctrine DBAL</em></a>&quot;.</p>
<p class="last">Вы также можете сохранять данные в <a class="reference external" href="https://www.mongodb.org/">MongoDB</a>, используя библиотеку Doctrine ODM.
См. документацию &quot;<a class="reference external" href="https://symfony.com/doc/current/bundles/DoctrineMongoDBBundle/index.html">DoctrineMongoDBBundle</a>&quot;.</p>
</div></div>
<div class="section" id="doctrine">
<h2>Установка Doctrine<a class="headerlink" href="#doctrine" title="Permalink to this headline">¶</a></h2>
<p>Для начала, установите Doctrine, а также MakerBundle, который поможет сгенерировать код:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="go">composer require doctrine maker</span>
</pre></div>
</td></tr></table></div></div>
<div class="section" id="id1">
<h3>Конфигурация базы данных<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Информация соединения БД хранится в виде переменной окружения под названием
<tt class="docutils literal"><code>DATABASE_URL</code></tt>. Для разработки вы можете найти и настроить её внутри <tt class="docutils literal"><code>.env</code></tt>:</p>
<div class="literal-block"><div class="highlight-text"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span># .env

# настройте эту строчку!
DATABASE_URL=&quot;mysql://db_user:<a href="..\..\cdn-cgi\l\email-protection.html" class="__cf_email__" data-cfemail="ef8b8db09f8e9c9c98809d8bafdeddd8c1dfc1dfc1de">[email&#160;protected]</a>:3306/db_name&quot;

# для использования sqlite:
# DATABASE_URL=&quot;sqlite:///%kernel.project_dir%/var/app.db&quot;
</pre></div>
</td></tr></table></div></div>
<div class="admonition-wrapper">
<div class="caution"></div><div class="admonition admonition-caution"><p class="first admonition-title">Caution</p>
<p class="last">Если имя пользователя, пароль или имя БД содержат любой символ, считающийся
особенным в URI (например, <tt class="docutils literal"><code>!</code></tt>, <tt class="docutils literal"><code>&#64;</code></tt>, <tt class="docutils literal"><code>$</code></tt>, <tt class="docutils literal"><code>#</code></tt>), то вы должны зашифровать
его. См. <a class="reference external" href="https://www.ietf.org/rfc/rfc3986.txt">RFC 3986</a>, чтобы увидеть весь перечень зарезервированных символов,
или используйте функцию <tt class="docutils literal"><code><a class="reference external" href="http://php.net/manual/en/function.urlencode.php" title="urlencode">urlencode</a></code></tt> для их шифрования.</p>
</div></div>
<p>Теперь, когда ваши параметры соединения установлены, Doctrine может создать для вас
БД <tt class="docutils literal"><code>db_name</code></tt>:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:database:create
</pre></div>
</td></tr></table></div></div>
<p>Существует больше опций в <tt class="docutils literal"><code>config/packages/doctrine.yaml</code></tt>, которые вы можете сконфигурировать,
включая вашу <tt class="docutils literal"><code>server_version</code></tt> (например, 5.7, если вы используете MySQL 5.7), которые могут
повлиять на то, как функционирует Doctrine.</p>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p class="last">Существует множество других команд Doctrine. Запустите <tt class="docutils literal"><code>php bin/console list doctrine</code></tt>,
чтобы увидеть полный список.</p>
</div></div>
</div>
</div>
<div class="section" id="entity">
<h2>Создание класса сущности (Entity)<a class="headerlink" href="#entity" title="Permalink to this headline">¶</a></h2>
<p>Предположим, что вы создаёте приложение, в котором необходимо отображать
товары. Даже не задумываясь о Doctrine или базах данных, вы уже знаете,
что вам необходим объект  <tt class="docutils literal"><code>Product</code></tt>, чтобы представить эти товары. Используйте
команду <tt class="docutils literal"><code>make:entity</code></tt>, чтобы создать этот класс:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console make:entity Product
</pre></div>
</td></tr></table></div></div>
<p>Теперь у вас есть новый файл <tt class="docutils literal"><code>src/Entity/Product.php</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Product.php</span>
<span class="k">namespace</span> <span class="nx">App\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity(repositoryClass=&quot;App\Repository\ProductRepository&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Id</span>
<span class="sd">     * @ORM\GeneratedValue</span>
<span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="c1">// добавьте ваши собственные поля</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Этот класс называется &quot;сущность&quot;, И вскоре вы сможете сохранять и запрашивать
объекты Product в таблице <tt class="docutils literal"><code>product</code></tt> в вашей базе данных.</p>
</div>
<div class="section" id="doctrine-adding-mapping-ru">
<span id="id2"></span><h2>Отображение большего количества полей / колонок<a class="headerlink" href="#doctrine-adding-mapping-ru" title="Permalink to this headline">¶</a></h2>
<p>Каждое свойство в сущности <tt class="docutils literal"><code>Product</code></tt> может быть связано с колонкой в таблице <tt class="docutils literal"><code>product</code></tt>.
Добавляя конфигурацию отображения, Doctrine сможет сохранять объект Товар в таблицу
<tt class="docutils literal"><code>product</code></tt> <em>и</em> запрашивать их таблицы <tt class="docutils literal"><code>product</code></tt> и превращать эти данные в объекты
<tt class="docutils literal"><code>Product</code></tt>:</p>
<img alt="_images/mapping_single_entity.png" class="align-center" src="_images\mapping_single_entity.png">
<p>Давайте дадим классу сущности <tt class="docutils literal"><code>Product</code></tt> ещё три свойства и
свяжем их с колоками в БД. Это обычно делается с помощью аннотаций:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>Annotations</em><div class="literal-block"><div class="highlight-php-annotations"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Product.php</span>
<span class="c1">// ...</span>

<span class="c1">// это утверждение использования необходимо для аннотаций</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Id</span>
<span class="sd">     * @ORM\GeneratedValue</span>
<span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;, length=100)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$name</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;decimal&quot;, scale=2, nullable=true)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$price</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>YAML</em><div class="literal-block"><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># config/doctrine/Product.orm.yml</span>
<span class="l l-Scalar l-Scalar-Plain">App\Entity\Product</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">entity</span>
    <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">integer</span>
            <span class="l l-Scalar l-Scalar-Plain">generator</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{</span> <span class="nv">strategy</span><span class="p p-Indicator">:</span> <span class="nv">AUTO</span> <span class="p p-Indicator">}</span>
    <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
            <span class="l l-Scalar l-Scalar-Plain">length</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
        <span class="l l-Scalar l-Scalar-Plain">price</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">decimal</span>
            <span class="l l-Scalar l-Scalar-Plain">scale</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
            <span class="l l-Scalar l-Scalar-Plain">nullable</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</td></tr></table></div></div>
</li>
<li><em>XML</em><div class="literal-block"><div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">&lt;!-- config/doctrine/Product.orm.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="nt">&lt;doctrine-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="s">        http://doctrine-project.org/schemas/orm/doctrine-mapping.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;App\Entity\Product&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;generator</span> <span class="na">strategy=</span><span class="s">&quot;AUTO&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/id&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">length=</span><span class="s">&quot;100&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;price&quot;</span> <span class="na">type=</span><span class="s">&quot;decimal&quot;</span> <span class="na">scale=</span><span class="s">&quot;2&quot;</span> <span class="na">nullable=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/entity&gt;</span>
<span class="nt">&lt;/doctrine-mapping&gt;</span>
</pre></div>
</td></tr></table></div></div>
</li>
</ul>
</div>
<p>Doctrine поддерживает широкий спектр различных типов полей, каждый с собственными
опциями. Чтобы увидеть полный перечень типов и опций, см. <a class="reference external" href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/basic-mapping.html#property-mapping">документацию типов отображения Doctrine</a>.
Если вы хотите использовать XML вместо аннотаций, добавьте <tt class="docutils literal"><code>type: xml</code></tt> и
<tt class="docutils literal"><code>dir: '%kernel.project_dir%/config/doctrine'</code></tt> в отображения сущностей в вашем файле
<tt class="docutils literal"><code>config/packages/doctrine.yaml</code></tt>.</p>
<div class="admonition-wrapper">
<div class="caution"></div><div class="admonition admonition-caution"><p class="first admonition-title">Caution</p>
<p class="last">Будьте осторожны, чтобы не использовать зарезервированные ключевые слова SQL в
качестве названий колонок вашей таблицы (например, <tt class="docutils literal"><code>GROUP</code></tt> или <tt class="docutils literal"><code>USER</code></tt>). См.
<a class="reference external" href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/basic-mapping.html">документацию зарезериврованных ключевых слов SQL</a> Doctrine, чтобы узнать детали
о том, как их избежать. Или, сконфигурируйте имя таблицы с <tt class="docutils literal"><code>&#64;ORM\Table(name=&quot;groups&quot;)</code></tt>
над классом, или сконфигурируйте названия колонок с опцией <tt class="docutils literal"><code>name=&quot;group_name&quot;</code></tt>.</p>
</div></div>
</div>
<div class="section" id="doctrine-creating-the-database-tables-schema-ru">
<span id="id3"></span><h2>Миграции: Создание таблиц / схемы базы данных<a class="headerlink" href="#doctrine-creating-the-database-tables-schema-ru" title="Permalink to this headline">¶</a></h2>
<p>Класс <tt class="docutils literal"><code>Product</code></tt> полностью сконфигурирован и готов к сохранению таблицы
<tt class="docutils literal"><code>product</code></tt>. Конечно, ваша БД на самом деле ещё не имеет таблицы <tt class="docutils literal"><code>product</code></tt>.
Чтобы добавить её, вы можете использовать <a class="reference external" href="https://github.com/doctrine/DoctrineMigrationsBundle">DoctrineMigrationsBundle</a>, который
уже установлен:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:migrations:diff
</pre></div>
</td></tr></table></div></div>
<p>Если всё сработало, то вы должны увидеть что-то вроде:</p>
<blockquote>
<div>Сгенерирован новый класс миграции в
&quot;/path/to/project/doctrine/src/Migrations/Version20171122151511.php&quot;
из различий схемы.</div></blockquote>
<p>Если вы откроете этот файл, то увидите, что он содержит SQL, необходимый для
обновленя вашей БД! Чтобы запустить этот SQL, выполните ваши миграции:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:migrations:migrate
</pre></div>
</td></tr></table></div></div>
<p>Эта команда выполняет все файлы миграции, которые ещё не были запущены в вашей
БД.</p>
</div>
<div class="section" id="id4">
<h2>Миграции и добавление полей<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Но что, если вам нужно добавить новое свойство поля в <tt class="docutils literal"><code>Product</code></tt>, например, <tt class="docutils literal"><code>description</code></tt>?</p>
<div class="literal-block"><div class="highlight-diff"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>// src/Entity/Product.php
// ...

class Product
{
    // ...

<span class="gi">+     /**</span>
<span class="gi">+      * @ORM\Column(type=&quot;text&quot;)</span>
<span class="gi">+      */</span>
<span class="gi">+     private $description;</span>
}
</pre></div>
</td></tr></table></div></div>
<p>Новое свойство отображено, но ещё не существует в таблице <tt class="docutils literal"><code>product</code></tt>. Не проблема!
Просто сгенерируйте миграцию:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:migrations:diff
</pre></div>
</td></tr></table></div></div>
<p>В этот раз, SQL в сгенерированном файле будет выглядеть так:</p>
<div class="literal-block"><div class="highlight-sql"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">product</span> <span class="k">ADD</span> <span class="n">description</span> <span class="n">LONGTEXT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</pre></div>
</td></tr></table></div></div>
<p>Система миграции <em>умна</em>. Она сравнивает все ваши сущности с текущим состоянием БД
и генерирует необходимый для их синхронизации SQL! Как и раньше, выполните ваши
миграции:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:migrations:migrate
</pre></div>
</td></tr></table></div></div>
<p>Это выполнит только <em>один</em> новый файл миграции, так как DoctrineMigrationsBundle
знает, что первая миграция уже была выполнена ранее. За кулисами, она автоматически
управляет таблицей  <tt class="docutils literal"><code>migration_versions</code></tt>, чтобы следить за этим.</p>
<p>Каждый раз, когда вы вносите изменения в свою схему, запускайте эти две команды,
чтобы сгенерировать миграцию и потом выполнить её. Не забудьте фиксировать файлы
миграции и запускать их выполнение при развёртывании.</p>
<div class="section" id="doctrine-generating-getters-and-setters-ru">
<span id="id5"></span><h3>Создание геттеров и сеттеров<a class="headerlink" href="#doctrine-generating-getters-and-setters-ru" title="Permalink to this headline">¶</a></h3>
<p>Doctrine теперь знает, как сохранять объект <tt class="docutils literal"><code>Product</code></tt> в БД. Но сам класс ещё
бесполезен. Все свойства - <tt class="docutils literal"><code>private</code></tt>, поэтому увидеть данные в них невозможно!</p>
<p>По этой причине, вам нужно создать публичные геттеры и сеттеры для всех полей,
которые вам нужно изменить снаружи класса. Если вы используете IDE вроде PhpStorm,
то он может сгенерировать их за вас. В PhpStorm, поместите ваш курсор где-либо
в классе, а потом перейдите в Код -&gt; Сгенерировать меню и выберите &quot;Геттеры и сеттеры&quot;:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Entity/Product</span>
<span class="c1">// ...</span>

<span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="c1">// all of your properties</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setName</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ... getters &amp; setters for price &amp; description</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p class="last">Обычано вам не нужен метод <tt class="docutils literal"><code>setId()</code></tt>: Doctrine установит его за вас автоматически.</p>
</div></div>
</div>
<div class="section" id="id6">
<h3>Сохранение объектов в базе данных<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Пора сохранить объект <tt class="docutils literal"><code>Product</code></tt> в базе данных! Давайте создадим новый контроллер для
экспериментов:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console make:controller ProductController
</pre></div>
</td></tr></table></div></div>
<p>Внутри контроллера, вы можете создать новый объект <tt class="docutils literal"><code>Product</code></tt>, установить данные
в нём и сохранить его!:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProductController.php</span>
<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="c1">// ...</span>
<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProductController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Route(&quot;/product&quot;, name=&quot;product&quot;)</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// вы можете извлечь EntityManager через $this-&gt;getDoctrine()</span>
        <span class="c1">// или вы можете добавить аргумент в ваше действие: index(EntityManagerInterface $em)</span>
        <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>

        <span class="nv">$product</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Product</span><span class="p">();</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="s1">&#39;Keyboard&#39;</span><span class="p">);</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setPrice</span><span class="p">(</span><span class="mf">19.99</span><span class="p">);</span>
        <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setDescription</span><span class="p">(</span><span class="s1">&#39;Ergonomic and stylish!&#39;</span><span class="p">);</span>

        <span class="c1">// скажите Doctrine, что вы (в итоге) хотите сохранить Товар (пока без запросов)</span>
        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>

        <span class="c1">// на самом деле выполнить запросы (т.е. запрос INSERT)</span>
        <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s1">&#39;Saved new product with id &#39;</span><span class="o">.</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Попробуйте!</p>
<blockquote>
<div><a class="reference external" href="http://localhost:8000/product">http://localhost:8000/product</a></div></blockquote>
<p>Поздравляем! Вы только что создали ваш первый ряд в таблице <tt class="docutils literal"><code>product</code></tt>. Чтобы доказать
это, вы можете запросить БД напрямую:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> php bin/console doctrine:query:sql <span class="s1">&#39;SELECT * FROM product&#39;</span>

<span class="c1"># в системах Windows, не использующих Powershell, запустите эту команду:</span>
<span class="c1"># php bin/console doctrine:query:sql &quot;SELECT * FROM product&quot;</span>
</pre></div>
</td></tr></table></div></div>
<p>Рассмотрите предыдущий пример более детально:</p>
<ul class="simple" id="doctrine-entity-manager-ru">
<li><strong>Строчка 16</strong>  Метод <tt class="docutils literal"><code>$this-&gt;getDoctrine()-&gt;getManager()</code></tt> получает объект Doctrine
<em>менеджер сущностей</em> (entity manager), который является самым важным объектом Doctrine.
Он отвечает за сохранение в базу данных, и получение объектов из базы данных.</li>
<li><strong>Строxки 18-21</strong> В этой части вы создаёте объект <tt class="docutils literal"><code>$product</code></tt> и работаете с ним,
как и с любым другим обычным PHP-объектом.</li>
<li><strong>Строчка 24</strong> Вызов <tt class="docutils literal"><code>persist($product)</code></tt> сообщает Doctrine, чтобы он &quot;управлял&quot;
объектом <tt class="docutils literal"><code>$product</code></tt>. Это <strong>не</strong> создает запрос в базу данных.</li>
<li><strong>Строка 27</strong> Когда вызывается метод <tt class="docutils literal"><code>flush()</code></tt>, Doctrine просматривает все
объекты, которыми он управляет, чтобы узнать, нужно ли их сохранять в базу данных.
В этом примере, объект <tt class="docutils literal"><code>$product</code></tt> не существует в базе данных, так что менеджер
сущностей выполняет запрос <tt class="docutils literal"><code>INSERT</code></tt>, создавая новую строку в таблице <tt class="docutils literal"><code>product</code></tt>.</li>
</ul>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">Если вызов <tt class="docutils literal"><code>flush()</code></tt> не удается, то вызывается исключение <tt class="docutils literal"><code>Doctrine\ORM\ORMException</code></tt>.
См. <a class="reference external" href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/transactions-and-concurrency.html">Транзакции и параллелизм (Concurrency)</a>.</p>
</div></div>
<p>Процесс одинаков и для создания, и для обновления объектов, рабочий процесс всегда
одинаков: Doctrine достаточно умна для того, чтобы знать, стоит ей INSERT или UPDATE
вашу сущность.</p>
</div>
</div>
<div class="section" id="id7">
<h2>Извлечение объектов из базы данных<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>Извлечение объекта обратно из БД ещё проще. Представьте, что вы хотите перейти
в <tt class="docutils literal"><code>/product/1</code></tt>, чтобы увидеть ваш новый товар:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProductController.php</span>
<span class="c1">// ...</span>

<span class="sd">/**</span>
<span class="sd"> * @Route(&quot;/product/{id}&quot;, name=&quot;product_show&quot;)</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNotFoundException</span><span class="p">(</span>
            <span class="s1">&#39;No product found for id &#39;</span><span class="o">.</span><span class="nv">$id</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s1">&#39;Check out this great product: &#39;</span><span class="o">.</span><span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">());</span>

    <span class="c1">// или отобразить шаблон</span>
    <span class="c1">// в шаблоне, отобразить всё с {{ product.name }}</span>
    <span class="c1">// вернуть $this-&gt;render(&#39;product/show.html.twig&#39;, [&#39;product&#39; =&gt; $product]);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Попробуйте!</p>
<blockquote>
<div><a class="reference external" href="http://localhost:8000/product/1">http://localhost:8000/product/1</a></div></blockquote>
<p>Когда вы запрашиваете определённый тип объекта, вы всегда используете то, что
известно, как его &quot;хранилище&quot;. Вы можете думать о хранилище, как о PHP-классе,
единственной работой которого является помогать вам исзвлекать сущности определённого
класса.</p>
<p>Когда у вас есть объект хранилища, у вас появляется множество методов помощника:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nv">$repository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="c1">// искать один Товар по его основному ключу (обычно &quot;id&quot;)</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

<span class="c1">// искать один Товар по имени</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">findOneBy</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Keyboard&#39;</span><span class="p">]);</span>
<span class="c1">// или найти по имени и цене</span>
<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">findOneBy</span><span class="p">([</span>
    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Keyboard&#39;</span><span class="p">,</span>
    <span class="s1">&#39;price&#39;</span> <span class="o">=&gt;</span> <span class="mf">19.99</span><span class="p">,</span>
<span class="p">]);</span>

<span class="c1">// искать несколько объектов Товар, соответствующих имени, упорядоченные по цене</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">findBy</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Keyboard&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;price&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ASC&#39;</span><span class="p">]</span>
<span class="p">);</span>

<span class="c1">// искат *все* объекты Товар</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">findAll</span><span class="p">();</span>
</pre></div>
</td></tr></table></div></div>
<p>Вы можете также добавлять <em>пользовательские</em> методы для более сложных запросов! Больit
об этом вы узнаете позже, в разделе <a class="reference internal" href="doctrine.html#doctrine-queries"><span>Querying for Objects: The Repository</span></a>.</p>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p>При отображении HTML страницы, панель инструментов веб-отладки внизу страницы
отобразит количество запросов, и время, за которое они были выполнены:</p>
<img alt="_images/doctrine_web_debug_toolbar.png" class="with-browser align-center" src="_images\doctrine_web_debug_toolbar.png">
<p class="last">Если количество запросов в БД слишком велико, иконка станет жёлтой, чтобы
показать, что что-то может быть не так. Нажмите на иконку, чтобы открыть
Профилировщик Symfony и увидеть, какие именно запросы были выполнены. Если
вы не видите панели инструментов веб-отладки, попробуйте запустить
<tt class="docutils literal"><code>composer require profiler</code></tt>, чтобы установить её.</p>
</div></div>
</div>
<div class="section" id="paramconverter">
<h2>Автоматическое извлечение объектов (ParamConverter)<a class="headerlink" href="#paramconverter" title="Permalink to this headline">¶</a></h2>
<p>Во многих случаях, вы можете использовать <a class="reference external" href="http://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/index.html">SensioFrameworkExtraBundle</a>, чтобы
запрос был сделан за вас автоматически! Для начала, установите пакет, если у вас
его нет:</p>
<div class="literal-block"><div class="highlight-terminal"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">$</span> composer require annotations
</pre></div>
</td></tr></table></div></div>
<p>Теперь, упростите ваш контроллер:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Controller/ProductController.php</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="c1">// ...</span>

<span class="sd">/**</span>
<span class="sd"> * @Route(&quot;/product/{id}&quot;, name=&quot;product_show&quot;)</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nx">Product</span> <span class="nv">$product</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// использовать Товар!</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Вот и всё! Пакет использует <tt class="docutils literal"><code>{id}</code></tt> из маршрута, чтобы запросить <tt class="docutils literal"><code>Product</code></tt>
по столбцу <tt class="docutils literal"><code>id</code></tt>. Если он не найден, генерируется страница 404.</p>
<p>Существует еще множество опций, которые вы можете использовать. Прочтите
больше о <a class="reference external" href="http://symfony.com/doc/current/bundles/SensioFrameworkExtraBundle/annotations/converters.html">ParamConverter</a>.</p>
</div>
<div class="section" id="id8">
<h2>Обновление объекта<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>Когда вы получили объект из Doctrine, обновить его просто:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * @Route(&quot;/product/edit/{id}&quot;)</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">updateAction</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>
    <span class="nv">$product</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNotFoundException</span><span class="p">(</span>
            <span class="s1">&#39;No product found for id &#39;</span><span class="o">.</span><span class="nv">$id</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">setName</span><span class="p">(</span><span class="s1">&#39;New product name!&#39;</span><span class="p">);</span>
    <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirectToRoute</span><span class="p">(</span><span class="s1">&#39;product_show&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getId</span><span class="p">()</span>
    <span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Обновление объекта включает в себя всего три шага:</p>
<ol class="arabic simple">
<li>получение объекта из Doctrine;</li>
<li>изменение объекта;</li>
<li>вызов <tt class="docutils literal"><code>flush()</code></tt> из менеджера сущностей.</li>
</ol>
<p>Вы <em>можете</em> вызвать <tt class="docutils literal"><code>$em-&gt;persist($product)</code></tt>, но это не нужно:
Doctrine уже &quot;наблюдает&quot; за вашим объектом на предмет изменений.</p>
</div>
<div class="section" id="id9">
<h2>Удаление объекта<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>Удаление объекта очень похоже, но требует вызова метода <tt class="docutils literal"><code>remove()</code></tt> из
менеджера сушностей:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nv">$em</span><span class="o">-&gt;</span><span class="na">remove</span><span class="p">(</span><span class="nv">$product</span><span class="p">);</span>
<span class="nv">$em</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
</pre></div>
</td></tr></table></div></div>
<p>Как вы и могли ожидать, метод <tt class="docutils literal"><code>remove()</code></tt> уведомляет Doctrine о том, что вам
хочется удалить указанный объект из базы данных. Тем не менее, запрос <tt class="docutils literal"><code>DELETE</code></tt>
не выполняется до тех пор, пока не вызван метод <tt class="docutils literal"><code>flush()</code></tt>.</p>
</div>
<div class="section" id="doctrine-queries-ru">
<span id="id10"></span><h2>Запрашивание объектов: Хранилище<a class="headerlink" href="#doctrine-queries-ru" title="Permalink to this headline">¶</a></h2>
<p>Вы уже видели, как объект-репозиторий позволяет вам выполнять базовые
запросы без каких-либо усилий:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// изнутри контроллера</span>
<span class="nv">$repository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

<span class="nv">$product</span> <span class="o">=</span> <span class="nv">$repository</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
</pre></div>
</td></tr></table></div></div>
<p>Но что, если вам нужен более сложный запрос? Когда вы сгенерировали свою сущность
с помощью <tt class="docutils literal"><code>make:entity</code></tt>, команда <em>также</em> сгенерировала класс <tt class="docutils literal"><code>ProductRepository</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/ProductRepository.php</span>
<span class="k">namespace</span> <span class="nx">App\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\Product</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bridge\Doctrine\RegistryInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProductRepository</span> <span class="k">extends</span> <span class="nx">ServiceEntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">RegistryInterface</span> <span class="nv">$registry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$registry</span><span class="p">,</span> <span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Когда вы извлекаете ваше хранилище (т.е. <tt class="docutils literal"><code>-&gt;getRepository(Product::class)</code></tt>), оно
<em>на самом деле</em> является экземпляром <em>этого</em> объекта! Это так из-за конфигурации
<tt class="docutils literal"><code>repositoryClass</code></tt>, которая была создана поверх вашего класса сушности.</p>
<p>Представьте, что вы хотите запросить все объекты Товара с ценой, больше, чем заданная.
Добавьте для этого в ваше хранилище новый метод:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/ProductRepository.php</span>

<span class="c1">// ...</span>
<span class="k">class</span> <span class="nc">ProductRepository</span> <span class="k">extends</span> <span class="nx">ServiceEntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">RegistryInterface</span> <span class="nv">$registry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$registry</span><span class="p">,</span> <span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @param $price</span>
<span class="sd">     * @return Product[]</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">findAllGreaterThanPrice</span><span class="p">(</span><span class="nv">$price</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
    <span class="p">{</span>
        <span class="c1">// автоматически знает, что надо выбрать Товары</span>
        <span class="c1">// &quot;p&quot; - это дополнительное имя, которое вы будете использовать далее в запросе</span>
        <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="s1">&#39;p.price &gt; :price&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="nv">$price</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;p.price&#39;</span><span class="p">,</span> <span class="s1">&#39;ASC&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>

        <span class="c1">// чтобы получить только один результат:</span>
        <span class="c1">// $product = $qb-&gt;setMaxResults(1)-&gt;getOneOrNullResult();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Тут используется <a class="reference external" href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/query-builder.html">Конструктор запросов</a> Doctrine: очень мощный и дружелюбный
способ написания пользовательских запросов. Теперь, вы можете вызать этот
метод в хранилише:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// изнутри контроллера</span>
<span class="nv">$minPrice</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="nv">$products</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">Product</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">findAllGreaterThanPrice</span><span class="p">(</span><span class="nv">$minPrice</span><span class="p">);</span>

<span class="c1">// ...</span>
</pre></div>
</td></tr></table></div></div>
<p>Если вы в <a class="reference internal" href="service_container.html#services-constructor-injection"><span>Injecting Services/Config into a Service</span></a>, то вы можете типизировать
класс <tt class="docutils literal"><code>ProductRepository</code></tt> и внедрить его, как обычно.</p>
<p>Чтобы узнать больше, см. документацию <a class="reference external" href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/query-builder.html">Конструктора запросов</a> от Doctrine.</p>
</div>
<div class="section" id="dql-sql">
<h2>Запрашивание объектов через DQL или SQL<a class="headerlink" href="#dql-sql" title="Permalink to this headline">¶</a></h2>
<p>В дополенение к конструктору запросов, вы также можете делать запросы с помощью
<a class="reference external" href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/dql-doctrine-query-language.html">Языка запросов Doctrine</a>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/ProductRepository.php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">findAllGreaterThanPrice</span><span class="p">(</span><span class="nv">$price</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">();</span>

    <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span>
        <span class="s1">&#39;SELECT p</span>
<span class="s1">        FROM App\Entity\Product p</span>
<span class="s1">        WHERE p.price &gt; :price</span>
<span class="s1">        ORDER BY p.price ASC&#39;</span>
    <span class="p">)</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="c1">// возвращает массив объектов Товар</span>
    <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Или напрямую с помощью SQL, если вам нужно:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// src/Repository/ProductRepository.php</span>
<span class="c1">// ...</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">findAllGreaterThanPrice</span><span class="p">(</span><span class="nv">$price</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="nv">$conn</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">();</span>

    <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">&#39;</span>
<span class="s1">        SELECT * FROM product p</span>
<span class="s1">        WHERE p.price &gt; :price</span>
<span class="s1">        ORDER BY p.price ASC</span>
<span class="s1">        &#39;</span><span class="p">;</span>
    <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">&#39;price&#39;</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">]);</span>

    <span class="c1">// возвращает массив массивов (т.е. набор чистых данных)</span>
    <span class="k">return</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>С SQL вы будете получать чистые данные, а не объекты (разве что вы используете
функционал <a class="reference external" href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/native-sql.html">NativeQuery</a>).</p>
</div>
<div class="section" id="id11">
<h2>Конфигурация<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p>См. <a class="reference internal" href="reference\configuration\doctrine.html"><em>Справочник конфигурации Doctrine</em></a>.</p>
</div>
<div class="section" id="id12">
<h2>Отношения и ассоциации<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<p>Doctrine предоставляет все необходимые вам функции, чтобы управлять отношениями
БД (также известными, как ассоциации), включая отношения ManyToOne, OneToMany,
OneToOne и ManyToMany.</p>
<p>Чтобы узнать больше, см. <a class="reference internal" href="doctrine\associations.html"><em>How to Work with Doctrine Associations / Relations</em></a>.</p>
</div>
<div class="section" id="id13">
<h2>Коррекция пустых данных<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<p>Doctrine предоставляет библиотеку, которая позваляет вам программно
загружать данные тестирования в ваш проект (т.е. &quot;данные коррекции&quot;).
Чтобы узнать больше, см. документацию &quot;<a class="reference external" href="https://symfony.com/doc/current/bundles/DoctrineFixturesBundle/index.html">DoctrineFixturesBundle</a>&quot;.</p>
</div>
<div class="section" id="id14">
<h2>Узнать больше<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="doctrine\associations.html">How to Work with Doctrine Associations / Relations</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\common_extensions.html">How to use Doctrine Extensions: Timestampable, Sluggable, Translatable, etc.</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\lifecycle_callbacks.html">How to Work with Lifecycle Callbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\event_listeners_subscribers.html">Doctrine Event Listeners and Subscribers</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\registration_form.html">How to Implement a Simple Registration Form</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\custom_dql_functions.html">How to Register custom DQL Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\dbal.html">How to Use Doctrine DBAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\multiple_entity_managers.html">How to Work with multiple Entity Managers and Connections</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\pdo_session_storage.html">How to Use PdoSessionHandler to Store Sessions in the Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\mongodb_session_storage.html">How to Use MongoDbSessionHandler to Store Sessions in a MongoDB Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\resolve_target_entity.html">How to Define Relationships with Abstract Classes and Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine\reverse_engineering.html">How to Generate Entities from an Existing Database</a></li>
</ul>
</div>
<ul class="simple">
<li><a class="reference external" href="https://symfony.com/doc/current/bundles/DoctrineFixturesBundle/index.html">DoctrineFixturesBundle</a></li>
</ul>
</div>
</div>


            </div>

            

            <div id="license">
                <p>Эта документация является переводом <a href="http://symfony.com/doc/current/index.html">официальной документации Symfony</a> и предоставляется по свободной лицензии <a rel="license nofollow" href="https://creativecommons.org/licenses/by-sa/3.0/deed.ru">CC BY-SA 3.0</a>.</p>
            </div>
        </div>
    </div>
</div></div>


  <script data-cfasync="false" src="..\..\cdn-cgi\scripts\5c5dd728\cloudflare-static\email-decode.min.js"></script></body>
</body></html>